<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SDR Weekly Performance Dashboard ‚Äî Q1 FY26</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', -apple-system, sans-serif; background: #f8fafc; color: #0f172a; }
  .dashboard { max-width: 1200px; margin: 0 auto; padding: 24px; }

  /* Header */
  .dash-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; border-bottom: 3px solid #0F4C81; padding-bottom: 16px; }
  .dash-title { font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
  .dash-h1 { font-size: 26px; font-weight: 800; color: #0F4C81; margin-top: 2px; }
  .dash-meta { text-align: right; font-size: 12px; color: #64748b; line-height: 1.6; }
  .dash-meta strong { color: #0f172a; }

  /* Sections */
  .section { margin-bottom: 28px; }
  /* Tab navigation */
  .tab-bar { display: flex; gap: 4px; margin: 0 0 18px 0; padding: 4px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; }
  .tab-btn { padding: 10px 24px; font-size: 13px; font-weight: 600; color: #64748b; background: transparent; border: 1px solid transparent; border-radius: 6px; cursor: pointer; transition: all 0.15s; }
  .tab-btn:hover { color: #0F4C81; background: #e2e8f0; }
  .tab-btn.active { color: #fff; background: #0F4C81; border-color: #0F4C81; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .section-title { font-size: 15px; font-weight: 700; color: #0F4C81; border-left: 4px solid #0F4C81; padding-left: 10px; }
  .section-sub { font-size: 11px; color: #94a3b8; }

  /* KPI cards */
  .kpi-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
  .kpi { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; position: relative; display: flex; flex-direction: column; }
  .kpi::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; border-radius: 10px 10px 0 0; }
  .kpi.green::before { background: #16a34a; } .kpi.amber::before { background: #d97706; }
  .kpi.red::before { background: #dc2626; } .kpi.blue::before { background: #0F4C81; }
  .kpi.purple::before { background: #7B2D8E; } .kpi.orange::before { background: #F18F01; }
  .kpi.grey::before { background: #94a3b8; }
  .kpi-label { font-size: 10px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  .kpi-arrow { position: absolute; top: 14px; right: 10px; display: flex; align-items: center; gap: 3px; }
  .kpi-value { font-size: 26px; font-weight: 800; margin: 4px 0 2px; }
  .kpi-target { font-size: 11px; color: #64748b; flex: 1; }
  .kpi-delta { font-size: 11px; font-weight: 600; margin-top: 6px; padding: 2px 6px; border-radius: 4px; display: inline-block; align-self: flex-start; }
  .kpi-delta.up { background: #f0fdf4; color: #16a34a; } .kpi-delta.down { background: #fef2f2; color: #dc2626; } .kpi-delta.flat { background: #f1f5f9; color: #64748b; } .kpi-delta.amber { background: #fffbeb; color: #d97706; }

  /* WoW changes */
  .wow-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .highlights-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .highlight-card { background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border-radius: 8px; padding: 14px 14px 12px; border-left: 3px solid #16a34a; position: relative; }
  .highlight-emoji { font-size: 20px; margin-bottom: 6px; }
  .highlight-name { font-size: 11px; font-weight: 700; color: #0F4C81; margin-bottom: 2px; }
  .highlight-title { font-size: 10px; font-weight: 600; color: #16a34a; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px; }
  .highlight-stat { font-size: 18px; font-weight: 800; color: #0f172a; margin-bottom: 4px; line-height: 1.1; }
  .highlight-detail { font-size: 9px; color: #64748b; line-height: 1.3; }
  .wow-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; }
  .wow-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 6px; }
  .wow-main { font-size: 22px; font-weight: 800; }
  .wow-detail { font-size: 11px; color: #64748b; margin-top: 4px; line-height: 1.5; }
  .wow-tag { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
  .wow-tag.pos { background: #f0fdf4; color: #16a34a; } .wow-tag.neg { background: #fef2f2; color: #dc2626; } .wow-tag.neu { background: #f1f5f9; color: #64748b; }

  /* BU progress */
  .bu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  .bu-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 16px; }
  .bu-name { font-size: 13px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .bu-dot { width: 10px; height: 10px; border-radius: 50%; }
  .progress-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .progress-label { font-size: 10px; font-weight: 600; color: #64748b; min-width: 55px; text-transform: uppercase; white-space: nowrap; }
  .progress-track { flex: 1 1 0; max-width: 75%; background: #f1f5f9; border-radius: 6px; height: 20px; position: relative; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; }
  .progress-fill span { font-size: 9px; font-weight: 700; color: #fff; }
  .progress-val { font-size: 11px; font-weight: 700; min-width: 105px; text-align: right; white-space: nowrap; }

  /* Regional allbound */
  .region-strip { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  .region-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px; border-top: 3px solid; }
  .region-card.dach { border-top-color: #0F4C81; } .region-card.emea { border-top-color: #F18F01; }
  .region-card.amer { border-top-color: #7B2D8E; } .region-card.apj { border-top-color: #C73E1D; }
  .trend-tag { display: inline-flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 4px; }
  .trend-tag.up { background: #f0fdf4; color: #16a34a; }
  .trend-tag.down { background: #fef2f2; color: #dc2626; }
  .trend-tag.flat { background: #f1f5f9; color: #64748b; }
  .region-name { font-size: 13px; font-weight: 700; margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between; }
  .region-stat { display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px solid #f1f5f9; }
  .region-stat:last-child { border: none; }
  .region-stat-label { color: #64748b; } .region-stat-val { font-weight: 700; }

  /* Zone summary */
  .zone-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
  .zone-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px; text-align: center; position: relative; }
  .zone-tip { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; border-radius: 50%; background: #e2e8f0; color: #64748b; font-size: 9px; font-weight: 700; cursor: help; margin-left: 4px; vertical-align: middle; position: relative; }
  .zone-tip:hover::after { content: attr(data-tip); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: #0f172a; color: #fff; font-size: 10px; font-weight: 400; padding: 6px 10px; border-radius: 6px; white-space: nowrap; z-index: 10; pointer-events: none; }
  .zone-card-label { font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; }
  .zone-card-count { font-size: 28px; font-weight: 800; }
  .zone-card-names { font-size: 10px; color: #64748b; margin-top: 6px; line-height: 1.5; }

  /* Charts */
  .chart-container { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; }
  .chart-area { width: 100%; height: 380px; position: relative; }
  canvas { width: 100%; height: 100%; }
  .chart-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  /* Filter bar */
  .filter-bar { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
  .filter-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; font-family: inherit; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s; color: #64748b; }
  .filter-btn:hover { border-color: #0F4C81; color: #0F4C81; }
  .filter-btn.active { background: #0F4C81; color: #fff; border-color: #0F4C81; }
  .filter-group-label { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; align-self: center; width: 85px; flex-shrink: 0; }
  

  /* SDR table */
  .sdr-table-wrap { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
  .sdr-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .sdr-table thead th { background: #f8fafc; padding: 8px 10px; text-align: center; font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; cursor: pointer; white-space: nowrap; user-select: none; }
  .sdr-table thead th:first-child { text-align: left; }
  .sdr-table thead th:hover { color: #0F4C81; }
  .sdr-table tbody td { padding: 7px 10px; border-bottom: 1px solid #f1f5f9; text-align: center; }
  .sdr-table tbody td:first-child { text-align: left; }
  .sdr-table tbody tr:hover { background: #f8fafc; }
  .sdr-name-cell { font-weight: 600; }
  .sdr-meta-cell { font-size: 10px; color: #94a3b8; }
  .sdr-badges { display: flex; gap: 4px; margin-top: 2px; flex-wrap: wrap; }
  .sdr-badge { font-size: 8px; font-weight: 700; padding: 1px 5px; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.3px; }
  .sdr-badge-seg { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
  .sdr-badge-ramp { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
  .sdr-badge-full { background: #f8fafc; color: #94a3b8; border: 1px solid #e2e8f0; }
  .sdr-badge-region { background: #faf5ff; color: #7c3aed; border: 1px solid #e9d5ff; }
  .rag-cell { border-radius: 4px; padding: 4px 8px; text-align: center; }
  .rag-cell-green { background: #f0fdf4; }
  .rag-cell-lime { background: #f7fee7; }
  .rag-cell-amber { background: #fffbeb; }
  .rag-cell-red { background: #fef2f2; }
  .rag-val { font-size: 13px; font-weight: 700; line-height: 1.2; }
  .rag-sub { font-size: 9px; color: #64748b; font-weight: 500; }
  .act-dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
  .eff-arrow { font-size: 10px; margin-left: 2px; }
  .tag { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; display: inline-block; }
  .tag-green { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
  .tag-lime { background: #f7fee7; color: #65a30d; border: 1px solid #d9f99d; }
  .tag-amber { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
  .tag-red { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
  .mini-bar { background: #f1f5f9; border-radius: 3px; height: 10px; width: 80px; display: inline-block; overflow: hidden; vertical-align: middle; }
  .mini-bar-fill { height: 100%; border-radius: 3px; }

  /* Analysis section */
  .analysis-box { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px 24px; margin-top: 16px; }
  .analysis-title { font-size: 14px; font-weight: 700; color: #0F4C81; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .analysis-title .icon { font-size: 16px; }
  .analysis-body { font-size: 12px; color: #334155; line-height: 1.7; }
  .analysis-body h4 { font-size: 12px; font-weight: 700; color: #0F4C81; margin: 12px 0 4px; }
  .analysis-body h4:first-child { margin-top: 0; }
  .analysis-body .callout { background: #f8fafc; border-left: 3px solid #0F4C81; padding: 8px 12px; margin: 8px 0; border-radius: 0 6px 6px 0; }
  .analysis-body .callout.warn { border-left-color: #d97706; background: #fffbeb; }
  .analysis-body .callout.good { border-left-color: #16a34a; background: #f0fdf4; }
  .analysis-body .callout.risk { border-left-color: #dc2626; background: #fef2f2; }

  /* Coaching Focus Matrix */
  .coach-grid { display: flex; flex-direction: column; gap: 8px; }
  .coach-group-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin: 12px 0 4px; padding: 4px 0; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 6px; }
  .coach-group-title:first-child { margin-top: 0; }
  .coach-card { display: grid; grid-template-columns: 160px 1fr 1fr; gap: 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; font-size: 11px; }
  .coach-card-name { padding: 10px 12px; font-weight: 700; color: #1e293b; display: flex; flex-direction: column; justify-content: center; gap: 4px; border-right: 1px solid #f1f5f9; }
  .coach-card-name .coach-zone-pill { display: inline-block; font-size: 9px; font-weight: 600; padding: 2px 8px; border-radius: 10px; width: fit-content; }
  .coach-card-signal { padding: 10px 12px; color: #475569; line-height: 1.5; border-right: 1px solid #f1f5f9; }
  .coach-card-signal strong { color: #1e293b; }
  .coach-card-probe { padding: 10px 12px; color: #334155; line-height: 1.5; font-style: italic; background: #fafbfc; }
  .coach-card-probe .probe-label, .coach-card-signal .probe-label { font-style: normal; font-weight: 600; font-size: 9px; text-transform: uppercase; color: #0F4C81; margin-bottom: 3px; }

  .dash-footer { margin-top: 24px; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 10px; color: #94a3b8; display: flex; justify-content: space-between; }

  @media print { body { background: #fff; } .filter-bar { display: none; } .dashboard { padding: 12px; } }
  @media (max-width: 768px) { .kpi-row, .wow-grid, .highlights-grid { grid-template-columns: repeat(2, 1fr); } .bu-grid, .chart-pair { grid-template-columns: 1fr; } .region-strip { grid-template-columns: 1fr 1fr; } .zone-row { grid-template-columns: repeat(3, 1fr); } }
</style>
</head>
<body>
<div class="dashboard">

  <!-- HEADER -->
  <div class="dash-header">
    <div>
      <div class="dash-title">Sales Development Organisation</div>
      <div class="dash-h1">Weekly Performance Dashboard</div>
    </div>
    <div class="dash-meta">
      <div id="metaWeekLabel"></div>
      <div id="metaWeeksElapsed"></div>
      <div>Week cycle: Friday to Thursday</div>
      <div>Individual targets from FY26 comp plan</div>
    </div>
  </div>

  <!-- TAB NAVIGATION -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="summary">Summary</button>
    <button class="tab-btn" data-tab="trends">Trends</button>
    <button class="tab-btn" data-tab="individual">Individual Performance</button>
    <button class="tab-btn" data-tab="distributions">Distributions</button>
    <button class="tab-btn" data-tab="historical">Historical Performance</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê SUMMARY TAB ‚ïê‚ïê‚ïê -->
  <div class="tab-content active" id="tab-summary">

  <!-- 1. GLOBAL KPIs -->
  <div class="section">
    <div class="section-head"><div class="section-title">Global Headlines</div><div class="section-sub">All business units combined</div></div>
    <div class="kpi-row" id="globalKpis"></div>
  </div>

  <!-- 2. WEEK-ON-WEEK CHANGES -->
  <div class="section">
    <div class="section-head"><div class="section-title">Week-on-Week Changes</div><div class="section-sub" id="wowSub"></div></div>
    <div class="wow-grid" id="wowGrid"></div>
  </div>

  <!-- 2b. WEEK HIGHLIGHTS -->
  <div class="section">
    <div class="section-head"><div class="section-title" id="highlightsTitle"></div><div class="section-sub">Celebrating progress and momentum</div></div>
    <div class="highlights-grid" id="highlightsGrid"></div>
  </div>

  <!-- 2c. MANAGEMENT FOCUS -->
  <div class="section">
    <div class="section-head"><div class="section-title">Management Focus</div><div class="section-sub">Priority coaching area per manager this week, driven by team data</div></div>
    <div id="mgrFocusGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;align-items:stretch"></div>
  </div>

  <!-- 3. BU PIPELINE & SAO PROGRESS -->
  <div class="section">
    <div class="section-head"><div class="section-title">Pipeline &amp; SAO Progress by Business Unit</div><div class="section-sub">Cumulative vs individual pro-rated targets</div></div>
    <div class="bu-grid" id="buGrid"></div>
  </div>

  <!-- 4. REGIONAL ALLBOUND -->
  <div class="section">
    <div class="section-head"><div class="section-title">Regional Allbound Summary</div><div class="section-sub">OB + IB combined by geography</div></div>
    <div class="region-strip" id="regionStrip"></div>
  </div>

  <!-- 5. ZONE SUMMARY -->
  <div class="section">
    <div class="section-head"><div class="section-title">Performance Zone Summary</div><div class="section-sub">Outcome-led statuses ¬∑ what coaching action is needed?</div></div>
    <div class="zone-row" id="zoneRow"></div>
  </div>

  </div><!-- /tab-summary -->

  <!-- ‚ïê‚ïê‚ïê INDIVIDUAL PERFORMANCE TAB ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-individual">

  <!-- FILTERS -->
  <div class="section" style="padding-bottom:0">
    <div id="filterBar">
      <div class="filter-bar">
        <span class="filter-group-label">SCOPE</span>
        <button class="filter-btn active" data-bu="ALL" style="min-width:120px">Global</button>
      </div>
      <div class="filter-bar" style="margin-top:-10px">
        <span class="filter-group-label">Business Unit</span>
        <button class="filter-btn" data-bu="DACH_ENT_OB">DACH ENT</button>
        <button class="filter-btn" data-bu="DACH_CORP_OB">DACH CORP</button>
        <button class="filter-btn" data-bu="EMEA_OB">EMEA OB</button>
        <button class="filter-btn" data-bu="AMER_OB">AMER OB</button>
        <button class="filter-btn" data-bu="APJ_OB">APJ OB</button>
        <button class="filter-btn" data-bu="INBOUND">Inbound</button>
      </div>
      <div class="filter-bar" style="margin-top:-10px">
        <span class="filter-group-label">Region</span>
        <button class="filter-btn" data-region="DACH">DACH</button>
        <button class="filter-btn" data-region="EMEA">EMEA</button>
        <button class="filter-btn" data-region="AMER">AMER</button>
        <button class="filter-btn" data-region="APJ">APJ</button>
      </div>
      <div class="filter-bar" style="margin-top:-10px">
        <span class="filter-group-label">SDR</span>
        <select id="indivSDRSelect" style="font-family:'DM Sans',sans-serif;font-size:12px;padding:5px 28px 5px 10px;border:1px solid #e2e8f0;border-radius:6px;color:#334155;background:#fff;min-width:320px;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2394a3b8%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>');background-repeat:no-repeat;background-position:right 10px center">
          <option value="">Select Business Unit or Region first</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Sub-tabs: Summary / Analysis / Coaching -->
  <div class="section" style="padding-top:4px;padding-bottom:0">
    <div id="indivSubTabs" style="display:flex;gap:0;border-bottom:2px solid #e2e8f0">
      <button class="indiv-sub-tab active" data-isub="summary" style="padding:10px 28px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;color:#0F4C81;background:none;border:none;border-bottom:2px solid #0F4C81;margin-bottom:-2px;cursor:pointer">Summary</button>
      <button class="indiv-sub-tab" data-isub="analysis" style="padding:10px 28px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">Analysis</button>
      <button class="indiv-sub-tab" data-isub="coaching" style="padding:10px 28px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">Coaching</button>
      <button class="indiv-sub-tab" data-isub="activity-alert" style="padding:10px 28px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">Activity Alert</button>
    </div>
  </div>

  <!-- Summary sub-tab: SDR table -->
  <div id="indivSubSummary">
    <div class="section">
      <div style="font-size:11px;color:#94a3b8;font-weight:600;margin-bottom:8px" id="sdrCount"></div>
      <div class="sdr-table-wrap">
        <table class="sdr-table" id="sdrTable">
          <thead><tr id="sdrHead"></tr></thead>
          <tbody id="sdrBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Analysis sub-tab -->
  <div id="indivSubAnalysis" style="display:none">
    <div class="section">
      <div class="analysis-box" id="analysisBox"></div>
    </div>
  </div>

  <!-- Coaching sub-tab -->
  <div id="indivSubCoaching" style="display:none">
    <div class="section">
      <div style="font-size:11px;color:#94a3b8;font-weight:600;margin-bottom:8px" id="coachingSub">Personalised development focus ¬∑ updates weekly based on data, activity trends, and quarter phase</div>
      <div id="coachingMatrix"></div>
    </div>
  </div>

  <!-- Activity Alert sub-tab -->
  <div id="indivSubActivityAlert" style="display:none">
    <div class="section">
      <div id="activityAlertBox"></div>
    </div>
  </div>

  </div><!-- /tab-individual -->

  <!-- ‚ïê‚ïê‚ïê DISTRIBUTIONS TAB ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-distributions">

  <div class="section" style="padding-bottom:0">
    <div id="distFilterBar">
      <div class="filter-bar">
        <span class="filter-group-label">SCOPE</span>
        <button class="filter-btn active" data-dbu="ALL" style="min-width:120px">Global</button>
      </div>
      <div class="filter-bar" style="margin-top:-10px">
        <span class="filter-group-label">Business Unit</span>
        <button class="filter-btn" data-dbu="DACH_ENT_OB">DACH ENT</button>
        <button class="filter-btn" data-dbu="DACH_CORP_OB">DACH CORP</button>
        <button class="filter-btn" data-dbu="EMEA_OB">EMEA OB</button>
        <button class="filter-btn" data-dbu="AMER_OB">AMER OB</button>
        <button class="filter-btn" data-dbu="APJ_OB">APJ OB</button>
        <button class="filter-btn" data-dbu="INBOUND">Inbound</button>
      </div>
      <div class="filter-bar" style="margin-top:-10px">
        <span class="filter-group-label">Region</span>
        <button class="filter-btn" data-dregion="DACH">DACH</button>
        <button class="filter-btn" data-dregion="EMEA">EMEA</button>
        <button class="filter-btn" data-dregion="AMER">AMER</button>
        <button class="filter-btn" data-dregion="APJ">APJ</button>
      </div>
    </div>
  </div>

  <!-- Sub-tabs: Activity / SAO / Pipeline -->
  <div class="section" style="padding-top:4px;padding-bottom:0">
    <div id="distSubTabs" style="display:flex;gap:0;border-bottom:2px solid #e2e8f0">
      <button class="dist-sub-tab active" data-dsub="activity" style="padding:10px 28px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;color:#0F4C81;background:none;border:none;border-bottom:2px solid #0F4C81;margin-bottom:-2px;cursor:pointer">Activity</button>
      <button class="dist-sub-tab" data-dsub="sao" style="padding:10px 28px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">SAO</button>
      <button class="dist-sub-tab" data-dsub="pipeline" style="padding:10px 28px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">Pipeline</button>
    </div>
  </div>

  <!-- Activity sub-tab -->
  <div id="distSubActivity">
    <div class="section">
      <div class="chart-container">
        <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:8px">Weekly Activity Distribution</div>
        <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Below 350 = Action ¬∑ 350‚Äì500 = Building ¬∑ Above 500 = Target pace</div>
        <div class="chart-area" style="height:700px"><canvas id="bellChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- SAO sub-tab -->
  <div id="distSubSao" style="display:none">
    <div class="section">
      <div class="chart-container">
        <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:8px">SAO Attainment Distribution (% of Individual Target)</div>
        <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Below 50% = Action ¬∑ 50‚Äì75% = Building ¬∑ Above 75% = On-track</div>
        <div class="chart-area" style="height:700px"><canvas id="saoChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Pipeline sub-tab -->
  <div id="distSubPipeline" style="display:none">
    <div class="section">
      <div class="chart-container">
        <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:8px">Pipeline Attainment Distribution (% of Individual Target)</div>
        <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Below 50% = Action ¬∑ 50‚Äì90% = Building ¬∑ Above 90% = On-track</div>
        <div class="chart-area" style="height:700px"><canvas id="pipeChart"></canvas></div>
      </div>
    </div>
  </div>

  </div><!-- /tab-distributions -->

  <!-- ‚ïê‚ïê‚ïê TRENDS TAB ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-trends">

    <div class="section" style="padding-bottom:0">
      <div id="trendFilterBar">
        <div class="filter-bar">
          <span class="filter-group-label">SCOPE</span>
          <button class="filter-btn active" data-tf="GLOBAL" style="min-width:120px">Global</button>
        </div>
        <div class="filter-bar" style="margin-top:-10px">
          <span class="filter-group-label">Business Unit</span>
          <button class="filter-btn" data-tf="DACH_ENT_OB">DACH ENT</button>
          <button class="filter-btn" data-tf="DACH_CORP_OB">DACH CORP</button>
          <button class="filter-btn" data-tf="EMEA_OB">EMEA OB</button>
          <button class="filter-btn" data-tf="AMER_OB">AMER OB</button>
          <button class="filter-btn" data-tf="APJ_OB">APJ OB</button>
          <button class="filter-btn" data-tf="INBOUND">Inbound</button>
        </div>
        <div class="filter-bar" style="margin-top:-10px">
          <span class="filter-group-label">Region</span>
          <button class="filter-btn" data-tf="R_DACH">DACH</button>
          <button class="filter-btn" data-tf="R_EMEA">EMEA</button>
          <button class="filter-btn" data-tf="R_AMER">AMER</button>
          <button class="filter-btn" data-tf="R_APJ">APJ</button>
        </div>
        <div class="filter-bar" style="margin-top:-10px">
          <span class="filter-group-label">SDR</span>
          <select id="trendSDRSelect" style="font-family:'DM Sans',sans-serif;font-size:12px;padding:5px 28px 5px 10px;border:1px solid #e2e8f0;border-radius:6px;color:#334155;background:#fff;min-width:320px;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2394a3b8%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>');background-repeat:no-repeat;background-position:right 10px center">
            <option value="">Select Business Unit or Region first</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Sub-tabs: Projections and Weekly views -->
    <div class="section" style="padding-top:4px;padding-bottom:0">
      <div id="trendSubTabs" style="display:flex;gap:0;border-bottom:2px solid #e2e8f0;flex-wrap:wrap">
        <button class="trend-sub-tab active" data-tsub="pipe" style="padding:10px 20px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;color:#0F4C81;background:none;border:none;border-bottom:2px solid #0F4C81;margin-bottom:-2px;cursor:pointer">Pipeline Projection</button>
        <button class="trend-sub-tab" data-tsub="sao" style="padding:10px 20px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">SAO Projection</button>
        <button class="trend-sub-tab" data-tsub="pipeWeekly" style="padding:10px 20px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">Pipeline Weekly</button>
        <button class="trend-sub-tab" data-tsub="saoWeekly" style="padding:10px 20px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">SAO Weekly</button>
        <button class="trend-sub-tab" data-tsub="actWeekly" style="padding:10px 20px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;color:#94a3b8;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">Activity Weekly</button>
      </div>
    </div>

    <!-- Pipeline sub-tab content -->
    <div id="trendSubPipe">
      <div class="section" style="margin-top:-6px"><div id="trendPipeCallout"></div></div>
      <div class="section">
        <div class="chart-container">
          <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:4px" id="trendPipeTitle">Pipeline Trend ‚Äî Global</div>
          <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Pace projection driven by recent SAO volume √ó avg deal size ¬∑ Range reflects deal-size variance ¬∑ Amber line = if underperformers lifted to 500 acts/wk</div>
          <div class="chart-area" style="height:672px"><canvas id="trendPipeCanvas"></canvas></div>
        </div>
      </div>
    </div>

    <!-- SAO sub-tab content -->
    <div id="trendSubSao" style="display:none">
      <div class="section" style="margin-top:-6px"><div id="trendSaoCallout"></div></div>
      <div class="section">
        <div class="chart-container">
          <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:4px" id="trendSaoTitle">SAO Trend ‚Äî Global</div>
          <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Pace projection driven by recent activity volume √ó conversion rate ¬∑ Range reflects conversion variance ¬∑ Amber line = if underperformers lifted to 500 acts/wk</div>
          <div class="chart-area" style="height:672px"><canvas id="trendSaoCanvas"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Pipeline Weekly sub-tab -->
    <div id="trendSubPipeWeekly" style="display:none">
      <div class="section">
        <div class="chart-container">
          <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:4px" id="weeklyPipeTitle">Pipeline Weekly ‚Äî Global</div>
          <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Single-week pipeline contribution stacked by team</div>
          <div class="chart-area" style="height:550px"><canvas id="weeklyPipeCanvas"></canvas></div>
          <div id="weeklyPipeLegend" style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- SAO Weekly sub-tab -->
    <div id="trendSubSaoWeekly" style="display:none">
      <div class="section">
        <div class="chart-container">
          <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:4px" id="weeklySaoTitle">SAO Weekly ‚Äî Global</div>
          <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Single-week SAO count stacked by team</div>
          <div class="chart-area" style="height:550px"><canvas id="weeklySaoCanvas"></canvas></div>
          <div id="weeklySaoLegend" style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- Activity Weekly sub-tab -->
    <div id="trendSubActWeekly" style="display:none">
      <div class="section">
        <div class="chart-container">
          <div style="font-size:12px;font-weight:700;color:#0F4C81;margin-bottom:4px" id="weeklyActTitle">Activity Weekly ‚Äî Global</div>
          <div style="font-size:10px;color:#94a3b8;margin-bottom:12px">Single-week activity total stacked by team</div>
          <div class="chart-area" style="height:550px"><canvas id="weeklyActCanvas"></canvas></div>
          <div id="weeklyActLegend" style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:10px"></div>
        </div>
      </div>
    </div>

  </div><!-- /tab-trends -->

  <!-- ‚ïê‚ïê‚ïê HISTORICAL PERFORMANCE TAB ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-historical">
    <div class="section">
      <div class="section-head"><div class="section-title">Historical Performance</div><div class="section-sub">FY25 benchmarks and prior quarter results</div></div>
      <div style="padding:40px 0;text-align:center;color:#94a3b8;font-size:13px">FY25 benchmark data and quarterly comparisons will appear here.</div>
    </div>
  </div><!-- /tab-historical -->

  <div class="dash-footer">
    <div id="footerDataLine"></div>
    <div>SDRs who have just started and have not commenced activity are excluded</div>
  </div>
</div>

<script>
// ============================================================
// CORE DATA
// ============================================================
const WEEK = { ending: '2026-02-19', number: 7, weeksElapsed: 7, totalWeeks: 13, weeksRemaining: 6 };

const BU_META = {
  DACH_ENT_OB: { label: 'DACH Enterprise Outbound', color: '#0F4C81', managers: ['David Perl'], mgrShort: 'David Perl', hcTarget: 6 },
  DACH_CORP_OB:{ label: 'DACH Corporate Outbound', color: '#2563eb', managers: ['Patricia Chemnitzer'], mgrShort: 'Patricia Chemnitzer', hcTarget: 5 },
  EMEA_OB:  { label: 'EMEA Outbound', color: '#F18F01', managers: ['Julien Thuy'], mgrShort: 'Julien Thuy', hcTarget: 7 },
  AMER_OB:  { label: 'AMER Outbound', color: '#7B2D8E', managers: ['Woojin Shin'], mgrShort: 'Woojin Shin', hcTarget: 7 },
  APJ_OB:   { label: 'APJ Outbound', color: '#C73E1D', managers: ['Rio Uchida'], mgrShort: 'Rio Uchida', hcTarget: 8 },
  INBOUND:  { label: 'Inbound', color: '#64748b', managers: ['Danielle Carroll (from Feb)', 'Andy Malliff (interim)'], mgrShort: 'Danielle Carroll', hcTarget: 10 },
};

// SDR monthly pipeline targets from FY26 Individual Target Summary
// pipeTarget (pro-rated) and pipeQ1 (full quarter) are auto-calculated from WEEK.ending
const MONTHLY_PIPE_TARGETS = {
  'Malvina Muraccioli': { jan:100000, feb:130000, mar:150000 },
  'Loic Hermabessiere': { jan:100000, feb:130000, mar:150000 },
  'Marva Hakimi':       { jan:50000,  feb:97000,  mar:150000 },
  'Casey Arra':         { jan:38000,  feb:73000,  mar:112000 },
  'Matthew Salisbury':  { jan:75000,  feb:130000, mar:150000 },
  'Johannes Hounsgaard':{ jan:130000, feb:168000, mar:194000 },
  'Lucas Durst':        { jan:130000, feb:168000, mar:194000 },
  'Burak Ayten':        { jan:130000, feb:168000, mar:194000 },
  'Julian Spretz':      { jan:130000, feb:168000, mar:194000 },
  'Armin Oesterwind':   { jan:130000, feb:168000, mar:194000 },
  'Julia Laura Damrath':{ jan:0,      feb:84000,  mar:146000 },
  'Fabio Ferrauti':     { jan:100000, feb:130000, mar:150000 },
  'Philip Croes':       { jan:100000, feb:130000, mar:150000 },
  'Giulio Sudano':      { jan:50000,  feb:97000,  mar:150000 },
  'Salma Geaissa':      { jan:0,      feb:65000,  mar:112000 },
  'Andrew Moher':       { jan:99466,  feb:143967, mar:182889 },
  'Tyler Escamilla':    { jan:114466, feb:162967, mar:204889 },
  'Richard Lam':        { jan:99466,  feb:143967, mar:182889 },
  'Gracie Haskell':     { jan:57233,  feb:122725, mar:204889 },
  'Ryuya Tanida':       { jan:136274, feb:176657, mar:203911 },
  'Chisako Nukui':      { jan:161274, feb:209657, mar:241911 },
  'Kai Nakamichi':      { jan:161274, feb:209657, mar:241911 },
  'Kaho Mizumachi':     { jan:136274, feb:176657, mar:203911 },
  'Sho Nakazawa':       { jan:161274, feb:209657, mar:241911 },
  'Kelly Sito':         { jan:0,      feb:0,      mar:0 },
  'Lucas Schmalzl':     { jan:187000, feb:243000, mar:280000 },
  'Oisin Flynn':        { jan:204000, feb:265000, mar:306000 },
  'Ying Hong':          { jan:125000, feb:243000, mar:373000 },
  // Pre-loaded ‚Äî will join SDRS when they appear in activity data
  'Claire Gilpatrick':  { jan:0,      feb:0,      mar:34000 },
  'Mayuko Ogisu':       { jan:0,      feb:0,      mar:0 },
};

// SDR monthly SAO targets from FY26 SAO Target Summary
// saoT (pro-rated) and saoQ1 (full quarter) are auto-calculated from WEEK.ending
// SAO targets pro-rate to end of business week (day+2 from Wednesday cut)
const MONTHLY_SAO_TARGETS = {
  'Malvina Muraccioli': { jan:8,  feb:10, mar:12 },
  'Loic Hermabessiere': { jan:6,  feb:8,  mar:9 },
  'Marva Hakimi':       { jan:4,  feb:6,  mar:9 },
  'Casey Arra':         { jan:3,  feb:6,  mar:9 },
  'Matthew Salisbury':  { jan:4,  feb:8,  mar:9 },
  'Johannes Hounsgaard':{ jan:6,  feb:8,  mar:9 },
  'Lucas Durst':        { jan:6,  feb:8,  mar:9 },
  'Burak Ayten':        { jan:6,  feb:8,  mar:9 },
  'Julian Spretz':      { jan:6,  feb:8,  mar:9 },
  'Armin Oesterwind':   { jan:6,  feb:8,  mar:9 },
  'Julia Laura Damrath':{ jan:0,  feb:4,  mar:7 },
  'Fabio Ferrauti':     { jan:7,  feb:9,  mar:10 },
  'Philip Croes':       { jan:7,  feb:9,  mar:10 },
  'Giulio Sudano':      { jan:3,  feb:6,  mar:10 },
  'Salma Geaissa':      { jan:0,  feb:4,  mar:7 },
  'Andrew Moher':       { jan:9,  feb:13, mar:17 },
  'Tyler Escamilla':    { jan:10, feb:15, mar:18 },
  'Richard Lam':        { jan:9,  feb:13, mar:17 },
  'Gracie Haskell':     { jan:5,  feb:11, mar:18 },
  'Ryuya Tanida':       { jan:11, feb:15, mar:17 },
  'Chisako Nukui':      { jan:13, feb:17, mar:20 },
  'Kai Nakamichi':      { jan:13, feb:17, mar:20 },
  'Kaho Mizumachi':     { jan:11, feb:15, mar:17 },
  'Sho Nakazawa':       { jan:13, feb:17, mar:20 },
  'Kelly Sito':         { jan:0,  feb:0,  mar:0 },
  'Lucas Schmalzl':     { jan:11, feb:14, mar:17 },
  'Oisin Flynn':        { jan:13, feb:16, mar:19 },
  'Ying Hong':          { jan:7,  feb:14, mar:21 },
  // Pre-loaded ‚Äî will join SDRS when they appear in activity data
  'Claire Gilpatrick':  { jan:0,  feb:0,  mar:4 },
  'Mayuko Ogisu':       { jan:0,  feb:0,  mar:0 },
};

// ============================================================
// SDR ROSTER ‚Äî metadata for all known/planned SDRs
// When a new name appears in the activity report, add them to
// SDRS below (one line: name + acts + saos + pipe). Targets and
// metadata auto-populate from the roster and monthly tables.
// ============================================================
const SDR_ROSTER = {
  // EMEA OB ‚Äî Julien Thuy
  'Malvina Muraccioli': { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'CORP' },
  'Loic Hermabessiere': { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'ENT' },
  'Marva Hakimi':       { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'ENT' },
  'Casey Arra':         { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'CORP' },
  'Matthew Salisbury':  { bu:'EMEA_OB', region:'EMEA', mgr:'Julien', seg:'ENT' },
  // DACH ENT OB ‚Äî David Perl
  'Johannes Hounsgaard':{ bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Lucas Durst':        { bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Burak Ayten':        { bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Julian Spretz':      { bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Armin Oesterwind':   { bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  'Julia Laura Damrath':{ bu:'DACH_ENT_OB', region:'DACH', mgr:'David Perl', seg:'ENT' },
  // DACH CORP OB ‚Äî Patricia Chemnitzer
  'Fabio Ferrauti':     { bu:'DACH_CORP_OB', region:'DACH', mgr:'Patricia', seg:'CORP' },
  'Philip Croes':       { bu:'DACH_CORP_OB', region:'DACH', mgr:'Patricia', seg:'CORP' },
  'Giulio Sudano':      { bu:'DACH_CORP_OB', region:'DACH', mgr:'Patricia', seg:'CORP' },
  'Salma Geaissa':      { bu:'DACH_CORP_OB', region:'DACH', mgr:'Patricia', seg:'CORP' },
  // AMER OB ‚Äî Woojin Shin
  'Andrew Moher':       { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'CORP' },
  'Tyler Escamilla':    { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'ENT' },
  'Richard Lam':        { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'CORP' },
  'Gracie Haskell':     { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'ENT' },
  'Claire Gilpatrick':  { bu:'AMER_OB', region:'AMER', mgr:'Woojin', seg:'CORP' },
  // APJ OB ‚Äî Rio Uchida
  'Ryuya Tanida':       { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'CORP' },
  'Chisako Nukui':      { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'ENT' },
  'Kai Nakamichi':      { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'ENT' },
  'Kaho Mizumachi':     { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'CORP' },
  'Sho Nakazawa':       { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'ENT' },
  'Kelly Sito':         { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'ENT' },
  'Mayuko Ogisu':       { bu:'APJ_OB', region:'APJ', mgr:'Rio', seg:'CORP' },
  // INBOUND ‚Äî Andy / Danielle
  'Lucas Schmalzl':     { bu:'INBOUND', region:'DACH', mgr:'Andy', seg:'All' },
  'Oisin Flynn':        { bu:'INBOUND', region:'EMEA', mgr:'Andy', seg:'All' },
  'Ying Hong':          { bu:'INBOUND', region:'DACH', mgr:'Andy', seg:'All' },
};

// ============================================================
// ACTIVE SDRs ‚Äî only name + actuals. Add a line when someone
// first appears in the Salesloft activity report.
// Metadata (bu, region, mgr, seg) is merged from SDR_ROSTER.
// Targets (pipeTarget, pipeQ1, saoT, saoQ1) auto-calculate
// from MONTHLY_PIPE_TARGETS and MONTHLY_SAO_TARGETS.
// ============================================================
const SDRS = [
  // EMEA OB
  { name:'Malvina Muraccioli', acts:18600, saos:36, pipe:461000 },
  { name:'Loic Hermabessiere', acts:3200,  saos:13, pipe:308000 },
  { name:'Marva Hakimi',       acts:8000,  saos:10, pipe:264000 },
  { name:'Casey Arra',         acts:3044,  saos:5,  pipe:46000 },
  { name:'Matthew Salisbury',  acts:1000,  saos:1,  pipe:76000 },
  // DACH ENT OB
  { name:'Johannes Hounsgaard',acts:1411,  saos:13, pipe:230000 },
  { name:'Lucas Durst',        acts:2019,  saos:13, pipe:329000 },
  { name:'Burak Ayten',        acts:3155,  saos:5,  pipe:579000 },
  { name:'Julian Spretz',      acts:1850,  saos:5,  pipe:64000 },
  { name:'Armin Oesterwind',   acts:878,   saos:1,  pipe:17000 },
  { name:'Julia Laura Damrath',acts:346,   saos:3,  pipe:34000 },
  // DACH CORP OB
  { name:'Fabio Ferrauti',     acts:1088,  saos:6,  pipe:91000 },
  { name:'Philip Croes',       acts:617,   saos:6,  pipe:151000 },
  { name:'Giulio Sudano',      acts:632,   saos:2,  pipe:51000 },
  { name:'Salma Geaissa',      acts:327,   saos:1,  pipe:3800 },
  // AMER OB
  { name:'Andrew Moher',       acts:2337,  saos:16, pipe:90000 },
  { name:'Tyler Escamilla',    acts:1665,  saos:13, pipe:380000 },
  { name:'Richard Lam',        acts:2378,  saos:14, pipe:62000 },
  { name:'Gracie Haskell',     acts:4910,  saos:5,  pipe:37000 },
  // APJ OB
  { name:'Ryuya Tanida',       acts:7600,  saos:44, pipe:553000 },
  { name:'Chisako Nukui',      acts:7883,  saos:26, pipe:352000 },
  { name:'Kai Nakamichi',      acts:4986,  saos:22, pipe:360000 },
  { name:'Kaho Mizumachi',     acts:3600,  saos:12, pipe:50000 },
  { name:'Sho Nakazawa',       acts:1849,  saos:17, pipe:138000 },
  { name:'Kelly Sito',         acts:912,   saos:1,  pipe:2500 },
  // INBOUND
  { name:'Lucas Schmalzl',     acts:3478,  saos:38, pipe:300000 },
  { name:'Oisin Flynn',        acts:12300, saos:11, pipe:145000 },
  { name:'Ying Hong',          acts:3276,  saos:8,  pipe:63000 },
];

// Merge roster metadata into each SDR
SDRS.forEach(s => {
  const r = SDR_ROSTER[s.name];
  if (r) { s.bu = r.bu; s.region = r.region; s.mgr = r.mgr; s.seg = r.seg; }
});

// Pipeline from departed/promoted SDRs ‚Äî counts toward BU totals but not individual performance

// Week 7 (ending 19 Feb) activity per SDR ‚Äî from Salesloft report 20-Feb-2026
const LAST_WEEK_ACTS = {
  'Andrew Moher': 537, 'Armin Oesterwind': 4, 'Burak Ayten': 655,
  'Casey Arra': 744, 'Chisako Nukui': 883, 'Fabio Ferrauti': 352,
  'Giulio Sudano': 156, 'Gracie Haskell': 910, 'Johannes Hounsgaard': 11,
  'Julia Laura Damrath': 287, 'Julian Spretz': 856, 'Kaho Mizumachi': 1500,
  'Kai Nakamichi': 486, 'Kelly Sito': 543, 'Loic Hermabessiere': 1100, 'Lucas Durst': 619,
  'Lucas Schmalzl': 78, 'Malvina Muraccioli': 3600, 'Marva Hakimi': 1600,
  'Matthew Salisbury': 0, 'Oisin Flynn': 2800, 'Philip Croes': 60,
  'Richard Lam': 878, 'Ryuya Tanida': 1500, 'Salma Geaissa': 185,
  'Sho Nakazawa': 649, 'Tyler Escamilla': 365, 'Ying Hong': 76,
};

// Previous week data for WoW (Week 6 ending 12 Feb)
const PREV_WEEK = {
  totalPipe: 4183495,
  totalSAOs: 286,
  totalActs: 81907,
  activeSDRs: 28,
  onTrack: 11,
  zoneActivity: 3,
  zoneConversion: 4,
  zoneDealSize: 0,
  zoneOnTrack: 7,
  zoneExceeding: 4,
  zoneRamping: 8,
};

// Previous week (W5) per-BU pipeline & SAO totals for trend arrows
const PREV_BU = {
  EMEA_OB:      { pipe: 993695,  saos: 59 },
  DACH_ENT_OB:  { pipe: 594000,  saos: 33 },
  DACH_CORP_OB: { pipe: 182000,  saos: 11 },
  AMER_OB:      { pipe: 972800,  saos: 45 },
  APJ_OB:       { pipe: 1043000, saos: 94 },
  INBOUND:      { pipe: 398000,  saos: 44 },
};

// Previous week (W4) per-region pipeline & SAO totals ‚Äî now computed dynamically in renderRegions() from WEEK_HISTORY

// Weeks-in-zone tracking: how many consecutive weeks each SDR has been in their current zone
// Update weekly: if zone unchanged, increment; if zone changed, reset to 1
// W5 zones recomputed from W5 pro-rated targets and cumulative data
const PREV_ZONES = {
  'Malvina Muraccioli': { zone: 'exceeding', weeks: 2 },
  'Loic Hermabessiere': { zone: 'on_track', weeks: 1 },
  'Marva Hakimi': { zone: 'on_track', weeks: 1 },
  'Casey Arra': { zone: 'ramping', weeks: 2 },
  'Matthew Salisbury': { zone: 'ramping', weeks: 2 },
  'Johannes Hounsgaard': { zone: 'exceeding', weeks: 2 },
  'Lucas Durst': { zone: 'on_track', weeks: 1 },
  'Burak Ayten': { zone: 'conversion', weeks: 2 },
  'Julian Spretz': { zone: 'activity', weeks: 2 },
  'Armin Oesterwind': { zone: 'activity', weeks: 2 },
  'Julia Laura Damrath': { zone: 'ramping', weeks: 2 },
  'Fabio Ferrauti': { zone: 'on_track', weeks: 2 },
  'Philip Croes': { zone: 'on_track', weeks: 1 },
  'Giulio Sudano': { zone: 'ramping', weeks: 2 },
  'Salma Geaissa': { zone: 'ramping', weeks: 2 },
  'Andrew Moher': { zone: 'on_track', weeks: 2 },
  'Tyler Escamilla': { zone: 'exceeding', weeks: 1 },
  'Richard Lam': { zone: 'conversion', weeks: 2 },
  'Gracie Haskell': { zone: 'ramping', weeks: 2 },
  'Ryuya Tanida': { zone: 'exceeding', weeks: 2 },
  'Chisako Nukui': { zone: 'on_track', weeks: 2 },
  'Kai Nakamichi': { zone: 'on_track', weeks: 2 },
  'Kaho Mizumachi': { zone: 'conversion', weeks: 2 },
  'Sho Nakazawa': { zone: 'on_track', weeks: 2 },
  'Kelly Sito': { zone: 'ramping', weeks: 1 },
  'Lucas Schmalzl': { zone: 'on_track', weeks: 2 },
  'Oisin Flynn': { zone: 'conversion', weeks: 2 },
  'Ying Hong': { zone: 'ramping', weeks: 2 },
};

// ============================================================
// WEEK HIGHLIGHTS ‚Äî update each week with top 5 celebrations
// emoji: card icon ¬∑ name: person or team ¬∑ title: short label
// stat: big number/metric ¬∑ detail: context sentence
// ============================================================
const HIGHLIGHTS = [
  { emoji:'üí•', name:'Burak A.', title:'Half-Million Week', stat:'+‚Ç¨500k pipeline', detail:'‚Ç¨579k cumulative ‚Äî one deal transformed DACH Enterprise in a single week.' },
  { emoji:'üî•', name:'Ryuya T.', title:'14 SAOs in One Week', stat:'44 cumulative SAOs', detail:'Global #1 SAO producer. ‚Ç¨553k pipeline. APJ\'s undisputed engine.' },
  { emoji:'üöÄ', name:'Loic H.', title:'Breakout Week', stat:'+‚Ç¨129k pipeline', detail:'‚Ç¨308k cumulative. Biggest single-week add of his tenure ‚Äî EMEA OB momentum.' },
  { emoji:'üèÜ', name:'Kai N.', title:'Consistent Growth', stat:'+‚Ç¨150k & 5 SAOs', detail:'‚Ç¨360k cumulative pipeline, 22 SAOs. Quietly building an outstanding quarter.' },
  { emoji:'üìà', name:'Lucas S.', title:'SAO Machine', stat:'38 cumulative SAOs', detail:'+6 this week. Global #1 cumulative SAOs with ‚Ç¨300k pipeline across dual attribution.' },
];

const WE = WEEK.weeksElapsed;

// ============================================================
// TREND DATA ‚Äî weekly cumulative actuals by BU
// Update each Friday alongside SDRS actuals.
// For region view: IB_DACH and IB_EMEA split Inbound by geography.
// Region calc: DACH = DACH_ENT_OB + DACH_CORP_OB + IB_DACH
//              EMEA = EMEA_OB + IB_EMEA
//              AMER = AMER_OB, APJ = APJ_OB
// ============================================================
const WEEKS_DEF = [
  { n:1,  ending:'2026-01-08' }, { n:2,  ending:'2026-01-15' },
  { n:3,  ending:'2026-01-22' }, { n:4,  ending:'2026-01-29' },
  { n:5,  ending:'2026-02-05' }, { n:6,  ending:'2026-02-12' },
  { n:7,  ending:'2026-02-19' }, { n:8,  ending:'2026-02-26' },
  { n:9,  ending:'2026-03-05' }, { n:10, ending:'2026-03-12' },
  { n:11, ending:'2026-03-19' }, { n:12, ending:'2026-03-26' },
  { n:13, ending:'2026-03-31' },
];

// Cumulative actuals per week ‚Äî pipe in ‚Ç¨ and saos as count
// Populated from Salesforce + Salesloft snapshots each Friday
const WEEK_HISTORY = [
  { week:1, // ending 8 Jan
    EMEA_OB:{pipe:63695,saos:7}, DACH_ENT_OB:{pipe:49000,saos:4}, DACH_CORP_OB:{pipe:6700,saos:1},
    AMER_OB:{pipe:4700,saos:2}, APJ_OB:{pipe:224500,saos:15}, INBOUND:{pipe:17000,saos:3},
    IB_DACH:{pipe:14000,saos:1}, IB_EMEA:{pipe:3000,saos:2} },
  { week:2, // ending 15 Jan
    EMEA_OB:{pipe:421695,saos:21}, DACH_ENT_OB:{pipe:262000,saos:11}, DACH_CORP_OB:{pipe:10900,saos:2},
    AMER_OB:{pipe:99700,saos:14}, APJ_OB:{pipe:323600,saos:22}, INBOUND:{pipe:87000,saos:12},
    IB_DACH:{pipe:84000,saos:10}, IB_EMEA:{pipe:3000,saos:2} },
  { week:3, // ending 22 Jan
    EMEA_OB:{pipe:604695,saos:33}, DACH_ENT_OB:{pipe:319600,saos:15}, DACH_CORP_OB:{pipe:39700,saos:5},
    AMER_OB:{pipe:111500,saos:18}, APJ_OB:{pipe:464400,saos:37}, INBOUND:{pipe:172000,saos:19},
    IB_DACH:{pipe:169000,saos:17}, IB_EMEA:{pipe:3000,saos:2} },
  { week:4, // ending 29 Jan
    EMEA_OB:{pipe:604695,saos:33}, DACH_ENT_OB:{pipe:330600,saos:17}, DACH_CORP_OB:{pipe:39700,saos:5},
    AMER_OB:{pipe:582500,saos:24}, APJ_OB:{pipe:533000,saos:44}, INBOUND:{pipe:172000,saos:19},
    IB_DACH:{pipe:169000,saos:17}, IB_EMEA:{pipe:3000,saos:2} },
  { week:5, // ending 5 Feb
    EMEA_OB:{pipe:707195,saos:42}, DACH_ENT_OB:{pipe:473600,saos:25}, DACH_CORP_OB:{pipe:116700,saos:9},
    AMER_OB:{pipe:712500,saos:31}, APJ_OB:{pipe:846000,saos:72}, INBOUND:{pipe:233800,saos:29},
    IB_DACH:{pipe:205800,saos:24}, IB_EMEA:{pipe:28000,saos:5} },
  { week:6, // ending 12 Feb
    EMEA_OB:{pipe:993695,saos:59}, DACH_ENT_OB:{pipe:594000,saos:33}, DACH_CORP_OB:{pipe:182000,saos:11},
    AMER_OB:{pipe:972800,saos:45}, APJ_OB:{pipe:1043000,saos:94}, INBOUND:{pipe:398000,saos:44},
    IB_DACH:{pipe:273000,saos:36}, IB_EMEA:{pipe:125000,saos:8} },
  { week:7, // ending 19 Feb
    EMEA_OB:{pipe:1212495,saos:70}, DACH_ENT_OB:{pipe:1253000,saos:40}, DACH_CORP_OB:{pipe:296800,saos:15},
    AMER_OB:{pipe:1014000,saos:52}, APJ_OB:{pipe:1455500,saos:122}, INBOUND:{pipe:508000,saos:57},
    IB_DACH:{pipe:363000,saos:46}, IB_EMEA:{pipe:145000,saos:11} },
];

// Per-SDR single-week pipeline (EUR) from Salesforce "Pipeline Last Week" reports
// Used for real trend curves; scaled to match authoritative W6 cumulative in SDRS array
const SDR_WEEK_HISTORY = {
  // [w1, w2, w3, w4, w5, w6, w7] ‚Äî single-week pipe values
  // EMEA OB
  'Malvina Muraccioli':  [31000,94000,55000,0,86000,103000,79000],
  'Loic Hermabessiere':  [25000,68000,53000,0,15000,19000,129000],
  'Marva Hakimi':        [0,120000,25000,0,0,79000,0],
  'Casey Arra':          [0,0,0,0,1500,15000,11000],
  'Matthew Salisbury':   [0,76000,0,0,0,0,0],
  // DACH ENT OB
  'Johannes Hounsgaard': [5000,172000,7600,11000,34000,0,0],
  'Lucas Durst':         [0,25000,50000,0,86000,44000,124000],
  'Burak Ayten':         [27000,16000,0,0,0,36000,500000],
  'Julian Spretz':       [0,0,0,0,23000,6000,35000],
  'Armin Oesterwind':    [17000,0,0,0,0,0,0],
  'Julia Laura Damrath': [0,0,0,0,0,34000,0],
  // DACH CORP OB
  'Fabio Ferrauti':      [6700,4200,19000,0,61000,0,0],
  'Philip Croes':        [0,0,9800,0,16000,65000,60000],
  'Giulio Sudano':       [0,0,0,0,0,0,51000],
  'Salma Geaissa':       [0,0,0,0,0,0,3800],
  // AMER OB
  'Andrew Moher':        [4700,0,9300,19000,31000,24000,14000],
  'Tyler Escamilla':     [0,83000,0,0,76000,218000,0],
  'Richard Lam':         [0,2700,0,12000,0,13000,36000],
  'Gracie Haskell':      [0,4500,2500,0,23000,0,4500],
  // APJ OB
  'Ryuya Tanida':        [126000,24000,65000,11000,124000,47000,154000],
  'Chisako Nukui':       [28000,13000,4700,25000,91000,30000,95000],
  'Kai Nakamichi':       [19000,55000,13000,25000,65000,28000,150000],
  'Kaho Mizumachi':      [2500,5100,3100,0,13000,13000,7600],
  'Sho Nakazawa':        [49000,2000,55000,7600,20000,2500,2800],
  'Kelly Sito':          [0,0,0,0,0,0,2500],
  // INBOUND (Lucas Schmalzl combines IB + DACH CORP attribution)
  'Lucas Schmalzl':      [14000,70000,85000,0,33000,58000,40000],
  'Oisin Flynn':         [3000,0,0,0,25000,86000,20000],
  'Ying Hong':           [0,0,0,0,3800,7000,50000],
};

// Per-SDR single-week SAO counts from Salesforce "SAOs Last Week" reports
// Populate with [w1, w2, w3, w4, w5] arrays as screenshots are provided
// Leave null until data is available ‚Äî arrows will activate automatically
const SDR_SAO_HISTORY = {
  // [w1, w2, w3, w4, w5, w6, w7] ‚Äî single-week SAO counts from Salesforce
  // EMEA OB
  'Malvina Muraccioli':  [2,6,6,0,6,6,7],
  'Loic Hermabessiere':  [1,3,3,0,2,2,2],
  'Marva Hakimi':        [0,4,2,0,0,3,0],
  'Casey Arra':          [0,0,0,0,1,1,2],
  'Matthew Salisbury':   [0,1,0,0,0,0,0],
  // DACH ENT OB
  'Johannes Hounsgaard': [1,5,2,2,3,0,0],
  'Lucas Durst':         [0,1,2,0,3,3,4],
  'Burak Ayten':         [2,1,0,0,0,1,1],
  'Julian Spretz':       [0,0,0,0,2,1,2],
  'Armin Oesterwind':    [1,0,0,0,0,0,0],
  'Julia Laura Damrath': [0,0,0,0,0,3,0],
  // DACH CORP OB
  'Fabio Ferrauti':      [1,1,2,0,2,0,0],
  'Philip Croes':        [0,0,1,0,2,2,1],
  'Giulio Sudano':       [0,0,0,0,0,0,2],
  'Salma Geaissa':       [0,0,0,0,0,0,1],
  // AMER OB
  'Andrew Moher':        [2,0,3,3,5,2,1],
  'Tyler Escamilla':     [0,6,0,0,1,5,0],
  'Richard Lam':         [0,2,0,2,0,5,5],
  'Gracie Haskell':      [0,1,1,0,1,0,1],
  // APJ OB
  'Ryuya Tanida':        [5,3,6,3,8,4,14],
  'Chisako Nukui':       [4,1,1,1,7,3,5],
  'Kai Nakamichi':       [2,1,1,2,7,3,5],
  'Kaho Mizumachi':      [1,1,1,0,3,3,1],
  'Sho Nakazawa':        [3,1,6,1,3,1,2],
  'Kelly Sito':          [0,0,0,0,0,0,1],
  // INBOUND (Lucas Schmalzl combines IB + DACH CORP attribution)
  'Lucas Schmalzl':      [1,9,7,0,6,9,6],
  'Oisin Flynn':         [2,0,0,0,3,2,3],
  'Ying Hong':           [0,0,0,0,1,2,4],
};

// Per-SDR single-week activity counts from Salesloft weekly reports
// Populate with [w1, w2, w3, w4, w5] arrays as screenshots are provided
// Leave null until data is available ‚Äî arrows will activate automatically
const SDR_ACT_HISTORY = {
  // [w1, w2, w3, w4, w5, w6, w7] ‚Äî single-week activity counts from Salesloft
  // EMEA OB
  'Malvina Muraccioli':  [2600,2600,2600,2500,2600,2100,3600],
  'Loic Hermabessiere':  [58,394,664,310,169,460,1100],
  'Marva Hakimi':        [1400,1200,962,507,1100,1200,1600],
  'Casey Arra':          [1,101,384,905,451,411,744],
  'Matthew Salisbury':   [6,14,305,87,184,303,0],
  // DACH ENT OB
  'Johannes Hounsgaard': [111,253,149,3,148,302,11],
  'Lucas Durst':         [37,175,307,54,280,476,619],
  'Burak Ayten':         [110,620,361,223,452,682,655],
  'Julian Spretz':       [124,85,18,8,123,581,856],
  'Armin Oesterwind':    [360,368,127,5,3,6,4],
  'Julia Laura Damrath': [0,1,2,0,4,33,287],
  // DACH CORP OB
  'Fabio Ferrauti':      [43,399,28,4,121,132,352],
  'Philip Croes':        [72,266,62,2,88,70,60],
  'Giulio Sudano':       [62,75,107,64,38,130,156],
  'Salma Geaissa':       [0,1,0,0,37,95,185],
  // AMER OB
  'Andrew Moher':        [315,398,226,88,272,457,537],
  'Tyler Escamilla':     [202,190,365,175,174,111,365],
  'Richard Lam':         [385,275,255,155,77,305,878],
  'Gracie Haskell':      [73,165,579,981,1100,860,910],
  // APJ OB
  'Ryuya Tanida':        [348,921,1300,1500,946,877,1500],
  'Chisako Nukui':       [117,574,2300,1600,1500,847,883],
  'Kai Nakamichi':       [464,1100,642,814,715,552,486],
  'Kaho Mizumachi':      [2,48,410,593,433,506,1500],
  'Sho Nakazawa':        [46,163,191,45,51,486,649],
  'Kelly Sito':          [0,0,0,0,0,366,543],
  // INBOUND
  'Lucas Schmalzl':      [40,1200,995,435,570,104,78],
  'Oisin Flynn':         [412,815,2300,1000,2300,2200,2800],
  'Ying Hong':           [15,1100,973,7,957,68,76],
};

// Departed/promoted SDR contribution ‚Äî auto-computed as W5 snapshot minus active SDRS array
// This ensures aggregate totals always match the weekly snapshot while individual view stays clean
const SNAPSHOT_LATEST = WEEK_HISTORY[WEEK_HISTORY.length - 1]; // latest week
const DEPARTED = {};
const ALL_BUS = ['EMEA_OB','DACH_ENT_OB','DACH_CORP_OB','AMER_OB','APJ_OB','INBOUND'];
ALL_BUS.forEach(bu => {
  const sdrsInBU = SDRS.filter(s => { const r = SDR_ROSTER[s.name]; return r && r.bu === bu; });
  const sdrPipe = sdrsInBU.reduce((s,d) => s + d.pipe, 0);
  const sdrSaos = sdrsInBU.reduce((s,d) => s + d.saos, 0);
  const snapPipe = SNAPSHOT_LATEST[bu] ? SNAPSHOT_LATEST[bu].pipe : 0;
  const snapSaos = SNAPSHOT_LATEST[bu] ? SNAPSHOT_LATEST[bu].saos : 0;
  const gapPipe = snapPipe - sdrPipe;
  const gapSaos = snapSaos - sdrSaos;
  if (gapPipe !== 0 || gapSaos !== 0) DEPARTED[bu] = { pipe: gapPipe, saos: gapSaos };
});

// Helper: get snapshot totals for a given scope (BU key, region, or 'GLOBAL')
function snapshotTotal(scope) {
  const w = SNAPSHOT_LATEST;
  if (!scope || scope === 'GLOBAL' || scope === 'ALL') {
    return { pipe: ALL_BUS.reduce((s,bu) => s + (w[bu]?w[bu].pipe:0), 0),
             saos: ALL_BUS.reduce((s,bu) => s + (w[bu]?w[bu].saos:0), 0) };
  }
  if (scope.startsWith('R_')) {
    const reg = scope.replace('R_','');
    const map = { DACH:['DACH_ENT_OB','DACH_CORP_OB'], EMEA:['EMEA_OB'], AMER:['AMER_OB'], APJ:['APJ_OB'] };
    const bus = map[reg] || [];
    const ibKey = 'IB_' + reg;
    let p = bus.reduce((s,b) => s + (w[b]?w[b].pipe:0), 0) + (w[ibKey]?w[ibKey].pipe:0);
    let sa = bus.reduce((s,b) => s + (w[b]?w[b].saos:0), 0) + (w[ibKey]?w[ibKey].saos:0);
    return { pipe: p, saos: sa };
  }
  return { pipe: w[scope]?w[scope].pipe:0, saos: w[scope]?w[scope].saos:0 };
}

// Auto-calculate pipeTarget (pro-rated) and pipeQ1 (full quarter) from WEEK.ending
// Also saoT (pro-rated) and saoQ1 (full quarter)
// SAO targets pro-rate to end of business week (day+2) because SAOs count through Friday
(() => {
  const d = new Date(WEEK.ending + 'T00:00:00');
  const month = d.getMonth(); // 0=Jan, 1=Feb, 2=Mar
  const day = d.getDate();
  const saoDay = Math.min(day + 2, new Date(d.getFullYear(), month + 1, 0).getDate()); // +2 capped at month end
  const daysInMonth = new Date(d.getFullYear(), month + 1, 0).getDate(); // 28/31

  function prorate(t, useDay) {
    if (month === 0)      return Math.round((useDay / daysInMonth) * t.jan);
    else if (month === 1) return Math.round(t.jan + (useDay / daysInMonth) * t.feb);
    else                  return Math.round(t.jan + t.feb + (useDay / daysInMonth) * t.mar);
  }

  SDRS.forEach(s => {
    // Pipeline targets
    const pt = MONTHLY_PIPE_TARGETS[s.name];
    if (!pt) { s.pipeTarget = 0; s.pipeQ1 = 0; }
    else { s.pipeQ1 = pt.jan + pt.feb + pt.mar; s.pipeTarget = prorate(pt, day); }
    // SAO targets
    const st = MONTHLY_SAO_TARGETS[s.name];
    if (!st) { s.saoT = 0; s.saoQ1 = 0; }
    else { s.saoQ1 = st.jan + st.feb + st.mar; s.saoT = prorate(st, saoDay); }
  });
})();

// Derived fields
SDRS.forEach(s => {
  s.saoPct = s.saoT > 0 ? (s.saos / s.saoT) * 100 : 0;
  s.weekly = s.acts != null ? Math.round(s.acts / WE) : null;
  s.efficiency = (s.acts && s.saos > 0) ? Math.round(s.acts / s.saos) : null;
  s.onTrack = s.saoPct >= 75;
  s.pipePct = s.pipeTarget > 0 ? (s.pipe / s.pipeTarget) * 100 : 0;
  s.pipeGap = Math.max(0, s.pipeTarget - s.pipe);
  s.pipeWeeklyNeeded = WEEK.weeksRemaining > 0 ? Math.round(s.pipeGap / WEEK.weeksRemaining) : 0;

  // WoW single-week comparisons ‚Äî compares current week against last POPULATED week
  // (skips zero weeks to give a meaningful directional signal)
  function lastPopulated(arr) {
    if (!arr || arr.length < 2) return null;
    for (let i = arr.length - 2; i >= 0; i--) { if (arr[i] > 0) return arr[i]; }
    return null; // all prior weeks were zero
  }

  // SAO: compare this week vs last non-zero week
  const saoH = SDR_SAO_HISTORY[s.name];
  if (saoH && saoH.length >= 2) {
    s._saoThisWk = saoH[saoH.length - 1];
    s._saoLastWk = lastPopulated(saoH);
  }
  // Activity: compare this week vs last non-zero week
  const actH = SDR_ACT_HISTORY[s.name];
  if (actH && actH.length >= 2) {
    s._actThisWk = actH[actH.length - 1];
    s._actLastWk = lastPopulated(actH);
  }
  // Efficiency: compare single-week acts/SAO (lower is better, so arrow inverted)
  if (s._saoThisWk > 0 && s._actThisWk != null && s._saoLastWk > 0 && s._actLastWk != null) {
    // Find the matching activity for the same week the SAO lookback landed on
    let saoLookbackIdx = null;
    for (let i = saoH.length - 2; i >= 0; i--) { if (saoH[i] > 0) { saoLookbackIdx = i; break; } }
    if (saoLookbackIdx != null && actH && actH[saoLookbackIdx] > 0) {
      s._effThisWk = Math.round(s._actThisWk / s._saoThisWk);
      s._effLastWk = Math.round(actH[saoLookbackIdx] / saoH[saoLookbackIdx]);
    }
  }
});

// Compute Ramp vs Full: compare pipeTarget to max within same BU + segment
// Ramp = target is ~0%, ~50%, or ~75% of the segment max (¬±10% tolerance)
(() => {
  const groups = {};
  SDRS.forEach(s => {
    const key = s.bu + '|' + s.seg;
    if (!groups[key]) groups[key] = [];
    groups[key].push(s);
  });
  Object.values(groups).forEach(arr => {
    const mx = Math.max(...arr.map(s => s.pipeTarget));
    arr.forEach(s => {
      const ratio = mx > 0 ? s.pipeTarget / mx : 1;
      const isRamp = [0, 0.50, 0.75].some(r => Math.abs(ratio - r) <= 0.10);
      s.type = isRamp ? 'Ramp' : 'Full';
    });
  });
})();

// Outcome-led status zones (assigned after ramp detection)
SDRS.forEach(s => {
  if (s.type === 'Ramp') s.zone = 'ramping';
  else if (s.pipePct >= 90 && s.saoPct >= 75) s.zone = 'exceeding';
  else if (s.pipePct >= 50 && s.saoPct >= 50) s.zone = 'on_track';
  else if (s.saoPct >= 75 && s.pipePct < 50) s.zone = 'deal_size';
  else if ((s.weekly||0) >= 200 && s.saoPct < 50) s.zone = 'conversion';
  else s.zone = 'activity';

  // Weeks-in-zone: compare to PREV_ZONES and increment or reset
  const prev = PREV_ZONES[s.name];
  s.weeksInZone = (prev && prev.zone === s.zone) ? prev.weeks + 1 : 1;

  // Activity trend: compare last week to their personal average
  const lastWk = LAST_WEEK_ACTS[s.name] || null;
  const avgWk = s.weekly || 0;
  if (lastWk !== null && avgWk > 0) {
    const delta = lastWk - avgWk;
    const deltaPct = Math.round((delta / avgWk) * 100);
    s.actTrend = { lastWk, avgWk, delta, deltaPct };
  } else {
    s.actTrend = null;
  }
});

// ============================================================
// UTILS
// ============================================================
function eur(v) { if (v == null) return '‚Äî'; return '‚Ç¨' + (v >= 1000000 ? (v/1000000).toFixed(2)+'M' : v >= 1000 ? Math.round(v/1000)+'k' : v); }
function eurShort(v) { if (v == null) return '‚Äî'; return '‚Ç¨' + (v >= 1000000 ? (v/1000000).toFixed(2)+'M' : v >= 1000 ? (v/1000).toFixed(1)+'k' : v); }
function pct(v) { return v.toFixed(0) + '%'; }
function fmtDate(iso, style) {
  const d = new Date(iso + 'T00:00:00');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${d.getDate()} ${months[d.getMonth()]}`;
}
function firstName(n) { const p = n.split(' '); return p[0] + ' ' + p[p.length - 1][0] + '.'; }
function shortName(n) { const p = n.split(' '); return p[0] + ' ' + p[p.length-1][0] + '.'; }
function zoneLabel(z) { return {exceeding:'‚úÖ Exceeding',on_track:'On Track',deal_size:'‚ö†Ô∏è Deal Size',conversion:'‚ö†Ô∏è Conversion',activity:'üî¥ Activity Gap',ramping:'üîµ Ramping'}[z]||'‚Äî'; }
function zoneColor(z) { return {exceeding:'#16a34a',on_track:'#65a30d',deal_size:'#d97706',conversion:'#d97706',activity:'#dc2626',ramping:'#2563eb'}[z]||'#94a3b8'; }
function zoneBg(z) { return {exceeding:'#f0fdf4',on_track:'#f7fee7',deal_size:'#fffbeb',conversion:'#fffbeb',activity:'#fef2f2',ramping:'#eff6ff'}[z]||'#f8fafc'; }
function zoneBorder(z) { return {exceeding:'#bbf7d0',on_track:'#d9f99d',deal_size:'#fde68a',conversion:'#fde68a',activity:'#fecaca',ramping:'#bfdbfe'}[z]||'#e2e8f0'; }
function saoTagClass(p) { return p >= 100 ? 'tag-green' : p >= 75 ? 'tag-lime' : p >= 50 ? 'tag-amber' : 'tag-red'; }
function pipeTagClass(p) { return p >= 90 ? 'tag-green' : p >= 50 ? 'tag-amber' : 'tag-red'; }
function attColor(p) { return p >= 90 ? '#16a34a' : p >= 70 ? '#d97706' : '#dc2626'; }

// ============================================================
// 1. GLOBAL KPIs
// ============================================================
function renderGlobalKPIs() {
  const snap = snapshotTotal('GLOBAL');
  const totalPipe = snap.pipe;
  const totalSAO = snap.saos;
  const totalPipePR = SDRS.reduce((s,d) => s + d.pipeTarget, 0);
  const totalSaoPR = SDRS.reduce((s,d) => s + d.saoT, 0);
  const pA = totalPipePR > 0 ? totalPipe/totalPipePR*100 : 0;
  const sA = totalSaoPR > 0 ? totalSAO/totalSaoPR*100 : 0;
  const active = SDRS.filter(s => s.acts != null).length;
  const avgP = active > 0 ? totalPipe / active : 0;
  const wkVals = SDRS.filter(s => s.weekly != null).map(s => s.weekly).sort((a,b) => a-b);
  const med = wkVals[Math.floor(wkVals.length/2)] || 0;
  const onT = SDRS.filter(s => s.onTrack).length;
  const oR = SDRS.length > 0 ? onT/SDRS.length*100 : 0;

  // Avg Pipeline / SDR ‚Äî pro-rated against ‚Ç¨430k/quarter target
  const qTarget = 430000;
  const proRatedTarget = qTarget * (WE / WEEK.totalWeeks);
  const avgPctOfTarget = proRatedTarget > 0 ? avgP / proRatedTarget * 100 : 0;
  const prevAvgP = PREV_WEEK.totalPipe / (PREV_WEEK.activeSDRs || active);
  const prevProRated = qTarget * ((WE - 1) / WEEK.totalWeeks);
  const prevAvgPct = prevProRated > 0 ? prevAvgP / prevProRated * 100 : 0;
  const avgTrend = avgPctOfTarget - prevAvgPct;
  const trendLabel = avgTrend > 2 ? 'Improving' : avgTrend < -2 ? 'Slipping' : 'Steady';
  const trendClass = avgTrend > 2 ? 'up' : avgTrend < -2 ? 'down' : 'flat';

  // KPI directional arrow helper ‚Äî threshold defaults to 2 (good for %) but can be overridden
  function kpiArrow(cur, prev, label, suffix, desc, threshold) {
    const t = threshold !== undefined ? threshold : 2;
    const d = cur - prev;
    const dir = d > t ? 'up' : d < -t ? 'down' : 'flat';
    const sym = d > t ? '‚ñ≤' : d < -t ? '‚ñº' : '‚ñ∂';
    const move = d > t ? 'Up' : d < -t ? 'Down' : 'Flat';
    const tip = `${label}: ${move} vs last week (${suffix})`;
    return `<span class="trend-tag ${dir}" style="font-size:9px;padding:1px 5px;vertical-align:middle" title="${tip}">${sym}</span><span class="zone-tip" data-tip="${desc}">?</span>`;
  }

  // Previous attainment %s using current targets as denominator
  const prevPipeAtt = totalPipePR > 0 ? PREV_WEEK.totalPipe / totalPipePR * 100 : 0;
  const prevSaoAtt = totalSaoPR > 0 ? PREV_WEEK.totalSAOs / totalSaoPR * 100 : 0;
  const prevOnTrackPct = PREV_WEEK.activeSDRs > 0 ? PREV_WEEK.onTrack / PREV_WEEK.activeSDRs * 100 : 0;
  const curOnTrackPct = SDRS.length > 0 ? onT / SDRS.length * 100 : 0;

  // Median activity WoW: compute previous median from act history
  const prevWkActs = SDRS.map(s => {
    const h = SDR_ACT_HISTORY[s.name];
    return h && h.length >= 2 ? h[h.length - 2] : null;
  }).filter(v => v != null).sort((a,b) => a - b);
  const prevMed = prevWkActs.length > 0 ? prevWkActs[Math.floor(prevWkActs.length / 2)] : med;

  const pipeArrow = kpiArrow(pA, prevPipeAtt, 'Pipeline attainment', `${Math.round(prevPipeAtt)}% ‚Üí ${Math.round(pA)}%`, 'Pipeline attainment % vs pro-rated Q1 target, compared to last week');
  const saoArrow = kpiArrow(sA, prevSaoAtt, 'SAO attainment', `${Math.round(prevSaoAtt)}% ‚Üí ${Math.round(sA)}%`, 'SAO attainment % vs pro-rated Q1 target, compared to last week');
  const sdrsArrow = kpiArrow(active, PREV_WEEK.activeSDRs, 'Active SDRs', `${PREV_WEEK.activeSDRs} ‚Üí ${active}`, 'Change in number of active SDRs with recorded activity', 0);
  const avgArrow = kpiArrow(avgPctOfTarget, prevAvgPct, 'Avg pipeline pace', `${Math.round(prevAvgPct)}% ‚Üí ${Math.round(avgPctOfTarget)}%`, 'Average pipeline per SDR as % of pro-rated ‚Ç¨430k target, compared to last week');
  const medArrow = kpiArrow(med, prevMed, 'Median activity', `${prevMed} ‚Üí ${med}`, 'Median single-week Salesloft activity count, compared to last week');
  const onTArrow = kpiArrow(curOnTrackPct, prevOnTrackPct, 'On-track rate', `${Math.round(prevOnTrackPct)}% ‚Üí ${Math.round(curOnTrackPct)}%`, '% of SDRs at ‚â•75% SAO attainment, compared to last week');

  document.getElementById('globalKpis').innerHTML = `
    <div class="kpi ${pA>=90?'green':pA>=70?'amber':'red'}"><div class="kpi-arrow">${pipeArrow}</div><div class="kpi-label">Pipeline</div><div class="kpi-value">${eurShort(totalPipe)}</div><div class="kpi-target">of ${eurShort(totalPipePR)} target</div><div class="kpi-delta ${pA>=90?'up':pA>=70?'amber':'down'}">${pct(pA)} attainment</div></div>
    <div class="kpi ${sA>=90?'green':sA>=70?'amber':'red'}"><div class="kpi-arrow">${saoArrow}</div><div class="kpi-label">SAO</div><div class="kpi-value">${totalSAO}</div><div class="kpi-target">of ${totalSaoPR} target</div><div class="kpi-delta ${sA>=90?'up':sA>=70?'amber':'down'}">${pct(sA)} attainment</div></div>
    <div class="kpi ${active>=43?'green':active>=35?'amber':'red'}"><div class="kpi-arrow">${sdrsArrow}</div><div class="kpi-label">Active SDRs</div><div class="kpi-value">${active}</div><div class="kpi-target">of 43 target headcount</div><div class="kpi-delta ${active>=43?'up':active>=35?'amber':'down'}">${pct(active/43*100)} staffed</div></div>
    <div class="kpi ${avgPctOfTarget>=90?'green':avgPctOfTarget>=70?'amber':'red'}"><div class="kpi-arrow">${avgArrow}</div><div class="kpi-label">Avg Pipe. / SDR</div><div class="kpi-value">${eurShort(Math.round(avgP))}</div><div class="kpi-target">of ${eurShort(Math.round(proRatedTarget))} target (‚Ç¨430k/qtr)</div><div class="kpi-delta ${avgPctOfTarget>=90?'up':avgPctOfTarget>=70?'amber':'down'}">${pct(avgPctOfTarget)} on-pace</div></div>
    <div class="kpi ${med>=500?'green':med>=350?'amber':'red'}"><div class="kpi-arrow">${medArrow}</div><div class="kpi-label">Median Act. / Wk</div><div class="kpi-value">${med}</div><div class="kpi-target">of 500 target</div><div class="kpi-delta ${med>=500?'up':med>=350?'amber':'down'}">${pct(med/500*100)} of target</div></div>
    <div class="kpi ${oR>=50?'green':'amber'}"><div class="kpi-arrow">${onTArrow}</div><div class="kpi-label">On-track SAO</div><div class="kpi-value">${onT} / ${SDRS.length}</div><div class="kpi-target">‚â•75% SAO attainment</div><div class="kpi-delta ${oR>=50?'up':'amber'}">${pct(oR)} on-track</div></div>`;
}

// ============================================================
// 2. WEEK-ON-WEEK CHANGES
// ============================================================
function renderWoW() {
  const snap = snapshotTotal('GLOBAL');
  const cur = {
    totalPipe: snap.pipe,
    totalSAOs: snap.saos,
    totalActs: SDRS.reduce((s,d)=>s+(d.acts||0),0),
    onTrack: SDRS.filter(s=>s.onTrack).length,
  };
  const prev = PREV_WEEK;
  const dPipe = cur.totalPipe - prev.totalPipe;
  const dSAO = cur.totalSAOs - prev.totalSAOs;
  const dActs = cur.totalActs - prev.totalActs;
  const dOnT = cur.onTrack - prev.onTrack;

  // Compute single-week increments from WEEK_HISTORY for trend comparison
  const nW = WEEK_HISTORY.length;
  const weeklyPipe = [], weeklySAO = [];
  for (let i = 0; i < nW; i++) {
    const w = WEEK_HISTORY[i];
    const buKeys = ['EMEA_OB','DACH_ENT_OB','DACH_CORP_OB','AMER_OB','APJ_OB','INBOUND'];
    const wPipe = buKeys.reduce((s,b) => s + ((w[b]||{}).pipe||0), 0);
    const wSao = buKeys.reduce((s,b) => s + ((w[b]||{}).saos||0), 0);
    if (i === 0) { weeklyPipe.push(wPipe); weeklySAO.push(wSao); }
    else {
      const p = WEEK_HISTORY[i-1];
      const pPipe = buKeys.reduce((s,b) => s + ((p[b]||{}).pipe||0), 0);
      const pSao = buKeys.reduce((s,b) => s + ((p[b]||{}).saos||0), 0);
      weeklyPipe.push(wPipe - pPipe);
      weeklySAO.push(wSao - pSao);
    }
  }

  // This week vs average of prior weeks
  const thisWkPipe = weeklyPipe[nW - 1] || 0;
  const thisWkSao = weeklySAO[nW - 1] || 0;
  const priorPipeAvg = nW > 1 ? weeklyPipe.slice(0, -1).reduce((s,v) => s+v, 0) / (nW - 1) : thisWkPipe;
  const priorSaoAvg = nW > 1 ? weeklySAO.slice(0, -1).reduce((s,v) => s+v, 0) / (nW - 1) : thisWkSao;

  // WoW arrow helper: compare value vs prior average, with threshold %
  function wowTrendArrow(thisWk, priorAvg, label) {
    const pctDiff = priorAvg > 0 ? ((thisWk - priorAvg) / priorAvg) * 100 : 0;
    const dir = pctDiff > 10 ? 'up' : pctDiff < -10 ? 'down' : 'flat';
    const sym = pctDiff > 10 ? '‚ñ≤' : pctDiff < -10 ? '‚ñº' : '‚ñ∂';
    const move = pctDiff > 10 ? 'Above' : pctDiff < -10 ? 'Below' : 'In line with';
    const tip = `${label}: ${move} prior weeks average (${Math.round(pctDiff)}%)`;
    return `<span class="trend-tag ${dir}" style="font-size:9px;padding:1px 5px" title="${tip}">${sym}</span>`;
  }

  const pipeArrow = wowTrendArrow(thisWkPipe, priorPipeAvg, 'Pipeline this week');
  const saoArrow = wowTrendArrow(thisWkSao, priorSaoAvg, 'SAOs this week');
  const onTArrow = wowTrendArrow(cur.onTrack, prev.onTrack, 'On-track SDRs');

  // Median activity: this week vs prior weeks median
  const median = arr => { const s = [...arr].sort((a,b)=>a-b); const m = Math.floor(s.length/2); return s.length%2 ? s[m] : Math.round((s[m-1]+s[m])/2); };
  const lwActs = SDRS.map(s => LAST_WEEK_ACTS[s.name] || 0);
  const medLW = median(lwActs);
  // Prior weeks' medians from history
  const priorMeds = [];
  for (let wi = 0; wi < nW - 1; wi++) {
    const wkActs = SDRS.map(s => {
      const h = SDR_ACT_HISTORY[s.name];
      return h && h.length > wi ? h[wi] : 0;
    });
    priorMeds.push(median(wkActs));
  }
  const priorMedAvg = priorMeds.length > 0 ? priorMeds.reduce((s,v) => s+v, 0) / priorMeds.length : medLW;
  const medArrow = wowTrendArrow(medLW, priorMedAvg, 'Median activity');

  // Jan avg median for detail line
  const janWeekly = SDRS.map(s => {
    const lw = LAST_WEEK_ACTS[s.name] || 0;
    const janTotal = Math.max(0, (s.acts||0) - lw);
    return Math.round(janTotal / 4);
  });
  const medJan = median(janWeekly);
  const dMed = medLW - medJan;

  const zoneNow = {activity:0,conversion:0,deal_size:0,on_track:0,exceeding:0,ramping:0};
  SDRS.forEach(s => { if(zoneNow[s.zone] !== undefined) zoneNow[s.zone]++; });
  const zD = {
    activity: zoneNow.activity - prev.zoneActivity,
    conversion: zoneNow.conversion - prev.zoneConversion,
    deal_size: zoneNow.deal_size - prev.zoneDealSize,
    on_track: zoneNow.on_track - prev.zoneOnTrack,
    exceeding: zoneNow.exceeding - prev.zoneExceeding,
    ramping: zoneNow.ramping - prev.zoneRamping,
  };

  const zMoves = [];
  if (zD.exceeding > 0) zMoves.push(`<span style="color:#16a34a">+${zD.exceeding} Exceeding</span>`);
  if (zD.on_track > 0) zMoves.push(`<span style="color:#65a30d">+${zD.on_track} On Track</span>`);
  if (zD.deal_size < 0) zMoves.push(`<span style="color:#16a34a">${zD.deal_size} Deal Size</span>`);
  if (zD.conversion < 0) zMoves.push(`<span style="color:#16a34a">${zD.conversion} Conversion</span>`);
  if (zD.activity < 0) zMoves.push(`<span style="color:#16a34a">${zD.activity} Activity Gap</span>`);
  if (zD.activity > 0) zMoves.push(`<span style="color:#dc2626">+${zD.activity} Activity Gap</span>`);
  if (zD.conversion > 0) zMoves.push(`<span style="color:#dc2626">+${zD.conversion} Conversion</span>`);
  if (zD.deal_size > 0) zMoves.push(`<span style="color:#dc2626">+${zD.deal_size} Deal Size</span>`);
  if (zD.on_track < 0) zMoves.push(`<span style="color:#dc2626">${zD.on_track} On Track</span>`);
  if (zD.exceeding < 0) zMoves.push(`<span style="color:#dc2626">${zD.exceeding} Exceeding</span>`);

  // Net zone movement direction (weighted by zone quality)
  // Weights: exceeding +2, on_track +1, deal_size 0, conversion -1, activity -2, ramping 0
  const zoneNet = (zD.exceeding * 2) + (zD.on_track * 1) + (zD.deal_size * 0) + (zD.conversion * -1) + (zD.activity * -2);
  const zoneArrow = wowTrendArrow(zoneNet + 10, 10, 'Net zone movement');

  const prevWeekEnd = WEEKS_DEF.find(w => w.n === WEEK.number - 1);
  const prevEndStr = prevWeekEnd ? fmtDate(prevWeekEnd.ending) : `Week ${WEEK.number - 1}`;
  document.getElementById('wowSub').textContent = `Comparing Week ${WEEK.number} vs Week ${WEEK.number - 1} (ending ${prevEndStr})`;

  document.getElementById('wowGrid').innerHTML = `
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${pipeArrow}</div>
      <div class="wow-card-title">Pipeline Added This Week</div>
      <div class="wow-main" style="color:${dPipe>=0?'#16a34a':'#dc2626'}">${dPipe>=0?'+':''}${eurShort(dPipe)}</div>
      <div class="wow-detail">Cumulative now ${eurShort(cur.totalPipe)}</div>
      <div class="wow-tag ${dPipe>=0?'pos':'neg'}">${eurShort(Math.round(dPipe/1))} in the week</div>
    </div>
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${saoArrow}</div>
      <div class="wow-card-title">SAO Closed This Week</div>
      <div class="wow-main" style="color:${dSAO>=0?'#16a34a':'#dc2626'}">+${dSAO}</div>
      <div class="wow-detail">Cumulative now ${cur.totalSAOs}</div>
      <div class="wow-tag ${dSAO>=40?'pos':dSAO>=30?'neu':'neg'}">${dSAO >= 40 ? 'Strong week' : dSAO >= 30 ? 'Steady' : 'Below run-rate'}</div>
    </div>
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${onTArrow}</div>
      <div class="wow-card-title">On-track SDRs (‚â•75% SAO)</div>
      <div class="wow-main">${cur.onTrack} <span style="font-size:14px;color:${dOnT>=0?'#16a34a':'#dc2626'}">(${dOnT>=0?'+':''}${dOnT})</span></div>
      <div class="wow-detail">${SDRS.length - cur.onTrack} off-track entering Week ${WEEK.number + 1}</div>
      <div class="wow-tag ${dOnT>0?'pos':dOnT===0?'neu':'neg'}">${dOnT>0?'Improving':dOnT===0?'No change':'Slipping'}</div>
    </div>
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${medArrow}</div>
      <div class="wow-card-title">Median Activities / Week</div>
      <div class="wow-main">${medLW.toLocaleString()} <span style="font-size:14px;color:${dMed>=0?'#16a34a':'#dc2626'}">(${dMed>=0?'+':''}${dMed.toLocaleString()})</span></div>
      <div class="wow-detail">Jan avg median: ${medJan.toLocaleString()} / week</div>
      <div class="wow-tag ${medLW>=500?'pos':medLW>=350?'neu':'neg'}">${medLW>=500?'Above target':medLW>=350?'Building':'Below 500 target'}</div>
    </div>
    <div class="wow-card" style="position:relative">
      <div style="position:absolute;top:10px;right:10px">${zoneArrow}</div>
      <div class="wow-card-title">Zone Movements</div>
      <div class="wow-main" style="font-size:14px;line-height:1.8">${zMoves.length ? zMoves.join('<br>') : 'No changes'}</div>
      <div class="wow-detail">Net movement from prev. week</div>
    </div>`;
}

// ============================================================
// 2b. WEEK HIGHLIGHTS
// ============================================================
function renderHighlights() {
  document.getElementById('highlightsTitle').textContent = 'Week ' + WEEK.weeksElapsed + ' Highlights';
  document.getElementById('highlightsGrid').innerHTML = HIGHLIGHTS.map(h => `
    <div class="highlight-card">
      <div class="highlight-emoji">${h.emoji}</div>
      <div class="highlight-name">${h.name}</div>
      <div class="highlight-title">${h.title}</div>
      <div class="highlight-stat">${h.stat}</div>
      <div class="highlight-detail">${h.detail}</div>
    </div>`).join('');
}

// ============================================================
// 2c. MANAGEMENT FOCUS
// ============================================================
const MGR_DEFS = [
  { name:'David Perl',    short:'David',    bu:'DACH_ENT_OB',  buLabel:'DACH Enterprise' },
  { name:'Patricia Chemnitzer', short:'Patricia', bu:'DACH_CORP_OB', buLabel:'DACH Corporate' },
  { name:'Julien Thuy',   short:'Julien',   bu:'EMEA_OB',      buLabel:'EMEA Outbound' },
  { name:'Woojin Shin',   short:'Woojin',   bu:'AMER_OB',      buLabel:'AMER Outbound' },
  { name:'Rio Uchida',    short:'Rio',       bu:'APJ_OB',       buLabel:'APJ Outbound' },
  { name:'Danielle Carroll', short:'Danielle', bu:'INBOUND',   buLabel:'Inbound' },
];

function renderMgrFocus() {
  const ACT_BASE = 500;
  const grid = document.getElementById('mgrFocusGrid');

  grid.innerHTML = MGR_DEFS.map(mgr => {
    const team = SDRS.filter(s => s.bu === mgr.bu);
    const active = team.filter(s => s.acts != null);
    const total = active.length;
    if (total === 0) return '';

    // Team metrics
    const belowAct = active.filter(s => (s.weekly || 0) < ACT_BASE);
    const belowActPct = total > 0 ? belowAct.length / total * 100 : 0;
    const avgWeekly = total > 0 ? Math.round(active.reduce((s, d) => s + (d.weekly || 0), 0) / total) : 0;
    const ramping = active.filter(s => s.type === 'Ramp');
    const rampPct = total > 0 ? ramping.length / total * 100 : 0;
    const teamSaos = active.reduce((s, d) => s + d.saos, 0);
    const teamActs = active.reduce((s, d) => s + (d.acts || 0), 0);
    const teamEfficiency = teamSaos > 0 ? Math.round(teamActs / teamSaos) : 999;
    const teamPipe = active.reduce((s, d) => s + d.pipe, 0);
    const teamPipeT = active.reduce((s, d) => s + d.pipeTarget, 0);
    const teamSaoT = active.reduce((s, d) => s + d.saoT, 0);
    const pipePct = teamPipeT > 0 ? teamPipe / teamPipeT * 100 : 0;
    const saoPct = teamSaoT > 0 ? teamSaos / teamSaoT * 100 : 0;
    const onTrack = active.filter(s => s.onTrack).length;
    const avgDeal = teamSaos > 0 ? Math.round(teamPipe / teamSaos) : 0;

    // Waterfall priority evaluation
    let focus, lines, tier; // tier: 'red', 'amber', 'green'

    // Results override: if team is delivering (pipe ‚â•80% AND sao ‚â•80%), activity gaps are not the constraint
    const resultsStrong = pipePct >= 80 && saoPct >= 80;

    if (belowActPct >= 75 && avgWeekly < 300) {
      // ACTIVITY CRISIS ‚Äî structural failure, nearly entire team far below baseline
      tier = 'red';
      focus = 'üî¥ Activity Crisis';
      const teamAvgPct = Math.round(avgWeekly / ACT_BASE * 100);
      lines = [
        `${belowAct.length} of ${total} SDRs below ${ACT_BASE} acts/wk.`,
        `Team averaging ${avgWeekly} acts/wk (${teamAvgPct}% of baseline).`,
      ];
      // Estimate missed pipeline using BU median conversion √ó median deal size
      // Medians strip out outlier deals and small-sample conversion rates
      const convRates = active.filter(s => s.acts > 0 && s.saos > 0).map(s => s.saos / s.acts).sort((a,b) => a-b);
      const dealSizes = active.filter(s => s.saos > 0).map(s => s.pipe / s.saos).sort((a,b) => a-b);
      const median = arr => arr.length === 0 ? 0 : arr.length % 2 === 0 ? (arr[arr.length/2 - 1] + arr[arr.length/2]) / 2 : arr[Math.floor(arr.length/2)];
      const medConv = median(convRates);
      const medDeal = median(dealSizes);
      let totalMissedPipe = 0;
      belowAct.forEach(s => {
        const gapActs = (ACT_BASE - (s.weekly || 0)) * WE;
        totalMissedPipe += Math.round(gapActs * medConv * medDeal);
      });
      if (totalMissedPipe > 0) lines.push(`Est. ‚Ç¨${totalMissedPipe >= 1000000 ? (totalMissedPipe/1000000).toFixed(1)+'M' : Math.round(totalMissedPipe/1000)+'k'} pipeline left on the table to date.`);

    } else if (belowActPct >= 50 && !resultsStrong) {
      // ACTIVITY UPLIFT ‚Äî significant gaps but team has some performers
      tier = 'amber';
      focus = '‚ö†Ô∏è Activity Uplift';
      const aboveAct = active.filter(s => (s.weekly || 0) >= ACT_BASE);
      lines = [
        `${belowAct.length} of ${total} SDRs below ${ACT_BASE} acts/wk (${aboveAct.length} above).`,
        `Team averaging ${avgWeekly} acts/wk ‚Äî close the gap on underperformers.`,
      ];
      if (teamEfficiency > 400) lines.push(`Conversion also needs attention at ${teamEfficiency} acts per SAO.`);
      else lines.push(`Conversion rate is healthy at ${teamEfficiency} acts/SAO ‚Äî volume is the lever.`);

    } else if (rampPct >= 50) {
      // RAMP ACCELERATION ‚Äî most of team is new
      tier = 'amber';
      focus = 'üîµ Ramp Acceleration';
      lines = [
        `${ramping.length} of ${total} SDRs currently ramping.`,
        `Focus on accelerating time-to-productivity and early wins.`,
        `Structured role-play and call coaching are the priority lever.`,
      ];

    } else if (teamEfficiency > 400 && teamSaos > 0) {
      // CONVERSION QUALITY ‚Äî doing the work but not converting
      tier = 'amber';
      focus = '‚ö†Ô∏è Conversion Quality';
      lines = [
        `Activity at ${avgWeekly} acts/wk but ${teamEfficiency} acts per SAO.`,
        `${teamSaos} SAOs from ${teamActs.toLocaleString()} activities ‚Äî target is <250.`,
        `Review call quality, targeting accuracy, and discovery technique.`,
      ];

    } else if (saoPct >= 70 && pipePct < 60) {
      // DEAL VALUE GAP ‚Äî meetings happening but too small
      tier = 'amber';
      focus = '‚ö†Ô∏è Deal Value Gap';
      lines = [
        `SAOs at ${Math.round(saoPct)}% but pipeline only ${Math.round(pipePct)}% of target.`,
        `Avg deal size ‚Ç¨${avgDeal.toLocaleString()} ‚Äî prospect into higher-value accounts.`,
        `Review qualification: are the right personas and use cases being targeted?`,
      ];

    } else if (saoPct < 70 && pipePct < 70 && belowActPct < 50) {
      // PIPELINE SPRINT ‚Äî both behind but activity isn't the core issue
      tier = 'red';
      focus = 'üî¥ Pipeline Sprint';
      const behindCount = active.filter(s => !s.onTrack).length;
      lines = [
        `${behindCount} of ${total} SDRs off-track. Pipeline at ${Math.round(pipePct)}%, SAOs at ${Math.round(saoPct)}%.`,
        `Activity is not the primary issue ‚Äî focus on targeting and multi-threading.`,
        `Review pipeline composition: are deals progressing or stalling?`,
      ];

    } else {
      // PROTECT MOMENTUM ‚Äî on track or results overriding activity concern
      tier = 'green';
      focus = '‚úÖ Protect Momentum';
      const exCount = active.filter(s => s.zone === 'exceeding').length;
      lines = [
        `${onTrack} of ${total} SDRs on-track. Pipeline at ${Math.round(pipePct)}%, SAOs at ${Math.round(saoPct)}%.`,
        exCount > 0 ? `${exCount} exceeding ‚Äî consider stretch goals or peer coaching roles.` : `Maintain rhythm ‚Äî don't disrupt what's working.`,
      ];
      if (belowAct.length > 0) lines.push(`${belowAct.length} SDR${belowAct.length > 1 ? 's' : ''} still below ${ACT_BASE}/wk ‚Äî address individually.`);
      else lines.push(`Maintain rhythm ‚Äî protect the environment driving these results.`);
    }

    // Colours ‚Äî if results are strong, soften to green hue regardless of focus area
    if (resultsStrong && tier !== 'red') tier = 'green';
    const bg = { red:'#fef2f2', amber:'#fffbeb', green:'#f0fdf4' }[tier];
    const bd = { red:'#fecaca', amber:'#fde68a', green:'#bbf7d0' }[tier];
    const stripe = { red:'#dc2626', amber:'#d97706', green:'#16a34a' }[tier];

    return `<div style="background:${bg};border:1px solid ${bd};border-left:4px solid ${stripe};border-radius:10px;padding:14px 16px;display:flex;flex-direction:column;gap:6px;box-sizing:border-box;height:180px;overflow:hidden">
      <div style="font-size:13px;font-weight:700;color:#0F4C81">${mgr.name}</div>
      <div style="font-size:10px;color:#94a3b8;margin-top:-4px">${mgr.buLabel} ¬∑ ${total} SDRs</div>
      <div style="font-size:12px;font-weight:700;color:${stripe};margin-top:2px">${focus}</div>
      <div style="font-size:11px;color:#334155;line-height:1.55;flex:1">${lines.slice(0,3).map(l => '‚Ä¢ ' + l).join('<br>')}</div>
    </div>`;
  }).join('');
}

// ============================================================
// 3. BU PROGRESS
// ============================================================
function renderBU() {
  const bus = {};
  SDRS.forEach(s => {
    if (!bus[s.bu]) bus[s.bu] = {pipe:0,saos:0,saoT:0,pipePR:0,active:0,onTrack:0,total:0,lwActs:[]};
    bus[s.bu].saos += s.saos; bus[s.bu].saoT += s.saoT;
    bus[s.bu].pipePR += s.pipeTarget; if (s.acts != null) bus[s.bu].active++;
    bus[s.bu].total++;
    if (s.onTrack) bus[s.bu].onTrack++;
    const lw = LAST_WEEK_ACTS[s.name] || 0;
    bus[s.bu].lwActs.push(lw);
  });
  // Overlay snapshot actuals ‚Äî departed SDRs contribute at BU level
  ALL_BUS.forEach(bu => {
    if (!bus[bu]) bus[bu] = {pipe:0,saos:0,saoT:0,pipePR:0,active:0,onTrack:0,total:0,lwActs:[]};
    bus[bu].pipe = SNAPSHOT_LATEST[bu] ? SNAPSHOT_LATEST[bu].pipe : 0;
    bus[bu].saos = SNAPSHOT_LATEST[bu] ? SNAPSHOT_LATEST[bu].saos : 0;
  });
  const median = arr => { if (!arr.length) return 0; const s = [...arr].sort((a,b)=>a-b); const m = Math.floor(s.length/2); return s.length%2 ? s[m] : Math.round((s[m-1]+s[m])/2); };
  const ACT_TARGET = 500;
  // Trend helper: compare current attainment % vs previous, return arrow HTML
  function trendArrow(curPct, prevPct, label) {
    const d = curPct - prevPct;
    const dir = d > 2 ? 'up' : d < -2 ? 'down' : 'flat';
    const sym = d > 2 ? '‚ñ≤' : d < -2 ? '‚ñº' : '‚ñ∂';
    const move = d > 2 ? 'Up' : d < -2 ? 'Down' : 'Flat';
    const prefix = label === 'Pipeline' ? 'P' : 'S';
    const tip = `${label} attainment: ${move} vs last week (${Math.round(prevPct)}% ‚Üí ${Math.round(curPct)}%)`;
    return `<span class="trend-tag ${dir}" title="${tip}">${prefix}${sym}</span>`;
  }
  document.getElementById('buGrid').innerHTML = Object.entries(BU_META).map(([k,meta]) => {
    const d = bus[k] || {pipe:0,saos:0,saoT:0,pipePR:0,active:0,onTrack:0,total:0,lwActs:[]};
    const pp = d.pipePR>0?d.pipe/d.pipePR*100:0;
    const sp = d.saoT>0?d.saos/d.saoT*100:0;
    const otPct = d.total>0?d.onTrack/d.total*100:0;
    const otColor = otPct >= 50 ? '#16a34a' : otPct >= 25 ? '#d97706' : '#dc2626';
    const medAct = median(d.lwActs);
    const actPct = ACT_TARGET > 0 ? medAct / ACT_TARGET * 100 : 0;
    // Previous week attainment for trend
    const prev = PREV_BU[k] || {pipe:0, saos:0};
    const prevPP = d.pipePR>0 ? prev.pipe/d.pipePR*100 : 0;
    const prevSP = d.saoT>0 ? prev.saos/d.saoT*100 : 0;
    return `<div class="bu-card">
      <div class="bu-name"><span class="bu-dot" style="background:${meta.color}"></span>${meta.label}<span style="margin-left:auto;display:flex;gap:4px;align-items:center">${trendArrow(pp, prevPP, 'Pipeline')} ${trendArrow(sp, prevSP, 'SAO')}<span class="zone-tip" data-tip="P = Pipeline trend ¬∑ S = SAO trend (vs prior week)">?</span></span></div>
      <div style="font-size:11px;color:#94a3b8;margin:-4px 0 8px 0"><span style="color:${d.active>=meta.hcTarget?'#16a34a':'#dc2626'};font-weight:600">${d.active} / ${meta.hcTarget} in-seat</span> ¬∑ ${meta.mgrShort}</div>
      <div class="progress-row"><span class="progress-label">Pipeline</span><div class="progress-track"><div class="progress-fill" style="width:${Math.min(pp,100)}%;background:${attColor(pp)}"><span>${pct(pp)}</span></div></div><span class="progress-val">${eurShort(d.pipe)} / ${eurShort(d.pipePR)}</span></div>
      <div class="progress-row"><span class="progress-label">SAO</span><div class="progress-track"><div class="progress-fill" style="width:${Math.min(sp,100)}%;background:${attColor(sp)}"><span>${pct(sp)}</span></div></div><span class="progress-val">${d.saos} / ${d.saoT}</span></div>
      <div class="progress-row"><span class="progress-label">Activities</span><div class="progress-track"><div class="progress-fill" style="width:${Math.min(actPct,100)}%;background:${attColor(actPct)}"><span>${pct(actPct)}</span></div></div><span class="progress-val">${medAct} / ${ACT_TARGET} median</span></div>
      <div class="progress-row"><span class="progress-label">On-track</span><div class="progress-track"><div class="progress-fill" style="width:${Math.min(otPct,100)}%;background:${otColor}"><span>${pct(otPct)}</span></div></div><span class="progress-val" style="color:${otColor}">${d.onTrack} / ${d.total} SDRs</span></div></div>`;
  }).join('');
}

// ============================================================
// 4. REGIONAL ALLBOUND
// ============================================================
function renderRegions() {
  const cls = {DACH:'dach',EMEA:'emea',AMER:'amer',APJ:'apj'};
  const proRatedTarget = 430000 * (WE / WEEK.totalWeeks);
  function trendArrow(curPct, prevPct, label) {
    const d = curPct - prevPct;
    const dir = d > 2 ? 'up' : d < -2 ? 'down' : 'flat';
    const sym = d > 2 ? '‚ñ≤' : d < -2 ? '‚ñº' : '‚ñ∂';
    const move = d > 2 ? 'Up' : d < -2 ? 'Down' : 'Flat';
    const prefix = label === 'Pipeline' ? 'P' : 'S';
    const tip = `${label} attainment: ${move} vs last week (${Math.round(prevPct)}% ‚Üí ${Math.round(curPct)}%)`;
    return `<span class="trend-tag ${dir}" title="${tip}">${prefix}${sym}</span>`;
  }
  // Compute previous-week (W4) regional totals from WEEK_HISTORY
  const prevW = WEEK_HISTORY.length >= 2 ? WEEK_HISTORY[WEEK_HISTORY.length - 2] : null;
  const regionBUs = { DACH:['DACH_ENT_OB','DACH_CORP_OB'], EMEA:['EMEA_OB'], AMER:['AMER_OB'], APJ:['APJ_OB'] };
  function regionFromWeek(w, r) {
    if (!w) return {pipe:0, saos:0};
    const bus = regionBUs[r] || [];
    const ibKey = 'IB_' + r;
    return {
      pipe: bus.reduce((s,b) => s + ((w[b]||{}).pipe||0), 0) + ((w[ibKey]||{}).pipe||0),
      saos: bus.reduce((s,b) => s + ((w[b]||{}).saos||0), 0) + ((w[ibKey]||{}).saos||0)
    };
  }
  document.getElementById('regionStrip').innerHTML = ['DACH','EMEA','AMER','APJ'].map(r => {
    const sdrs = SDRS.filter(s => s.region===r);
    // Pipeline & SAOs from authoritative snapshot (includes departed SDRs)
    const snap = snapshotTotal('R_' + r);
    const pipe = snap.pipe, saos = snap.saos;
    // Targets from active SDRs only (departed don't carry forward targets)
    const prT = sdrs.reduce((s,d)=>s+d.pipeTarget,0), saoT = sdrs.reduce((s,d)=>s+d.saoT,0);
    const att = prT>0?pipe/prT*100:0;
    const saoAtt = saoT>0?saos/saoT*100:0;
    const active = sdrs.filter(s=>s.acts!=null).length, onT = sdrs.filter(s=>s.onTrack).length;
    // Previous week from WEEK_HISTORY for consistent trend comparison
    const prev = regionFromWeek(prevW, r);
    const prevAtt = prT>0?prev.pipe/prT*100:0;
    const prevSaoAtt = saoT>0?prev.saos/saoT*100:0;
      const pipeSdr = active>0 ? Math.round(pipe/active) : 0;
      const pipeSdrPct = proRatedTarget>0 ? pipeSdr/proRatedTarget*100 : 0;
      return `<div class="region-card ${cls[r]}">
      <div class="region-name"><span>${r} (Allbound)</span><span style="display:flex;gap:4px;align-items:center">${trendArrow(att, prevAtt, 'Pipeline')} ${trendArrow(saoAtt, prevSaoAtt, 'SAO')}<span class="zone-tip" data-tip="P = Pipeline trend ¬∑ S = SAO trend (vs prior week)">?</span></span></div>
      <div style="font-size:11px;color:#94a3b8;margin-bottom:8px">${active} SDRs ¬∑ ${onT} on-track</div>
      <div class="region-stat"><span class="region-stat-label">Pipeline</span><span class="region-stat-val">${eurShort(pipe)} <span style="font-weight:400;color:#94a3b8">(${pct(att)})</span></span></div>
      <div class="region-stat"><span class="region-stat-label">SAO</span><span class="region-stat-val">${saos} <span style="font-weight:400;color:#94a3b8">(${pct(saoAtt)})</span></span></div>
      <div class="region-stat"><span class="region-stat-label">Pipe / SDR</span><span class="region-stat-val">${eurShort(pipeSdr)} <span style="font-weight:400;color:#94a3b8">(${pct(pipeSdrPct)})</span></span></div></div>`;
  }).join('');
}

// ============================================================
// 5. ZONE SUMMARY
// ============================================================
function renderZones() {
  const zones = [
    {k:'activity',   l:'Activity Gap',   c:'#dc2626', d:'Low volume ‚Äî needs more dials and outreach'},
    {k:'conversion', l:'Conversion Gap',  c:'#d97706', d:'High activity, low SAOs ‚Äî quality over quantity'},
    {k:'deal_size',  l:'Deal Size Gap',   c:'#d97706', d:'Good SAOs but pipeline value too low'},
    {k:'on_track',   l:'On Track',        c:'#65a30d', d:'Hitting both SAO and pipeline benchmarks'},
    {k:'exceeding',  l:'Exceeding',       c:'#16a34a', d:'Above target on pipeline and SAOs'},
    {k:'ramping',    l:'Ramping',          c:'#2563eb', d:'New or ramping ‚Äî building towards full capacity'},
  ];
  document.getElementById('zoneRow').innerHTML = zones.map(z => {
    const inZ = SDRS.filter(s => s.zone===z.k);
    return `<div class="zone-card" style="border-top:3px solid ${z.c}"><div class="zone-card-label" style="color:${z.c}">${z.l}<span class="zone-tip" data-tip="${z.d}">?</span></div><div class="zone-card-count" style="color:${z.c}">${inZ.length}</div><div class="zone-card-names">${inZ.map(s=>firstName(s.name)).join(', ')||'‚Äî'}</div></div>`;
  }).join('');
}

// ============================================================
// 6. DISTRIBUTION FILTERS
// ============================================================
let distBU = 'ALL', distRegion = null;
function getDistFiltered() {
  return SDRS.filter(s => {
    if (distRegion) return s.region === distRegion;
    if (distBU === 'ALL') return true;
    return s.bu === distBU;
  });
}

// ============================================================
// 6a. ACTIVITY BELL CURVE
// ============================================================
function renderBell() {
  const filtered = getDistFiltered().filter(s => s.weekly != null);
  const sorted = [...filtered].sort((a,b) => b.weekly - a.weekly);
  const canvas = document.getElementById('bellChart');
  const dpr = window.devicePixelRatio||1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*dpr; canvas.height=rect.height*dpr;
  canvas.style.width=rect.width+'px'; canvas.style.height=rect.height+'px';
  const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
  const W=rect.width, H=rect.height, pL=90, pR=60, pT=28, pB=50;
  const pW=W-pL-pR, pH=H-pT-pB;
  const barH = Math.min(Math.floor(pH / sorted.length) - 2, 16);
  const gap = Math.max(1, Math.floor((pH - barH * sorted.length) / (sorted.length + 1)));
  const maxVal = Math.max(...sorted.map(s=>s.weekly), 600) * 1.15;
  const xScale = pW / maxVal;
  const x350 = pL + 350 * xScale, x500 = pL + 500 * xScale;
  // Background zones
  ctx.fillStyle='rgba(220,38,38,0.04)';ctx.fillRect(pL,pT,x350-pL,pH);
  ctx.fillStyle='rgba(217,119,6,0.04)';ctx.fillRect(x350,pT,x500-x350,pH);
  ctx.fillStyle='rgba(22,163,74,0.04)';ctx.fillRect(x500,pT,pL+pW-x500,pH);
  // Threshold lines
  [{x:x350,c:'#dc2626',l:'350'},{x:x500,c:'#16a34a',l:'500'}].forEach(z=>{ctx.setLineDash([4,4]);ctx.strokeStyle=z.c;ctx.lineWidth=1.5;ctx.globalAlpha=0.5;ctx.beginPath();ctx.moveTo(z.x,pT);ctx.lineTo(z.x,pT+pH);ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;ctx.fillStyle=z.c;ctx.font="bold 10px 'DM Sans'";ctx.textAlign='center';ctx.fillText(z.l,z.x,pT+pH+26);});
  // Median line
  const sVals=[...filtered.map(s=>s.weekly)].sort((a,b)=>a-b), med=sVals[Math.floor(sVals.length/2)]||0;
  const medX=pL+med*xScale;
  ctx.setLineDash([6,3]);ctx.strokeStyle='#0f172a';ctx.lineWidth=2;ctx.globalAlpha=0.6;ctx.beginPath();ctx.moveTo(medX,pT);ctx.lineTo(medX,pT+pH);ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;ctx.fillStyle='#0f172a';ctx.font="bold 10px 'DM Sans'";ctx.textAlign='center';ctx.fillText('Median: '+med,medX,pT-8);
  // Bars
  sorted.forEach((s, i) => {
    const y = pT + gap + i * (barH + gap);
    const bw = Math.max(s.weekly * xScale, 2);
    const col = s.weekly >= 500 ? '#16a34a' : s.weekly >= 350 ? '#d97706' : '#dc2626';
    ctx.fillStyle = col; ctx.globalAlpha = 0.7;
    ctx.beginPath(); const r=3; ctx.moveTo(pL,y);ctx.lineTo(pL+bw-r,y);ctx.quadraticCurveTo(pL+bw,y,pL+bw,y+r);ctx.lineTo(pL+bw,y+barH-r);ctx.quadraticCurveTo(pL+bw,y+barH,pL+bw-r,y+barH);ctx.lineTo(pL,y+barH);ctx.closePath();ctx.fill();ctx.globalAlpha=1;
    // Name label
    ctx.fillStyle='#334155';ctx.font="500 9px 'DM Sans'";ctx.textAlign='right';
    ctx.fillText(shortName(s.name), pL-4, y+barH-3);
    // Value label
    ctx.fillStyle='#64748b';ctx.font="bold 9px 'DM Sans'";ctx.textAlign='left';
    ctx.fillText(s.weekly + '/wk', pL+bw+4, y+barH-3);
  });
  // Axis
  ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pL,pT+pH);ctx.lineTo(pL+pW,pT+pH);ctx.stroke();
  ctx.fillStyle='#94a3b8';ctx.font="500 9px 'DM Sans'";ctx.textAlign='center';
  for(let v=0;v<=maxVal;v+=200)ctx.fillText(v,pL+v*xScale,pT+pH+12);
  ctx.fillStyle='#64748b';ctx.font="600 10px 'DM Sans'";ctx.fillText('Activities per Week',pL+pW/2,pT+pH+42);
}

// ============================================================
// 6b. SAO ATTAINMENT DISTRIBUTION
// ============================================================
function renderSaoDist() {
  const filtered = getDistFiltered().filter(s => s.saoT > 0);
  const sorted = [...filtered].sort((a,b) => b.saoPct - a.saoPct);
  const canvas = document.getElementById('saoChart');
  const dpr = window.devicePixelRatio||1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*dpr; canvas.height=rect.height*dpr;
  canvas.style.width=rect.width+'px'; canvas.style.height=rect.height+'px';
  const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
  const W=rect.width, H=rect.height, pL=90, pR=60, pT=28, pB=50;
  const pW=W-pL-pR, pH=H-pT-pB;
  const barH = Math.min(Math.floor(pH / sorted.length) - 2, 16);
  const gap = Math.max(1, Math.floor((pH - barH * sorted.length) / (sorted.length + 1)));
  const maxPct = Math.max(...sorted.map(s => s.saoPct), 130) * 1.15;
  const xScale = pW / maxPct;
  const x50 = pL + 50 * xScale, x75 = pL + 75 * xScale, x100 = pL + 100 * xScale;
  // Background zones
  ctx.fillStyle='rgba(220,38,38,0.04)';ctx.fillRect(pL,pT,x50-pL,pH);
  ctx.fillStyle='rgba(217,119,6,0.04)';ctx.fillRect(x50,pT,x75-x50,pH);
  ctx.fillStyle='rgba(22,163,74,0.04)';ctx.fillRect(x75,pT,pL+pW-x75,pH);
  // 100% line
  ctx.setLineDash([6,3]);ctx.strokeStyle='#0f172a';ctx.lineWidth=1.5;ctx.globalAlpha=0.4;ctx.beginPath();ctx.moveTo(x100,pT);ctx.lineTo(x100,pT+pH);ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;ctx.fillStyle='#0f172a';ctx.font="bold 10px 'DM Sans'";ctx.textAlign='center';ctx.fillText('100%',x100,pT-8);
  // Threshold lines
  [{x:x50,c:'#dc2626',l:'50%'},{x:x75,c:'#d97706',l:'75%'}].forEach(z=>{ctx.setLineDash([3,3]);ctx.strokeStyle=z.c;ctx.lineWidth=1;ctx.globalAlpha=0.5;ctx.beginPath();ctx.moveTo(z.x,pT);ctx.lineTo(z.x,pT+pH);ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;});
  // Bars
  sorted.forEach((s, i) => {
    const y = pT + gap + i * (barH + gap);
    const bw = Math.max(Math.min(s.saoPct, maxPct) * xScale, 2);
    const col = s.saoPct >= 75 ? '#16a34a' : s.saoPct >= 50 ? '#d97706' : '#dc2626';
    ctx.fillStyle = col; ctx.globalAlpha = 0.7;
    ctx.beginPath(); const r=3; ctx.moveTo(pL,y);ctx.lineTo(pL+bw-r,y);ctx.quadraticCurveTo(pL+bw,y,pL+bw,y+r);ctx.lineTo(pL+bw,y+barH-r);ctx.quadraticCurveTo(pL+bw,y+barH,pL+bw-r,y+barH);ctx.lineTo(pL,y+barH);ctx.closePath();ctx.fill();ctx.globalAlpha=1;
    // Name label
    ctx.fillStyle='#334155';ctx.font="500 9px 'DM Sans'";ctx.textAlign='right';
    ctx.fillText(shortName(s.name), pL-4, y+barH-3);
    // Value label
    ctx.fillStyle='#64748b';ctx.font="bold 9px 'DM Sans'";ctx.textAlign='left';
    ctx.fillText(pct(s.saoPct)+' ('+s.saos+'/'+s.saoT+')', pL+bw+4, y+barH-3);
  });
  // Axis
  ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pL,pT+pH);ctx.lineTo(pL+pW,pT+pH);ctx.stroke();
  ctx.fillStyle='#94a3b8';ctx.font="500 9px 'DM Sans'";ctx.textAlign='center';
  for(let v=0;v<=maxPct;v+=25)ctx.fillText(v+'%',pL+v*xScale,pT+pH+14);
  ctx.fillStyle='#64748b';ctx.font="600 10px 'DM Sans'";ctx.fillText('SAO % of Individual Pro-rated Target',pL+pW/2,pT+pH+38);
}

// ============================================================
// 6c. PIPELINE ATTAINMENT DISTRIBUTION
// ============================================================
function renderPipeDist() {
  const filtered = getDistFiltered().filter(s => s.pipeTarget > 0);
  const canvas = document.getElementById('pipeChart');
  const dpr = window.devicePixelRatio||1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*dpr; canvas.height=rect.height*dpr;
  canvas.style.width=rect.width+'px'; canvas.style.height=rect.height+'px';
  const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height,pL=90,pR=50,pT=28,pB=50;
  const pW=W-pL-pR, pH=H-pT-pB;
  const sorted = [...filtered].sort((a,b) => b.pipePct - a.pipePct);
  const barH = Math.min(Math.floor(pH / sorted.length) - 2, 16);
  const gap = Math.max(1, Math.floor((pH - barH * sorted.length) / (sorted.length + 1)));
  const maxPct = Math.max(...sorted.map(s => s.pipePct), 220) * 1.15;
  const xScale = pW / maxPct;
  const x50 = pL + 50 * xScale, x90 = pL + 90 * xScale, x100 = pL + 100 * xScale;
  ctx.fillStyle='rgba(220,38,38,0.04)';ctx.fillRect(pL,pT,x50-pL,pH);
  ctx.fillStyle='rgba(217,119,6,0.04)';ctx.fillRect(x50,pT,x90-x50,pH);
  ctx.fillStyle='rgba(22,163,74,0.04)';ctx.fillRect(x90,pT,pL+pW-x90,pH);
  ctx.setLineDash([6,3]);ctx.strokeStyle='#0f172a';ctx.lineWidth=1.5;ctx.globalAlpha=0.4;ctx.beginPath();ctx.moveTo(x100,pT);ctx.lineTo(x100,pT+pH);ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;ctx.fillStyle='#0f172a';ctx.font="bold 10px 'DM Sans'";ctx.textAlign='center';ctx.fillText('100%',x100,pT-8);
  [{x:x50,c:'#dc2626',l:'50%'},{x:x90,c:'#d97706',l:'90%'}].forEach(z=>{ctx.setLineDash([3,3]);ctx.strokeStyle=z.c;ctx.lineWidth=1;ctx.globalAlpha=0.5;ctx.beginPath();ctx.moveTo(z.x,pT);ctx.lineTo(z.x,pT+pH);ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;});
  sorted.forEach((s, i) => {
    const y = pT + gap + i * (barH + gap);
    const bw = Math.max(Math.min(s.pipePct, maxPct) * xScale, 2);
    const col = s.pipePct >= 90 ? '#16a34a' : s.pipePct >= 50 ? '#d97706' : '#dc2626';
    ctx.fillStyle = col; ctx.globalAlpha = 0.7;
    ctx.beginPath(); const r=3; ctx.moveTo(pL,y);ctx.lineTo(pL+bw-r,y);ctx.quadraticCurveTo(pL+bw,y,pL+bw,y+r);ctx.lineTo(pL+bw,y+barH-r);ctx.quadraticCurveTo(pL+bw,y+barH,pL+bw-r,y+barH);ctx.lineTo(pL,y+barH);ctx.closePath();ctx.fill();ctx.globalAlpha=1;
    ctx.fillStyle='#334155';ctx.font="500 9px 'DM Sans'";ctx.textAlign='right';
    ctx.fillText(shortName(s.name), pL-4, y+barH-3);
    ctx.fillStyle='#64748b';ctx.font="bold 9px 'DM Sans'";ctx.textAlign='left';
    ctx.fillText(pct(s.pipePct)+' ('+eurShort(s.pipe)+')', pL+bw+4, y+barH-3);
  });
  ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pL,pT+pH);ctx.lineTo(pL+pW,pT+pH);ctx.stroke();ctx.fillStyle='#94a3b8';ctx.font="500 9px 'DM Sans'";ctx.textAlign='center';for(let v=0;v<=maxPct;v+=25)ctx.fillText(v+'%',pL+v*xScale,pT+pH+14);ctx.fillStyle='#64748b';ctx.font="600 10px 'DM Sans'";ctx.fillText('Pipeline % of Individual Pro-rated Target',pL+pW/2,pT+pH+38);
}

// ============================================================
// 7. SDR TABLE (filtered)
// ============================================================
let currentBU = 'ALL', currentRegion = null, currentSDR = null;
let sortCol = 'pipePct', sortDir = -1;

function getFiltered() {
  return SDRS.filter(s => {
    if (currentSDR) return s.name === currentSDR;
    if (currentRegion) return s.region === currentRegion;
    if (currentBU === 'ALL') return true;
    return s.bu === currentBU;
  });
}

function populateIndivSDRSelect() {
  const sel = document.getElementById('indivSDRSelect');
  if (currentBU === 'ALL' && !currentRegion) {
    sel.innerHTML = '<option value="">Select Business Unit or Region first</option>';
    return;
  }
  const pool = SDRS.filter(s => {
    if (currentRegion) return s.region === currentRegion;
    return s.bu === currentBU;
  }).sort((a,b) => a.name.localeCompare(b.name));
  sel.innerHTML = '<option value="">All in ' + (currentRegion || currentBU.replace(/_/g,' ')) + '</option>' + pool.map(s => '<option value="'+s.name+'">'+s.name+'</option>').join('');
}

function renderTable() {
  const filtered = getFiltered();
  document.getElementById('sdrCount').textContent = filtered.length + ' SDRs shown';
  const cols = [
    {k:'name',l:'SDR',w:'190px'},
    {k:'saoPct',l:'SAO',w:'95px'},
    {k:'pipePct',l:'Pipeline',w:'95px'},
    {k:'weekly',l:'Activity',w:'95px'},
    {k:'efficiency',l:'Efficiency',w:'95px',title:'Activities per SAO ‚Äî lower is better'},
    {k:'zone',l:'Status',w:'95px'}
  ];
  document.getElementById('sdrHead').innerHTML = cols.map(c =>
    `<th style="width:${c.w}" data-sort="${c.k}"${c.title?' title="'+c.title+'"':''}>${c.l}${sortCol===c.k?(sortDir===-1?' ‚ñº':' ‚ñ≤'):''}</th>`
  ).join('');
  const sorted = [...filtered].sort((a,b) => {
    let av=a[sortCol],bv=b[sortCol]; if(av==null)av=-Infinity;if(bv==null)bv=-Infinity;
    if(typeof av==='string') return sortDir*av.localeCompare(bv);
    return sortDir*(av-bv);
  });
  // Median efficiency for directional indicator
  const effVals = filtered.filter(s=>s.efficiency!=null).map(s=>s.efficiency).sort((a,b)=>a-b);
  const medEff = effVals.length ? effVals[Math.floor(effVals.length/2)] : null;

  // WoW trend micro-arrow helper
  function wowArrow(cur, prev) {
    if (cur == null || prev == null) return '';
    const d = cur - prev;
    if (d > 0) return ' <span style="font-size:9px;color:#16a34a" title="Up WoW">‚ñ≤</span>';
    if (d < 0) return ' <span style="font-size:9px;color:#dc2626" title="Down WoW">‚ñº</span>';
    return ' <span style="font-size:9px;color:#94a3b8" title="Flat WoW">‚ñ∂</span>';
  }

  document.getElementById('sdrBody').innerHTML = sorted.map(s => {
    // Compute WoW trends from weekly history (lookback to last non-zero week)
    const wh = SDR_WEEK_HISTORY[s.name];
    let pipeTrend = '';
    if (wh && wh.length >= 2) {
      const cur = wh[wh.length - 1];
      let prev = null;
      for (let i = wh.length - 2; i >= 0; i--) { if (wh[i] > 0) { prev = wh[i]; break; } }
      if (prev != null) pipeTrend = wowArrow(cur, prev);
    }
    // SAO & Activity trends ‚Äî activate when history arrays are populated
    const saoTrend = s._saoThisWk != null ? wowArrow(s._saoThisWk, s._saoLastWk) : '';
    const actTrend = s._actThisWk != null ? wowArrow(s._actThisWk, s._actLastWk) : '';
    // Efficiency: no directional arrow (ratio of two metrics already showing arrows)
    const effTrend = '';
    // SAO cell RAG
    const saoRag = s.saoPct >= 100 ? 'green' : s.saoPct >= 75 ? 'lime' : s.saoPct >= 50 ? 'amber' : 'red';
    const saoCol = {green:'#16a34a',lime:'#65a30d',amber:'#d97706',red:'#dc2626'}[saoRag];
    // Pipeline cell RAG
    const pipeRag = s.pipePct >= 90 ? 'green' : s.pipePct >= 50 ? 'amber' : 'red';
    const pipeCol = {green:'#16a34a',amber:'#d97706',red:'#dc2626'}[pipeRag];
    // Activity RAG cell
    const actRag = s.weekly==null ? null : s.weekly>=500 ? 'green' : s.weekly>=350 ? 'amber' : 'red';
    const actCol = {green:'#16a34a',amber:'#d97706',red:'#dc2626'}[actRag]||'#94a3b8';
    // Efficiency RAG cell (lower is better ‚Äî vs median)
    const effRag = s.efficiency!=null && medEff!=null ? (s.efficiency <= medEff*0.85 ? 'green' : s.efficiency <= medEff*1.3 ? 'amber' : 'red') : null;
    const effCol = {green:'#16a34a',amber:'#d97706',red:'#dc2626'}[effRag]||'#94a3b8';
    const effLabel = s.efficiency!=null && medEff!=null ? (s.efficiency <= medEff*0.85 ? 'Efficient' : s.efficiency <= medEff*1.3 ? 'Average' : 'Review') : '';
    // Zone
    const zc=zoneColor(s.zone),zb=zoneBg(s.zone),zbd=zoneBorder(s.zone);
    // Type badge
    const typeBadge = s.type==='Ramp' ? 'sdr-badge-ramp' : 'sdr-badge-full';

    return `<tr>
      <td>
        <span class="sdr-name-cell">${s.name}</span>
        <div class="sdr-badges">
          <span class="sdr-badge sdr-badge-seg">${s.seg}</span>
          <span class="sdr-badge ${typeBadge}">${s.type}</span>
          ${currentBU==='ALL'&&!currentRegion?'<span class="sdr-badge sdr-badge-region">'+s.region+'</span>':''}
        </div>
      </td>
      <td><div class="rag-cell rag-cell-${saoRag}"><div class="rag-val" style="color:${saoCol}">${pct(s.saoPct)}${saoTrend}</div><div class="rag-sub">${s.saos} / ${s.saoT}</div></div></td>
      <td><div class="rag-cell rag-cell-${pipeRag}"><div class="rag-val" style="color:${pipeCol}">${pct(s.pipePct)}${pipeTrend}</div><div class="rag-sub">${eurShort(s.pipe)} of ${eurShort(s.pipeTarget)}</div></div></td>
      <td><div class="rag-cell ${actRag?'rag-cell-'+actRag:''}"><div class="rag-val" style="color:${actCol}">${s.weekly!=null?s.weekly:'‚Äî'}${actTrend}</div><div class="rag-sub">${s.weekly!=null?'per week':'No data'}</div></div></td>
      <td><div class="rag-cell ${effRag?'rag-cell-'+effRag:''}"><div class="rag-val" style="color:${effCol}">${s.efficiency!=null?s.efficiency:'‚Äî'}${effTrend}</div><div class="rag-sub">${effLabel||'acts / SAO'}</div></div></td>
      <td><span class="tag" style="color:${zc};background:${zb};border:1px solid ${zbd}">${zoneLabel(s.zone)}</span></td>
    </tr>`;
  }).join('');
  document.querySelectorAll('#sdrHead th').forEach(th => {
    th.onclick = () => { const k=th.dataset.sort; if(sortCol===k)sortDir*=-1; else{sortCol=k;sortDir=-1;} renderTable(); renderAnalysis(); };
  });
}

// ============================================================
// 8. DYNAMIC ANALYSIS SECTION
// ============================================================
function renderAnalysis() {
  const filtered = getFiltered();
  const box = document.getElementById('analysisBox');
  if (filtered.length === 0) { box.innerHTML = '<div class="analysis-title"><span class="icon">üìä</span>No SDRs in view</div>'; return; }

  const activePipe = filtered.reduce((s,d)=>s+d.pipe,0);
  const tTarget = filtered.reduce((s,d)=>s+d.pipeTarget,0);
  const tSAOT = filtered.reduce((s,d)=>s+d.saoT,0);

  // Determine scope early
  const isGlobal = (!currentBU || currentBU === 'ALL') && !currentRegion;

  // Headline totals from snapshot (includes departed SDR contributions)
  let snapScope = 'GLOBAL';
  if (currentBU && currentBU !== 'ALL') snapScope = currentBU;
  else if (currentRegion) snapScope = 'R_' + currentRegion;
  const snapTotals = snapshotTotal(snapScope);
  const tPipe = snapTotals.pipe;
  const tSAO = snapTotals.saos;

  // Departed contribution = snapshot minus active SDRS for this scope
  const deptPipe = Math.max(0, tPipe - activePipe);
  const deptSaos = Math.max(0, tSAO - filtered.reduce((s,d)=>s+d.saos,0));

  const pAtt = tTarget>0?tPipe/tTarget*100:0;
  const sAtt = tSAOT>0?tSAO/tSAOT*100:0;
  const active = filtered.filter(s=>s.acts!=null);
  const onTrack = filtered.filter(s=>s.onTrack);
  const inActivity = filtered.filter(s=>s.zone==='activity');
  const inConversion = filtered.filter(s=>s.zone==='conversion');
  const inDealSize = filtered.filter(s=>s.zone==='deal_size');
  const inExceeding = filtered.filter(s=>s.zone==='exceeding');
  const inRamping = filtered.filter(s=>s.zone==='ramping');
  const inOnTrack = filtered.filter(s=>s.zone==='on_track');
  const topPipe = [...filtered].sort((a,b)=>b.pipePct-a.pipePct);
  const botPipe = [...filtered].sort((a,b)=>a.pipePct-b.pipePct);
  const gapTotal = Math.max(0, tTarget - tPipe);
  const weeksLeft = WEEK.weeksRemaining;
  const weeklyNeeded = weeksLeft>0?Math.round(gapTotal/weeksLeft):0;

  // Title
  let title = 'Global Analysis';
  let mgrNote = '';
  if (currentBU && currentBU !== 'ALL') {
    const m = BU_META[currentBU];
    title = m.label + ' Analysis';
    mgrNote = `Manager: ${m.managers.join(', ')}`;
  }
  if (currentRegion) { title = currentRegion + ' Allbound Analysis'; }

  // Build analysis paragraphs
  let html = `<div class="analysis-title"><span class="icon">üìä</span>${title}</div>`;
  if (mgrNote) html += `<div style="font-size:11px;color:#64748b;margin-bottom:10px">${mgrNote}</div>`;
  html += '<div class="analysis-body">';

  // ‚îÄ‚îÄ 1. Pipeline Health ‚îÄ‚îÄ
  const healthClass = pAtt >= 90 ? 'good' : pAtt >= 60 ? 'warn' : 'risk';
  const healthLabel = pAtt >= 90 ? 'On-track' : pAtt >= 60 ? 'At risk' : 'Off-track';
  html += `<h4>Pipeline Health</h4>`;
  html += `<div class="callout ${healthClass}"><strong>${healthLabel}:</strong> ${eurShort(tPipe)} delivered against ${eurShort(tTarget)} pro-rated target (${pct(pAtt)} attainment). The team needs ${eurShort(gapTotal)} more pipeline across the remaining ${weeksLeft} weeks, requiring roughly ${eurShort(weeklyNeeded)}/week to close the gap.</div>`;

  // ‚îÄ‚îÄ Quarter Trajectory (projection against actual Q1 target) ‚îÄ‚îÄ
  const WE = WEEK.weeksElapsed;
  const TW = WEEK.totalWeeks;
  if (WE >= 2) {
    // tPipe already includes departed pipeline for the current scope
    const weeklyRate = Math.round(tPipe / WE);
    const projected = weeklyRate * TW;
    // Use actual Q1 targets (seasonality-weighted) not linear extrapolation
    const fullQTarget = filtered.reduce((s,d) => s + (d.pipeQ1 || 0), 0);
    const projPct = fullQTarget > 0 ? projected / fullQTarget * 100 : 0;
    const remainingNeeded = Math.max(0, fullQTarget - tPipe);
    const weeklyToClose = weeksLeft > 0 ? Math.round(remainingNeeded / weeksLeft) : 0;
    const projClass = projPct >= 90 ? 'good' : projPct >= 70 ? 'warn' : 'risk';
    html += `<h4>Quarter Trajectory</h4>`;
    html += `<div class="callout ${projClass}">At the current weekly run rate of ${eurShort(weeklyRate)}/week, the team is on pace to finish at <strong>${eurShort(projected)}</strong> (${pct(projPct)} of full Q1 target of ${eurShort(fullQTarget)}). To hit the full quarter, the remaining ${weeksLeft} weeks need to average <strong>${eurShort(weeklyToClose)}/week</strong> (${weeklyRate > 0 ? pct(weeklyToClose / weeklyRate * 100) : 'N/A'} of current pace). ${projPct >= 90 ? 'Current trajectory meets target if the pace holds.' : projPct >= 70 ? 'An acceleration is needed, but the gap is closeable. Targets are designed to ramp alongside new hires coming online, so the weekly ask naturally increases through the quarter.' : 'The gap is expected by design: Q1 targets are back-loaded (March is 43% of Q1) to align with new hires ramping into production. Being at ' + pct(pAtt) + ' of pro-rated target means the existing team is broadly on pace for what has been asked of them so far. Closing the full quarter depends on hiring velocity and ramp SDRs converting.'}</div>`; 
  }

  // ‚îÄ‚îÄ 2. SAO Attainment ‚îÄ‚îÄ
  html += `<h4>SAO Attainment</h4>`;
  html += `<p>${tSAO} SAO against ${tSAOT} pro-rated target (${pct(sAtt)}). ${onTrack.length} of ${filtered.length} SDRs are on-track (\u226575% attainment). ${sAtt >= 85 ? 'SAO volume is healthy, suggesting the pipeline gap is a deal-size challenge rather than a volume problem.' : sAtt >= 60 ? 'SAO generation is building but needs to accelerate to keep the pipeline funnel healthy.' : 'SAO volume is significantly below target and needs urgent attention alongside pipeline.'}</p>`;

  // ‚îÄ‚îÄ NEW: Efficiency Trend (pipeline per 1,000 activities) ‚îÄ‚îÄ
  // Uses activePipe (excluding departed) because their activities are not in the total
  const totalActs = filtered.reduce((s,d) => s + (d.acts || 0), 0);
  const currentEfficiency = totalActs > 0 ? Math.round(activePipe / totalActs * 1000) : 0;
  // Previous efficiency from PREV_WEEK
  const prevTotalActs = PREV_WEEK.totalActs || 0;
  const prevTotalPipe = PREV_WEEK.totalPipe || 0;
  if (totalActs > 0) {
    html += `<h4>Efficiency</h4>`;
    let effTrend = '';
    if (prevTotalActs > 0 && isGlobal) {
      const prevEff = Math.round(prevTotalPipe / prevTotalActs * 1000);
      const effDelta = currentEfficiency - prevEff;
      const effDir = effDelta > 0 ? 'up' : effDelta < 0 ? 'down' : 'flat';
      effTrend = effDir === 'up'
        ? ` This is up from ${eurShort(prevEff)}/1k last week (+${eurShort(effDelta)}), indicating improving conversion quality.`
        : effDir === 'down'
        ? ` This is down from ${eurShort(prevEff)}/1k last week (${eurShort(effDelta)}), suggesting activity is increasing faster than pipeline output.`
        : ` Unchanged from last week.`;
    }
    html += `<p>The team is generating <strong>${eurShort(currentEfficiency)} pipeline per 1,000 activities</strong>.${effTrend} ${currentEfficiency >= 5000 ? 'Strong efficiency. Conversations are landing well.' : currentEfficiency >= 2500 ? 'Moderate efficiency. There is room to improve conversion quality alongside volume.' : 'Low efficiency. Activity is high relative to pipeline output, which points to a targeting or messaging gap at the team level.'}</p>`;
  }

  // ‚îÄ‚îÄ 3. Top Performers + Concentration Risk ‚îÄ‚îÄ
  if (topPipe.length > 0) {
    html += `<h4>Carrying the Number</h4>`;
    const tp = topPipe.filter(s => s.pipePct >= 75).slice(0, 3);
    if (tp.length > 0) {
      html += `<div class="callout good">${tp.map(s => `<strong>${s.name}</strong> at ${pct(s.pipePct)} pipeline / ${pct(s.saoPct)} SAO`).join(' \u00b7 ')}</div>`;
      const topContrib = tp.reduce((s,d)=>s+d.pipe,0);
      const concPct = tPipe>0?topContrib/tPipe*100:0;
      if (concPct > 50 && filtered.length > 3) {
        html += `<p style="color:#d97706">\u26a0\ufe0f Concentration risk: top ${tp.length} contribute ${pct(concPct)} of total pipeline. If any of these SDRs stall, the gap widens quickly.</p>`;
      }
    } else {
      html += `<p>No SDR has reached 75% of their pipeline target yet. Broad acceleration needed.</p>`;
    }
  }

  // ‚îÄ‚îÄ NEW: Departed Pipeline Dependency ‚îÄ‚îÄ
  // Only count BUs where departed SDRs added pipeline (positive gap)
  const positiveDeparted = Object.entries(DEPARTED).filter(([bu, d]) => d.pipe > 0);
  const totalDepartedPipe = positiveDeparted.reduce((s,[,d]) => s + d.pipe, 0);
  const totalDepartedSaos = positiveDeparted.reduce((s,[,d]) => s + Math.max(0, d.saos), 0);
  if (isGlobal && totalDepartedPipe > 0) {
    const deptPct = tPipe > 0 ? totalDepartedPipe / tPipe * 100 : 0;
    html += `<h4>Departed Pipeline Dependency</h4>`;
    html += `<div class="callout warn">${eurShort(totalDepartedPipe)} pipeline and ${totalDepartedSaos} SAOs (${pct(deptPct)} of total pipeline) were generated by SDRs who have since been promoted or left the team. This pipeline will not regenerate next quarter. Breakdown: ${positiveDeparted.map(([bu, d]) => `${BU_META[bu] ? BU_META[bu].label : bu}: ${eurShort(d.pipe)}`).join(', ')}.</div>`;
  } else if (currentBU && DEPARTED[currentBU] && DEPARTED[currentBU].pipe > 0) {
    const deptBU = DEPARTED[currentBU];
    const deptPctBU = tPipe > 0 ? deptBU.pipe / tPipe * 100 : 0;
    html += `<h4>Departed Pipeline Dependency</h4>`;
    html += `<div class="callout warn">${eurShort(deptBU.pipe)} pipeline and ${Math.max(0, deptBU.saos)} SAOs (${pct(deptPctBU)} of BU pipeline) were generated by SDRs who have since moved on. This is non-recurring and will create a gap in Q2 if not replaced by new production.</div>`;
  }

  // ‚îÄ‚îÄ NEW: BU Pacing Comparison (global view only) ‚îÄ‚îÄ
  if (isGlobal) {
    html += `<h4>BU Pacing</h4>`;
    const buPacing = Object.keys(BU_META).map(bu => {
      const buSDRs = SDRS.filter(s => s.bu === bu);
      const buPipe = SNAPSHOT_LATEST[bu] ? SNAPSHOT_LATEST[bu].pipe : 0;
      const buSaos = SNAPSHOT_LATEST[bu] ? SNAPSHOT_LATEST[bu].saos : 0;
      const buTarget = buSDRs.reduce((s,d) => s + d.pipeTarget, 0);
      const buAtt = buTarget > 0 ? buPipe / buTarget * 100 : 0;
      const activeCount = buSDRs.length;
      const hcTarget = BU_META[bu].hcTarget;
      return { bu, label: BU_META[bu].label, att: buAtt, activeCount, hcTarget, pipe: buPipe, target: buTarget };
    }).sort((a,b) => b.att - a.att);

    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0">';
    buPacing.forEach(b => {
      const col = b.att >= 90 ? '#16a34a' : b.att >= 60 ? '#d97706' : '#dc2626';
      const bg = b.att >= 90 ? '#f0fdf4' : b.att >= 60 ? '#fffbeb' : '#fef2f2';
      html += `<div style="background:${bg};border-left:3px solid ${col};padding:6px 10px;border-radius:0 6px 6px 0;font-size:11px">
        <strong>${b.label}</strong><br>
        <span style="color:${col};font-weight:600">${pct(b.att)}</span> attainment \u00b7 ${b.activeCount}/${b.hcTarget} seats filled \u00b7 ${eurShort(b.pipe)} pipeline
      </div>`;
    });
    html += '</div>';

    const topBU = buPacing[0];
    const botBU = buPacing[buPacing.length - 1];
    if (topBU && botBU && buPacing.length > 1) {
      html += `<p>${topBU.label} leads at ${pct(topBU.att)} attainment. ${botBU.label} is the furthest behind at ${pct(botBU.att)}${botBU.activeCount < botBU.hcTarget ? `, compounded by only ${botBU.activeCount} of ${botBU.hcTarget} seats being filled` : ''}.</p>`;
    }
  }

  // ‚îÄ‚îÄ NEW: Hiring Gap Cost ‚îÄ‚îÄ
  if (isGlobal || (currentBU && currentBU !== 'ALL')) {
    let scopeBUs = isGlobal ? Object.keys(BU_META) : [currentBU];
    let totalHCTarget = 0, totalActive = 0;
    const buGaps = [];
    scopeBUs.forEach(bu => {
      const meta = BU_META[bu];
      const activeInBU = SDRS.filter(s => s.bu === bu).length;
      const gap = meta.hcTarget - activeInBU;
      totalHCTarget += meta.hcTarget;
      totalActive += activeInBU;
      if (gap > 0) buGaps.push({ label: meta.label, gap, hcTarget: meta.hcTarget, active: activeInBU });
    });
    const totalGap = totalHCTarget - totalActive;
    if (totalGap > 0) {
      // Estimate pipeline capacity per seat using current performers
      const fullSDRs = filtered.filter(s => s.type === 'Full' && s.pipe > 0);
      const avgPipePerFull = fullSDRs.length > 0 ? Math.round(fullSDRs.reduce((s,d) => s + (d.pipeQ1 || 0), 0) / fullSDRs.length) : 0;
      const lostCapacity = avgPipePerFull * totalGap;

      html += `<h4>Hiring Gap</h4>`;
      html += `<div class="callout risk"><strong>${totalGap} unfilled seats</strong> (${totalActive} of ${totalHCTarget} target). `;
      if (avgPipePerFull > 0) {
        html += `At the average full-quota target of ${eurShort(avgPipePerFull)}/SDR, these empty seats represent an estimated <strong>${eurShort(lostCapacity)} pipeline capacity gap</strong> this quarter. `;
      }
      html += `Gaps by BU: ${buGaps.sort((a,b) => b.gap - a.gap).map(g => `${g.label} (${g.gap} open, ${g.active}/${g.hcTarget})`).join(', ')}.</div>`;

      // Flag most critical
      const biggest = buGaps.sort((a,b) => b.gap - a.gap)[0];
      if (biggest && biggest.gap >= 3) {
        html += `<p style="color:#dc2626">${biggest.label} is the most critical hiring gap with ${biggest.gap} open seats. Every week these remain unfilled erodes pipeline capacity that cannot be recovered in-quarter.</p>`;
      }
    }
  }

  // ‚îÄ‚îÄ NEW: Ramp Cohort Forecast ‚îÄ‚îÄ
  if (inRamping.length > 0) {
    const rampTotalTarget = inRamping.reduce((s,d) => s + d.pipeTarget, 0);
    const rampCurrentPipe = inRamping.reduce((s,d) => s + d.pipe, 0);
    const rampSAOs = inRamping.reduce((s,d) => s + d.saos, 0);
    // Estimate full-quarter contribution: extrapolate current ramp targets to what full quota would be
    const fullSDRs = filtered.filter(s => s.type === 'Full');
    const avgFullTarget = fullSDRs.length > 0 ? Math.round(fullSDRs.reduce((s,d) => s + (d.pipeQ1 || 0), 0) / fullSDRs.length) : 0;
    const projectedFullContrib = avgFullTarget * inRamping.length;

    html += `<h4>Ramp Cohort</h4>`;
    html += `<div class="callout" style="border-left-color:#2563eb;background:#eff6ff">${inRamping.length} SDRs are on ramp targets totalling ${eurShort(rampTotalTarget)} this quarter (${eurShort(rampCurrentPipe)} delivered so far, ${rampSAOs} SAO). `;
    if (avgFullTarget > 0) {
      html += `Once at full quota, this cohort represents an estimated <strong>${eurShort(projectedFullContrib)} additional pipeline capacity per quarter</strong>. `;
    }
    html += `Ramp SDRs: ${inRamping.map(s => `${s.name} (${eurShort(s.pipe)}/${eurShort(s.pipeTarget)})`).join(', ')}.</div>`;

    // Flag any struggling ramp SDRs
    const rampStruggling = inRamping.filter(s => s.saos === 0 && (s.weekly || 0) < 100);
    if (rampStruggling.length > 0) {
      html += `<p style="color:#d97706">${rampStruggling.map(s => s.name).join(', ')} ${rampStruggling.length === 1 ? 'is' : 'are'} on ramp with very low activity and no SAO. Check onboarding milestone completion and consider whether additional support or buddy pairing is needed.</p>`;
    }
  }

  // ‚îÄ‚îÄ 4. Zone Concerns ‚îÄ‚îÄ
  const needsAttention = [...inActivity, ...inConversion, ...inDealSize];
  if (inActivity.length > 0) {
    html += `<h4>\ud83d\udd34 Activity Gap (${inActivity.length})</h4>`;
    html += `<div class="callout risk">${inActivity.map(s => `<strong>${s.name}</strong>: ${s.weekly||0} acts/wk, ${pct(s.saoPct)} SAO, ${pct(s.pipePct)} pipeline`).join('<br>')}</div>`;
    html += `<p>Priority for manager 1:1s and call-listening sessions. Address confidence, time management, or motivation barriers. Protect prospecting hours.</p>`;
  }
  if (inConversion.length > 0) {
    html += `<h4>\u26a0\ufe0f Conversion Gap (${inConversion.length})</h4>`;
    html += `<div class="callout warn">${inConversion.map(s => `<strong>${s.name}</strong>: ${s.weekly||0} acts/wk, ${pct(s.saoPct)} SAO, ${pct(s.pipePct)} pipeline`).join('<br>')}</div>`;
    html += `<p>Activity is present but not converting. Review call quality, qualification approach, and STRATEGIC framework execution.</p>`;
  }
  if (inDealSize.length > 0) {
    html += `<h4>\u26a0\ufe0f Deal Size Gap (${inDealSize.length})</h4>`;
    html += `<div class="callout warn">${inDealSize.map(s => `<strong>${s.name}</strong>: ${pct(s.saoPct)} SAO but ${pct(s.pipePct)} pipeline (${eurShort(s.pipe)})`).join('<br>')}</div>`;
    html += `<p>Creating opportunities but deal values are too small. Managers should probe two root causes: first, whether reps are genuinely targeting smaller accounts (fix the account list); second, whether forecasted values are being low-balled at SAO creation. Under-forecasting has been an organisational pattern, so managers should cross-check rep estimates against historical average deal sizes for the segment before accepting the value.</p>`;
  }

  // ‚îÄ‚îÄ 5. Activity Pattern ‚îÄ‚îÄ
  const medianAct = [...active].map(s=>s.weekly).sort((a,b)=>a-b);
  const medVal = medianAct[Math.floor(medianAct.length/2)] || 0;
  html += `<h4>Activity Pattern</h4>`;
  html += `<p>Median weekly activity: ${medVal}/week (target: 500). ${medVal >= 500 ? 'Team is at target pace.' : medVal >= 350 ? 'Building but needs another 30\u201340% increase to reach sustainable levels.' : 'Significantly below target. This is the single biggest lever for improvement.'} ${active.filter(s=>(s.weekly||0)>=500).length} of ${active.length} SDRs are above the 500/week threshold.</p>`;

  // ‚îÄ‚îÄ 6. Next Week Focus ‚îÄ‚îÄ
  html += `<h4>Week ${WE + 1} Focus</h4>`;
  const priorities = [];
  if (pAtt < 70) priorities.push('Pipeline acceleration is the top priority. Every coaching conversation should include pipeline target gap and a plan to close it.');
  if (inActivity.length >= filtered.length * 0.3) priorities.push(`${inActivity.length} SDRs with an activity gap. Consider a team activity sprint or targeted call blitz to build momentum.`);
  if (inConversion.length > 0) priorities.push(`${inConversion.length} SDRs with a conversion gap. Prioritise call quality reviews and STRATEGIC framework coaching.`);
  if (inDealSize.length > 0) priorities.push('Address deal-size gap for SDRs hitting SAO but underdelivering on pipeline value.');
  if (medVal < 350) priorities.push('Activity levels need immediate uplift. Protect prospecting hours and reduce meeting overhead.');
  const totalGapCheck = Object.keys(BU_META).reduce((s, bu) => s + BU_META[bu].hcTarget - SDRS.filter(d => d.bu === bu).length, 0);
  if (totalGapCheck >= 10) priorities.push(`Hiring remains critical with ${totalGapCheck} open seats. Escalate recruiting timelines where possible.`);
  if (inRamping.length >= 3) priorities.push(`${inRamping.length} SDRs ramping. Ensure onboarding cadence is tight and managers have time allocated for ramp coaching.`);
  if (priorities.length === 0) priorities.push('Maintain current trajectory and focus on moving On Track SDRs into Exceeding.');
  html += `<p>${priorities.join(' ')}</p>`;

  html += '</div>';
  box.innerHTML = html;
}

// ============================================================
// 9. COACHING FOCUS MATRIX
// ============================================================
function renderCoaching() {
  const box = document.getElementById('coachingMatrix');
  const filtered = getFiltered();
  if (filtered.length === 0) { box.innerHTML = ''; return; }
  document.getElementById('coachingSub').textContent = `Personalised development focus for Week ${WEEK.weeksElapsed} \u00b7 updates weekly based on data, activity trends, and quarter phase`;

  const WE = WEEK.weeksElapsed;
  const WR = WEEK.weeksRemaining;
  const WN = WEEK.number;

  // Quarter phase: early (1-4), mid (5-9), late (10-13)
  const phase = WE <= 4 ? 'early' : WE <= 9 ? 'mid' : 'late';

  // Generate coaching data per SDR
  function coachData(s) {
    const w = s.weekly || 0;
    const avgDeal = s.saos > 0 ? Math.round(s.pipe / s.saos) : 0;
    const wiz = s.weeksInZone || 1;

    // --- Layer 2: Activity trend opener ---
    let trend = '';
    if (s.actTrend) {
      const t = s.actTrend;
      if (t.deltaPct >= 20) trend = `Activity stepped up last week (${t.lastWk} vs ${t.avgWk} avg, +${t.deltaPct}%). Great momentum. `;
      else if (t.deltaPct <= -20) trend = `Activity dipped last week (${t.lastWk} vs ${t.avgWk} avg, ${t.deltaPct}%). Worth checking what got in the way. `;
      else trend = `Activity was steady last week (${t.lastWk} vs ${t.avgWk} avg). `;
    }

    // --- Layer 3: Pipeline maths ---
    let pipeMaths = '';
    if (s.zone !== 'exceeding' && s.zone !== 'ramping' && WR > 0) {
      if (s.pipeGap > 0) {
        pipeMaths = ` You need ${eurShort(s.pipeGap)} more pipeline across the remaining ${WR} weeks (roughly ${eurShort(s.pipeWeeklyNeeded)}/week).`;
      } else {
        pipeMaths = ` You've already cleared your pipeline target ‚Äî excellent position.`;
      }
    }

    // --- Layer 5: Weeks-in-zone escalation prefix ---
    let escalation = '';
    if (wiz >= 4 && ['activity','conversion','deal_size'].includes(s.zone)) {
      escalation = `This is week ${wiz} in this zone. The pattern has persisted, so it's time to try something different from previous weeks. `;
    } else if (wiz >= 2 && ['activity','conversion','deal_size'].includes(s.zone)) {
      escalation = `Week ${wiz} in this zone. `;
    }

    // --- Layer 4: Rotating tactical tips (3 per zone, cycled by week number) ---
    const tips = {
      activity: {
        early: [
          `Try mapping out your 10am\u20132pm block the night before with a pre-built call list. Removing decision fatigue makes it easier to just start.`,
          `Consider pairing up with a teammate for a power hour \u2014 making calls alongside someone else builds momentum and accountability.`,
          `Pick your top five accounts and commit to calling each one this week. Starting small and focused builds the habit before scaling up.`
        ],
        mid: [
          `Audit your calendar from the past week. How many hours were genuinely spent on outreach versus meetings, prep, and admin? Your manager can help reclaim lost time.`,
          `Try blocking 90 minutes first thing in your prospecting window for calls only \u2014 no email, no Slack. Focused bursts often produce more than scattered effort across the day.`,
          `Ask your manager to shadow a live call session with you this week. Real-time feedback during a calling block can unlock confidence faster than reviewing recordings after the fact.`
        ],
        late: [
          `With ${WR} weeks left, every dial matters. Consider extending your calling window by 30 minutes each day this week and tracking the difference.`,
          `Focus this week on your highest-intent accounts \u2014 companies that have shown interest or engagement. The fastest path to pipeline at this stage is working warm signals.`,
          `Ask your manager to help you build a sprint plan for the remaining weeks. A clear, achievable daily target can make the gap feel manageable rather than overwhelming.`
        ]
      },
      conversion: {
        early: [
          `Review your last five calls with your manager \u2014 are you reaching the right person, and is your opening resonating? Small tweaks early in the quarter compound over time.`,
          `Think about where prospects go quiet or push back. A STRATEGIC framework walk-through with your manager can pinpoint exactly where to adjust.`,
          `Try varying your opening approach this week. Test a different hook or lead with a different value angle and see if conversion shifts.`
        ],
        mid: [
          `Consider doing a targeted call review session this week: pull three calls where you reached a decision maker but did not book. What patterns do you notice?`,
          `Your activity is solid \u2014 the opportunity is in sharpening each conversation. Try preparing two tailored talking points per prospect before dialling rather than working from a generic script.`,
          `Ask your manager or a top-performing peer to listen to a couple of your calls and give you specific feedback on your discovery questions. Fresh ears often spot things you have become blind to.`
        ],
        late: [
          `With ${WR} weeks remaining, focus your effort on the highest-probability accounts. Review your pipeline with your manager and identify where a single good conversation could unlock a deal.`,
          `Try recording yourself on your next three calls and listening back. Pay attention to pacing, questions, and whether you are giving the prospect space to talk. Self-review at this stage can surface quick wins.`,
          `Consider whether your channel mix is optimised. If phone is not converting, a well-timed LinkedIn voice note or personalised video could be the pattern interrupt that breaks through.`
        ]
      },
      deal_size: {
        early: [
          `Review the company size and employee count of your recent meetings. Are there larger accounts on your list that you have not reached yet? Discussing account prioritisation with your manager could shift the mix.`,
          `Look at where your top-performing peers are booking meetings. What company size and seniority level are they targeting? Aligning your list to a similar profile could lift average deal value.`,
          `Check the pipeline values on your recent SAOs. Are they realistic, or have you estimated conservatively? Under-forecasting is a common pattern. Ask your manager to benchmark your average deal size against the segment median and adjust where values look too low.`
        ],
        mid: [
          `You are converting at a strong rate \u2013 the lever now is which accounts you are converting. Spend 30 minutes with your manager this week reviewing your target list and identifying five larger accounts to prioritise.`,
          `Review the pipeline values you attached to your SAOs this quarter. If you have been conservative in your estimates, work with your manager or AE to re-forecast using historical close data for the segment. Accurate forecasting protects your attainment.`,
          `Consider multi-threading into your existing opportunities. If you have booked a meeting with a mid-market company, is there a larger division or parent company where the same value proposition applies at greater scale?`
        ],
        late: [
          `With ${WR} weeks left and strong SAO attainment, the fastest path to closing your pipeline gap is landing one or two larger deals. Focus your remaining effort on enterprise or upper mid-market accounts.`,
          `Audit your recent SAOs with your manager: compare the values you forecasted against what similar deals in the segment have closed at. If your estimates are consistently below the median, the gap may be a forecasting issue rather than a targeting one. Correcting this now could close a significant portion of your pipeline gap.`,
          `Consider asking your manager to connect you with an AE who works larger deals \u2013 understanding what a big opportunity looks like from the AE perspective can sharpen your targeting and qualification.`
        ]
      },
      on_track: {
        early: [
          `Keep doing what is working. Think about what has been most effective so far so you can replicate it consistently. If anything is creating friction, flag it with your manager so they can help clear the path.`,
          `You are in a strong position. Consider using some of your 1:1 time this week to discuss longer-term development goals rather than just the numbers \u2014 what skills do you want to build next?`,
          `Solid start to the quarter. Is there a peer who could use some support? Sharing your approach with a teammate benefits everyone and sharpens your own thinking.`
        ],
        mid: [
          `Strong trajectory. With ${WR} weeks remaining and ${eurShort(s.pipeGap)} to close, you are well placed. Keep the consistency going and think about what could accelerate you into Exceeding.`,
          `You are tracking well. This is a good week to review your pipeline quality with your manager \u2014 are there any deals at risk of slipping that need attention before they go cold?`,
          `Consistent performance. Think about whether there is a new skill or technique you want to test this week. When things are going well, it is the best time to experiment.`
        ],
        late: [
          `Nearly there. ${eurShort(s.pipeGap)} gap across ${WR} weeks is very achievable. Maintain your rhythm and do not change what is working.`,
          `Strong quarter. Start thinking about what you want to carry into next quarter \u2014 which accounts, which approaches, which habits. Building the bridge now saves time later.`,
          `You are within striking distance of target. Keep your focus sharp this week and avoid the temptation to ease off. Finishing strong sets the tone for next quarter.`
        ]
      },
      exceeding: {
        early: [
          `Brilliant start. Think about what has driven your success \u2014 your targeting, your messaging, your daily routine. Would you be open to sharing a quick best-practice session with the team?`,
          `Outstanding performance. Discuss stretch goals with your manager this week and whether there are development opportunities (shadowing AEs, running a team training) that match your ambition.`,
          `Exceptional quarter so far. Consider mentoring a teammate who is earlier in their journey. Teaching what you know is one of the fastest ways to solidify your own skills.`
        ],
        mid: [
          `Delivering well above target. This is a great time to have a career development conversation with your manager \u2014 what is the next step for you and what do you need to get there?`,
          `Your approach is clearly working. Think about documenting your process this week: which accounts, what sequence, what messaging. Creating a playbook of your method helps the team and gives you a tangible achievement for your development record.`,
          `Superb consistency. With your targets covered, consider using some bandwidth to experiment with a new vertical, a new persona, or a new channel. Low-risk experimentation when you are ahead builds versatility.`
        ],
        late: [
          `Exceptional quarter. Start thinking about next quarter now \u2014 what will you do differently, what will you carry forward? Discuss with your manager how this performance translates into your progression goals.`,
          `Outstanding delivery. Use the final weeks to cement your approach and document what worked. This is the evidence you need for your next career conversation.`,
          `Incredible work this quarter. Think about what stretch goal would be meaningful to you in the final ${WR} weeks. Finishing strong from an already-strong position is a real statement.`
        ]
      },
      ramping: {
        early: [
          `Focus on getting comfortable with the value proposition and your call flow. Ask your manager for a practice call or role-play session to build confidence. Check in on your onboarding milestones.`,
          `This stage is about building familiarity. Try listening to two or three calls from experienced SDRs on your team this week \u2014 notice their opening, their questions, and how they handle objections.`,
          `Do not worry about the numbers yet. Focus on making your first calls, getting comfortable with the technology, and learning the ICP. Your manager can help you set realistic daily goals for this stage.`
        ],
        mid: [
          `You are progressing through ramp. Review your onboarding checklist with your manager and identify any gaps. If you are comfortable on the phone, consider pushing for more volume this week to accelerate.`,
          `Think about which parts of the role feel natural and which feel uncertain. Bring those to your 1:1 \u2014 your manager can tailor their coaching to the areas where you will benefit most.`,
          `If you have not already, ask to shadow a top-performing SDR for an hour this week. Seeing how someone experienced structures their day and their calls can shortcut your learning curve significantly.`
        ],
        late: [
          `Getting closer to full quota. Discuss with your manager how ready you feel and what support would help you transition confidently. The skills you have built during ramp are the foundation for everything ahead.`,
          `Think about what has changed since your first week. You have built real skills \u2014 make sure you are recognising your own progress. Discuss accelerated progression with your manager if you feel ready.`,
          `The ramp period is designed to set you up for sustained success. Use these final weeks to solidify your routine, your targeting, and your pitch. The stronger your foundation, the faster you will fly at full quota.`
        ]
      }
    };

    // Select tip: rotate by week number within the phase
    function getTip(zone) {
      const pool = tips[zone] && tips[zone][phase] ? tips[zone][phase] : null;
      if (!pool || pool.length === 0) return '';
      return pool[(WN - 1) % pool.length];
    }

    // --- Assemble signal and consider ---
    let signal = '', consider = '';

    // Signal: trend opener + zone-specific data summary + pipeline maths
    if (s.zone === 'activity') {
      if (s.saos === 0 && w < 100) {
        signal = `${trend}${w} acts/wk with zero SAO. Volume is the first thing to unlock.${pipeMaths}`;
      } else if (s.saos === 0) {
        signal = `${trend}${w} acts/wk but no SAO yet. The effort is building ‚Äî now it's about making it land in the right places.${pipeMaths}`;
      } else if (s.saoPct >= 50) {
        signal = `${trend}${w} acts/wk but converting at ${pct(s.saoPct)} SAO. You're skilled at converting when you engage ‚Äî the opportunity is in more volume.${pipeMaths}`;
      } else {
        signal = `${trend}${w} acts/wk with ${pct(s.saoPct)} SAO. Building volume is the priority right now.${pipeMaths}`;
      }
    } else if (s.zone === 'conversion') {
      if (w >= 500 && s.saoPct < 25) {
        signal = `${trend}${w} acts/wk but only ${pct(s.saoPct)} SAO. Serious effort going in ‚Äî the focus is on making every conversation count.${pipeMaths}`;
      } else if (s.pipePct >= 50 && s.saoPct < 50) {
        signal = `${trend}${w} acts/wk, ${pct(s.saoPct)} SAO but ${pct(s.pipePct)} pipeline. You're landing higher-value opportunities from fewer meetings.${pipeMaths}`;
      } else {
        signal = `${trend}${w} acts/wk with ${pct(s.saoPct)} SAO. The activity is there ‚Äî the opportunity is in sharpening how conversations land.${pipeMaths}`;
      }
    } else if (s.zone === 'deal_size') {
      signal = `${trend}${pct(s.saoPct)} SAO \u2013 you are converting well. Pipeline at ${pct(s.pipePct)} because average deal value (${eur(avgDeal)}) is below target. Worth checking whether this is an account-size issue, or whether values were forecast conservatively at SAO creation.${pipeMaths}`;
    } else if (s.zone === 'on_track') {
      signal = `${trend}${pct(s.pipePct)} pipeline, ${pct(s.saoPct)} SAO. Strong trajectory.${pipeMaths}`;
    } else if (s.zone === 'exceeding') {
      signal = `${trend}${pct(s.pipePct)} pipeline, ${pct(s.saoPct)} SAO, ${w} acts/wk. Outstanding quarter.`;
    } else if (s.zone === 'ramping') {
      if (s.saos === 0 && w < 150) {
        signal = `${trend}Early ramp: ${w} acts/wk, no SAO yet. This is expected at this stage.`;
      } else if (s.saos === 0) {
        signal = `${trend}Ramping with ${w} acts/wk but no SAO yet. Activity is building well.`;
      } else {
        signal = `${trend}Ramping with ${s.saos} SAO and ${eurShort(s.pipe)} pipeline. Ahead of ramp milestones.`;
      }
    }

    // Consider: escalation + rotating tactical tip
    consider = `${escalation}${getTip(s.zone)}`;

    return { signal, consider };
  }

  // Priority order for coaching urgency
  const zonePriority = { activity: 0, conversion: 1, deal_size: 2, ramping: 3, on_track: 4, exceeding: 5 };
  const groups = [
    { zone: 'activity',   label: 'üî¥ Activity Gap',     desc: 'Building volume is the priority ‚Äî more conversations create more opportunities', color: '#dc2626' },
    { zone: 'conversion', label: '‚ö†Ô∏è Conversion Gap',    desc: 'The effort is there ‚Äî sharpening targeting and messaging will unlock results', color: '#d97706' },
    { zone: 'deal_size',  label: '‚ö†Ô∏è Deal Size Gap',     desc: 'Converting well \u2013 check whether the gap is account targeting, under-forecasted deal values, or both', color: '#d97706' },
    { zone: 'ramping',    label: 'üîµ Ramping',            desc: 'Building foundations ‚Äî confidence and familiarity come with every conversation', color: '#2563eb' },
    { zone: 'on_track',   label: '‚úÖ On Track',           desc: 'Strong trajectory ‚Äî keep the momentum going', color: '#65a30d' },
    { zone: 'exceeding',  label: 'üèÜ Exceeding',          desc: 'Outstanding performance ‚Äî your approach is making a real impact', color: '#16a34a' },
  ];

  let html = '<div class="coach-grid">';

  groups.forEach(g => {
    const sdrs = filtered.filter(s => s.zone === g.zone).sort((a, b) => (a.pipePct - b.pipePct));
    if (sdrs.length === 0) return;

    html += `<div class="coach-group-title" style="color:${g.color}"><span>${g.label} (${sdrs.length})</span><span style="font-weight:400;font-size:10px;color:#64748b;text-transform:none;letter-spacing:0"> ‚Äî ${g.desc}</span></div>`;

    sdrs.forEach(s => {
      const cd = coachData(s);
      const pillBg = zoneBg(s.zone);
      const pillColor = zoneColor(s.zone);
      const pillBorder = zoneBorder(s.zone);
      const wizLabel = s.weeksInZone > 1 ? `<span style="font-size:9px;color:#94a3b8;margin-top:2px">Week ${s.weeksInZone} in zone</span>` : '';
      html += `<div class="coach-card" style="border-left:3px solid ${g.color}">
        <div class="coach-card-name">
          <span>${s.name}</span>
          <span class="coach-zone-pill" style="background:${pillBg};color:${pillColor};border:1px solid ${pillBorder}">${zoneLabel(s.zone)}</span>
          ${wizLabel}
        </div>
        <div class="coach-card-signal"><div class="probe-label">Data signal</div>${cd.signal}</div>
        <div class="coach-card-probe"><div class="probe-label">Things to consider</div>${cd.consider}</div>
      </div>`;
    });
  });

  html += '</div>';
  box.innerHTML = html;
}

// ============================================================
// ACTIVITY ALERT
// ============================================================
function renderActivityAlert() {
  const filtered = getFiltered();
  const box = document.getElementById('activityAlertBox');
  const ACT_TGT = 500;
  const tgtCum = ACT_TGT * WE;

  // Activity zone SDRs who are below 500/wk and have some data
  const alerts = filtered.filter(s => s.zone === 'activity' && s.acts && s.acts > 0 && s.weekly < ACT_TGT);

  if (alerts.length === 0) {
    box.innerHTML = `<div style="text-align:center;padding:40px 20px;color:#64748b">
      <div style="font-size:28px;margin-bottom:8px">‚úÖ</div>
      <div style="font-size:14px;font-weight:600">No activity alerts</div>
      <div style="font-size:12px;margin-top:4px">All SDRs in view are either on-track or have a conversion/deal-size issue rather than a pure volume gap.</div>
    </div>`;
    return;
  }

  // Sort by biggest gap (lowest weekly first)
  alerts.sort((a, b) => a.weekly - b.weekly);

  let html = `<div style="margin-bottom:16px">
    <div style="font-size:14px;font-weight:700;color:#0f172a;margin-bottom:4px">üî¥ Activity Alert ‚Äî ${alerts.length} SDR${alerts.length > 1 ? 's' : ''} below required activity level</div>
    <div style="font-size:12px;color:#64748b;line-height:1.5">These SDRs are in the Activity Gap zone. Their conversion rates and deal values are workable ‚Äî the primary issue is volume.
    The table below shows what their numbers would look like at ${ACT_TGT} activities per week, and the required weekly activity to hit each target at their current rates.</div>
  </div>`;

  // Table
  html += `<div class="sdr-table-wrap"><table class="sdr-table" style="font-size:12px">
    <thead><tr>
      <th style="width:170px">SDR</th>
      <th style="width:80px;text-align:center">Acts/Wk</th>
      <th style="width:80px;text-align:center">Gap</th>
      <th style="width:100px;text-align:center">SAO Now</th>
      <th style="width:100px;text-align:center">SAO @ ${ACT_TGT}</th>
      <th style="width:110px;text-align:center">Pipeline Now</th>
      <th style="width:110px;text-align:center">Pipeline @ ${ACT_TGT}</th>
    </tr></thead><tbody>`;

  alerts.forEach(s => {
    const gap = ACT_TGT - s.weekly;
    const mult = tgtCum / s.acts;

    // Projected at 500/wk
    const adjSaos = Math.round(s.saos * mult);
    const adjPipe = Math.round(s.pipe * mult);
    const adjSaoPct = s.saoT > 0 ? Math.round(adjSaos / s.saoT * 100) : 0;
    const adjPipePct = s.pipeTarget > 0 ? Math.round(adjPipe / s.pipeTarget * 100) : 0;

    const saoNowColor = s.saoPct >= 75 ? '#16a34a' : s.saoPct >= 50 ? '#d97706' : '#dc2626';
    const adjSaoColor = adjSaoPct >= 75 ? '#16a34a' : adjSaoPct >= 50 ? '#d97706' : '#dc2626';
    const pipeNowColor = s.pipePct >= 90 ? '#16a34a' : s.pipePct >= 50 ? '#d97706' : '#dc2626';
    const adjPipeColor = adjPipePct >= 90 ? '#16a34a' : adjPipePct >= 50 ? '#d97706' : '#dc2626';

    html += `<tr>
      <td>
        <span class="sdr-name-cell">${s.name}</span>
        <div class="sdr-badges"><span class="sdr-badge sdr-badge-seg">${s.seg}</span><span class="sdr-badge ${s.type==='Ramp'?'sdr-badge-ramp':'sdr-badge-full'}">${s.type}</span><span class="sdr-badge sdr-badge-region">${s.region}</span></div>
      </td>
      <td style="text-align:center"><span style="color:#dc2626;font-weight:700">${s.weekly}</span></td>
      <td style="text-align:center"><span style="color:#dc2626;font-weight:600">${gap}</span></td>
      <td style="text-align:center"><div style="font-weight:700;color:${saoNowColor}">${pct(s.saoPct)}</div><div style="font-size:10px;color:#94a3b8">${s.saos} / ${s.saoT}</div></td>
      <td style="text-align:center"><div style="font-weight:700;color:${adjSaoColor}">${adjSaoPct}%</div><div style="font-size:10px;color:#94a3b8">${adjSaos} / ${s.saoT}</div></td>
      <td style="text-align:center"><div style="font-weight:700;color:${pipeNowColor}">${pct(s.pipePct)}</div><div style="font-size:10px;color:#94a3b8">${eurShort(s.pipe)} of ${eurShort(s.pipeTarget)}</div></td>
      <td style="text-align:center"><div style="font-weight:700;color:${adjPipeColor}">${adjPipePct}%</div><div style="font-size:10px;color:#94a3b8">${eurShort(adjPipe)} of ${eurShort(s.pipeTarget)}</div></td>
    </tr>`;
  });

  html += '</tbody></table></div>';

  // Summary insight
  const fixableByVolume = alerts.filter(s => {
    const reqSao = s.saos > 0 ? Math.round((s.saoT * s.acts) / (s.saos * WE)) : 999;
    const reqPipe = s.pipe > 0 ? Math.round((s.pipeTarget * s.acts) / (s.pipe * WE)) : 999;
    return reqSao <= 500 && reqPipe <= 500;
  });
  const totalMissedPipe = alerts.reduce((sum, s) => {
    const mult = tgtCum / s.acts;
    return sum + Math.round(s.pipe * mult) - s.pipe;
  }, 0);

  html += `<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:14px 18px;margin-top:14px">
    <div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Impact Summary</div>
    <div style="font-size:12px;color:#334155;line-height:1.7">
      ${fixableByVolume.length} of ${alerts.length} SDR${alerts.length > 1 ? 's' : ''} would hit <strong>both</strong> SAO and pipeline targets at just ${ACT_TGT} activities per week with no change to conversion or deal quality.<br>
      The activity gap across these ${alerts.length} SDRs represents approximately <strong>${eurShort(totalMissedPipe)}</strong> in missed pipeline to date ‚Äî pipeline that required no new skills, no new accounts, just more consistent daily effort.
    </div>
  </div>`;

  box.innerHTML = html;
}

// ============================================================
// TREND CHARTS
// ============================================================
let currentTrendFilter = 'GLOBAL';
let currentTrendSDR = '';

function populateTrendSDRSelect() {
  const sel = document.getElementById('trendSDRSelect');
  sel.innerHTML = '';
  if (currentTrendFilter === 'GLOBAL') {
    sel.innerHTML = '<option value="">Select Business Unit or Region first</option>';
    sel.style.color = '#94a3b8';
    currentTrendSDR = '';
    return;
  }
  // Find SDRs matching current filter
  const matches = SDRS.filter(s => {
    if (currentTrendFilter.startsWith('R_')) return s.region === currentTrendFilter.slice(2);
    return s.bu === currentTrendFilter;
  }).sort((a, b) => b.pipe - a.pipe);

  sel.style.color = '#334155';
  sel.innerHTML = '<option value="">All (team view)</option>';
  matches.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.name;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

// Compute 13-week cumulative target curve for a given filter
function computeTargetCurve(filter, metric) {
  // Determine which SDRs belong to this filter
  const sdrs = Object.entries(SDR_ROSTER).filter(([name, r]) => {
    if (filter.startsWith('SDR:')) return name === filter.slice(4);
    if (filter === 'GLOBAL') return true;
    if (filter.startsWith('R_')) { return r.region === filter.slice(2); }
    return r.bu === filter;
  }).map(([name]) => name);

  const table = metric === 'pipe' ? MONTHLY_PIPE_TARGETS : MONTHLY_SAO_TARGETS;
  const useSaoDay = metric === 'saos';

  return WEEKS_DEF.map(w => {
    const d = new Date(w.ending + 'T00:00:00');
    const month = d.getMonth(), day = d.getDate();
    const dims = [31, 28, 31], dim = dims[month];
    const useDay = useSaoDay ? Math.min(day + 2, dim) : day;

    let total = 0;
    sdrs.forEach(name => {
      const t = table[name] || { jan:0, feb:0, mar:0 };
      if (month === 0)      total += Math.round((useDay / dim) * t.jan);
      else if (month === 1) total += Math.round(t.jan + (useDay / dim) * t.feb);
      else                  total += Math.round(t.jan + t.feb + (useDay / dim) * t.mar);
    });
    return total;
  });
}

// Extract actuals from WEEK_HISTORY for a given filter
function getActualsCurve(filter, metric) {
  // SDR individual mode: use real weekly history for pipeline, linear for SAOs
  if (filter.startsWith('SDR:')) {
    const sdrName = filter.slice(4);
    const sdr = SDRS.find(s => s.name === sdrName);
    if (!sdr) return WEEK_HISTORY.map(() => 0);
    const cumVal = metric === 'pipe' ? sdr.pipe : sdr.saos;

    // Real weekly pipeline data available
    if (metric === 'pipe' && SDR_WEEK_HISTORY[sdrName]) {
      const weekly = SDR_WEEK_HISTORY[sdrName];
      const rawCum = []; let running = 0;
      for (let i = 0; i < weekly.length; i++) { running += weekly[i]; rawCum.push(running); }
      // Scale proportionally so endpoint matches authoritative SDRS cumulative
      const rawTotal = rawCum[rawCum.length - 1];
      if (rawTotal > 0) {
        const scale = cumVal / rawTotal;
        return rawCum.map(v => Math.round(v * scale));
      }
    }

    // Fallback: linear interpolation (SAOs or zero-pipe SDRs)
    const nWeeks = WEEK_HISTORY.length;
    return WEEK_HISTORY.map((_, i) => Math.round(cumVal * ((i + 1) / nWeeks)));
  }

  const bus = ['EMEA_OB','DACH_ENT_OB','DACH_CORP_OB','AMER_OB','APJ_OB','INBOUND'];
  const regionMap = {
    R_DACH: (w) => (w.DACH_ENT_OB||{})[metric] + (w.DACH_CORP_OB||{})[metric] + (w.IB_DACH||{})[metric],
    R_EMEA: (w) => (w.EMEA_OB||{})[metric] + (w.IB_EMEA||{})[metric],
    R_AMER: (w) => (w.AMER_OB||{})[metric],
    R_APJ:  (w) => (w.APJ_OB||{})[metric],
  };

  return WEEK_HISTORY.map(w => {
    if (filter === 'GLOBAL') {
      return bus.reduce((s, bu) => s + ((w[bu]||{})[metric]||0), 0);
    }
    if (regionMap[filter]) return regionMap[filter](w) || 0;
    return ((w[filter]||{})[metric]) || 0;
  });
}

// Render a single trend line chart
function renderTrendChart(canvasId, targets, actuals, isEuro, titleId, label, proj) {
  const chartLabel = isEuro ? 'Pipeline' : 'SAO';
  document.getElementById(titleId).textContent = chartLabel + ' Trend ‚Äî ' + label;

  const canvas = document.getElementById(canvasId);
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
  const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);

  const W = rect.width, H = rect.height;
  const pL = isEuro ? 80 : 50, pR = 75, pT = 20, pB = 50;
  const pW = W - pL - pR, pH = H - pT - pB;

  // maxVal must include projection endpoints so they don't clip
  let allVals = [...(targets || [0]), ...actuals];
  if (proj) allVals.push(...proj.upper, ...proj.lower, ...proj.pace, ...proj.required);
  if (proj && proj.baseline) allVals.push(...proj.baseline);
  const maxVal = Math.max(...allVals) * 1.15 || 1;
  const numWeeks = 13;
  const xStep = pW / (numWeeks - 1);

  // Grid lines
  ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 0.5;
  const gridSteps = 5;
  for (let i = 0; i <= gridSteps; i++) {
    const y = pT + pH - (i / gridSteps) * pH;
    ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(pL + pW, y); ctx.stroke();
    ctx.fillStyle = '#94a3b8'; ctx.font = "500 9px 'DM Sans'"; ctx.textAlign = 'right';
    const val = (maxVal / gridSteps) * i;
    ctx.fillText(isEuro ? '‚Ç¨' + (val >= 1000000 ? (val / 1000000).toFixed(1) + 'M' : Math.round(val / 1000) + 'k') : Math.round(val), pL - 8, y + 3);
  }

  // Month dividers
  const monthWeeks = [{ label:'January', start:0, end:3 }, { label:'February', start:4, end:7 }, { label:'March', start:8, end:12 }];
  monthWeeks.forEach(m => {
    if (m.start > 0) {
      const mx = pL + (m.start - 0.5) * xStep;
      ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1; ctx.setLineDash([4, 4]);
      ctx.beginPath(); ctx.moveTo(mx, pT); ctx.lineTo(mx, pT + pH); ctx.stroke();
      ctx.setLineDash([]);
    }
    const midX = pL + ((m.start + m.end) / 2) * xStep;
    ctx.fillStyle = '#94a3b8'; ctx.font = "600 10px 'DM Sans'"; ctx.textAlign = 'center';
    ctx.fillText(m.label, midX, pT + pH + 38);
  });

  // X axis labels (week numbers)
  for (let i = 0; i < numWeeks; i++) {
    const x = pL + i * xStep;
    ctx.fillStyle = '#94a3b8'; ctx.font = "500 9px 'DM Sans'"; ctx.textAlign = 'center';
    ctx.fillText('W' + (i + 1), x, pT + pH + 16);
  }

  // Target curve (dashed) ‚Äî only if targets provided
  if (targets) {
  ctx.strokeStyle = '#0F4C81'; ctx.lineWidth = 2; ctx.setLineDash([6, 4]); ctx.globalAlpha = 0.5;
  ctx.beginPath();
  targets.forEach((v, i) => {
    const x = pL + i * xStep, y = pT + pH - (v / maxVal) * pH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
  ctx.setLineDash([]); ctx.globalAlpha = 1;

  // Target end-point label
  const lastTarget = targets[targets.length - 1];
  const ltX = pL + (numWeeks - 1) * xStep, ltY = pT + pH - (lastTarget / maxVal) * pH;
  ctx.fillStyle = '#0F4C81'; ctx.font = "bold 9px 'DM Sans'"; ctx.textAlign = 'right';
  ctx.fillText(isEuro ? '‚Ç¨' + (lastTarget >= 1000000 ? (lastTarget / 1000000).toFixed(1) + 'M' : Math.round(lastTarget / 1000) + 'k') : lastTarget, ltX - 4, ltY - 6);
  }

  // Actuals line (solid) ‚Äî only up to weeks with data
  const hasData = actuals.filter(v => v > 0).length;
  if (hasData > 0) {
    // Fill area under actuals
    ctx.fillStyle = 'rgba(22, 163, 74, 0.06)';
    ctx.beginPath();
    ctx.moveTo(pL, pT + pH);
    actuals.forEach((v, i) => {
      if (i >= WEEK_HISTORY.length) return;
      const x = pL + i * xStep, y = pT + pH - (v / maxVal) * pH;
      ctx.lineTo(x, y);
    });
    ctx.lineTo(pL + (WEEK_HISTORY.length - 1) * xStep, pT + pH);
    ctx.closePath(); ctx.fill();

    // Line
    ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2.5;
    ctx.beginPath();
    actuals.forEach((v, i) => {
      if (i >= WEEK_HISTORY.length) return;
      const x = pL + i * xStep, y = pT + pH - (v / maxVal) * pH;
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Dots
    actuals.forEach((v, i) => {
      if (i >= WEEK_HISTORY.length) return;
      const x = pL + i * xStep, y = pT + pH - (v / maxVal) * pH;
      ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = '#16a34a'; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fill();
    });

    // Latest value label ‚Äî positioned below-left with leader line to stay clear of projections
    const lastIdx = WEEK_HISTORY.length - 1;
    const lastVal = actuals[lastIdx];
    const lx = pL + lastIdx * xStep, ly = pT + pH - (lastVal / maxVal) * pH;

    // Label anchor: offset down and left
    const labelX = lx - 60;
    const labelY = ly + 40;

    // Leader line from dot to label area
    ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 0.8; ctx.setLineDash([2, 2]);
    ctx.beginPath(); ctx.moveTo(lx, ly + 5); ctx.lineTo(labelX + 52, labelY - 12); ctx.stroke();
    ctx.setLineDash([]);

    // Value
    ctx.fillStyle = '#16a34a'; ctx.font = "bold 11px 'DM Sans'"; ctx.textAlign = 'right';
    ctx.fillText(isEuro ? '‚Ç¨' + (lastVal >= 1000000 ? (lastVal / 1000000).toFixed(1) + 'M' : Math.round(lastVal / 1000) + 'k') : lastVal, labelX + 54, labelY - 2);

    // Attainment badge
    if (targets) {
    const targetAtWeek = targets[lastIdx] || 1;
    const pct = Math.round((lastVal / targetAtWeek) * 100);
    ctx.fillStyle = pct >= 90 ? '#16a34a' : pct >= 70 ? '#d97706' : '#dc2626';
    ctx.font = "bold 9px 'DM Sans'"; ctx.textAlign = 'right';
    ctx.fillText(pct + '% of target', labelX + 54, labelY + 10);
    }
  }

  // ‚îÄ‚îÄ PROJECTION LINES (from last actual to W13) ‚îÄ‚îÄ
  if (proj && WEEK_HISTORY.length >= 2) {
    const startIdx = proj.startWeek; // 0-indexed week where projections begin
    const startX = pL + (startIdx - 1) * xStep; // last actuals point
    const startY = pT + pH - (actuals[startIdx - 1] / maxVal) * pH;

    function drawProjection(data, color, dashPattern, lineWidth) {
      ctx.strokeStyle = color; ctx.lineWidth = lineWidth; ctx.setLineDash(dashPattern); ctx.globalAlpha = 0.7;
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      data.forEach((v, i) => {
        const x = pL + (startIdx + i) * xStep;
        const y = pT + pH - (v / maxVal) * pH;
        ctx.lineTo(x, y);
      });
      ctx.stroke();
      ctx.setLineDash([]); ctx.globalAlpha = 1;
    }

    // 1. Confidence band (shaded cone between upper and lower)
    ctx.fillStyle = 'rgba(22, 163, 74, 0.07)';
    ctx.beginPath();
    ctx.moveTo(startX, startY);
    proj.upper.forEach((v, i) => {
      ctx.lineTo(pL + (startIdx + i) * xStep, pT + pH - (v / maxVal) * pH);
    });
    for (let i = proj.lower.length - 1; i >= 0; i--) {
      ctx.lineTo(pL + (startIdx + i) * xStep, pT + pH - (proj.lower[i] / maxVal) * pH);
    }
    ctx.closePath(); ctx.fill();

    // Upper/lower band edges (very subtle)
    drawProjection(proj.upper, '#16a34a', [2, 3], 0.8);
    drawProjection(proj.lower, '#16a34a', [2, 3], 0.8);

    // 2. Required to Target line (solid navy ‚Äî primary projection)
    drawProjection(proj.required, '#0F4C81', [], 2.5);

    // 3. Current Pace line (dashed green ‚Äî secondary)
    drawProjection(proj.pace, '#16a34a', [6, 4], 1.8);

    // 4. Baseline scenario line (dashed amber ‚Äî "if @ 500 acts/wk")
    if (proj.baseline) {
      drawProjection(proj.baseline, '#d97706', [4, 3], 1.5);
    }

    // Endpoint labels with de-collision
    const endX = pL + (numWeeks - 1) * xStep;
    const fmtVal = v => isEuro ? '‚Ç¨' + (v >= 1000000 ? (v/1000000).toFixed(1)+'M' : Math.round(v/1000)+'k') : Math.round(v);
    const labelPositions = [
      { y: pT + pH - (proj.required[proj.required.length-1] / maxVal) * pH, color: '#0F4C81', label: fmtVal(proj.required[proj.required.length-1]) + ' req', bold: true },
      { y: pT + pH - (proj.pace[proj.pace.length-1] / maxVal) * pH, color: '#16a34a', label: fmtVal(proj.pace[proj.pace.length-1]) + ' pace', bold: false },
    ];
    if (proj.baseline) {
      labelPositions.push({ y: pT + pH - (proj.baseline[proj.baseline.length-1] / maxVal) * pH, color: '#d97706', label: fmtVal(proj.baseline[proj.baseline.length-1]) + ' ‚â•500', bold: false });
    }
    labelPositions.sort((a, b) => a.y - b.y);

    const minGap = 14;
    for (let i = 1; i < labelPositions.length; i++) {
      if (labelPositions[i].y - labelPositions[i-1].y < minGap) {
        labelPositions[i].y = labelPositions[i-1].y + minGap;
      }
    }
    labelPositions.forEach(lp => {
      ctx.fillStyle = lp.color; ctx.font = (lp.bold ? "bold 10px" : "500 9px") + " 'DM Sans'"; ctx.textAlign = 'left';
      ctx.fillText(lp.label, endX + 6, lp.y + 3);
    });

    // Confidence band label at W13
    const bandTop = pT + pH - (proj.upper[proj.upper.length-1] / maxVal) * pH;
    const bandBot = pT + pH - (proj.lower[proj.lower.length-1] / maxVal) * pH;
    const bandMid = (bandTop + bandBot) / 2;
    ctx.fillStyle = '#94a3b8'; ctx.font = "500 8px 'DM Sans'"; ctx.textAlign = 'right';
    ctx.fillText('range', endX - 4, bandMid + 3);
  }

  // Legend
  const legY = pT - 6;
  let legendOffset = pL;
  if (targets) {
  ctx.setLineDash([6, 4]); ctx.strokeStyle = '#0F4C81'; ctx.lineWidth = 2; ctx.globalAlpha = 0.5;
  ctx.beginPath(); ctx.moveTo(legendOffset, legY); ctx.lineTo(legendOffset + 30, legY); ctx.stroke();
  ctx.setLineDash([]); ctx.globalAlpha = 1;
  ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'"; ctx.textAlign = 'left';
  ctx.fillText('Target', legendOffset + 34, legY + 3);
  legendOffset += 85;
  }

  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2.5;
  ctx.beginPath(); ctx.moveTo(legendOffset, legY); ctx.lineTo(legendOffset + 30, legY); ctx.stroke();
  ctx.fillStyle = '#16a34a'; ctx.beginPath(); ctx.arc(legendOffset + 15, legY, 3, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'";
  ctx.fillText('Actual', legendOffset + 34, legY + 3);
  legendOffset += 80;

  if (proj) {
    // Required to Target legend (solid navy ‚Äî primary)
    ctx.strokeStyle = '#0F4C81'; ctx.lineWidth = 2.5;
    ctx.beginPath(); ctx.moveTo(legendOffset, legY); ctx.lineTo(legendOffset + 25, legY); ctx.stroke();
    ctx.fillStyle = '#64748b'; ctx.font = "600 10px 'DM Sans'";
    ctx.fillText('Required Pace', legendOffset + 29, legY + 3);
    legendOffset += 120;

    // Current Pace legend (dashed green ‚Äî secondary)
    ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 1.8; ctx.setLineDash([6, 4]);
    ctx.beginPath(); ctx.moveTo(legendOffset, legY); ctx.lineTo(legendOffset + 25, legY); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'";
    ctx.fillText('Current Pace', legendOffset + 29, legY + 3);
    legendOffset += 108;

    // Confidence band legend
    ctx.fillStyle = 'rgba(22, 163, 74, 0.15)';
    ctx.fillRect(legendOffset, legY - 5, 25, 10);
    ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'";
    ctx.fillText('Range', legendOffset + 29, legY + 3);
    legendOffset += 80;

    // Baseline scenario legend
    if (proj.baseline) {
      ctx.strokeStyle = '#d97706'; ctx.lineWidth = 1.5; ctx.setLineDash([4, 3]);
      ctx.beginPath(); ctx.moveTo(legendOffset, legY); ctx.lineTo(legendOffset + 25, legY); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = '#64748b'; ctx.font = "500 10px 'DM Sans'";
      ctx.fillText('If all ‚â•500/wk', legendOffset + 29, legY + 3);
    }
  }

  // X axis line
  ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pL, pT + pH); ctx.lineTo(pL + pW, pT + pH); ctx.stroke();
}

// Filter label mapping
const TREND_LABELS = {
  GLOBAL: 'Global', EMEA_OB: 'EMEA Outbound', DACH_ENT_OB: 'DACH Enterprise Outbound',
  DACH_CORP_OB: 'DACH Corporate Outbound', AMER_OB: 'AMER Outbound', APJ_OB: 'APJ Outbound',
  INBOUND: 'Inbound', R_DACH: 'DACH (Allbound)', R_EMEA: 'EMEA (Allbound)',
  R_AMER: 'AMER (Allbound)', R_APJ: 'APJ (Allbound)'
};

// ‚îÄ‚îÄ LEADING INDICATOR PROJECTION ENGINE ‚îÄ‚îÄ
// Gathers weekly activity, SAO, and pipeline increments for any filter scope
function getWeeklyIncrements(filter) {
  const nWeeks = WEEK_HISTORY.length;

  // Find matching SDRs
  const matchSDRs = SDRS.filter(s => {
    if (filter.startsWith('SDR:')) return s.name === filter.slice(4);
    if (filter === 'GLOBAL') return true;
    if (filter.startsWith('R_')) return s.region === filter.slice(2);
    return s.bu === filter;
  });

  // Weekly activity totals from SDR_ACT_HISTORY
  const actWeekly = new Array(nWeeks).fill(0);
  matchSDRs.forEach(s => {
    const h = SDR_ACT_HISTORY[s.name];
    if (h) h.forEach((v, i) => { if (i < nWeeks) actWeekly[i] += v; });
  });

  // Baseline activity: for each SDR, use max(their recent 2-wk avg, 500)
  // This only uplifts underperformers ‚Äî top performers keep their actual pace
  let baselineActWk = 0;
  matchSDRs.forEach(s => {
    const h = SDR_ACT_HISTORY[s.name];
    if (!h) { baselineActWk += 500; return; }
    const recent = nWeeks >= 2 ? (h[nWeeks - 1] + h[nWeeks - 2]) / 2 : (h[nWeeks - 1] || 0);
    baselineActWk += Math.max(recent, 500);
  });

  // Weekly SAO increments from cumulative WEEK_HISTORY
  const saoActuals = getActualsCurve(filter, 'saos');
  const saoWeekly = saoActuals.map((v, i) => i === 0 ? v : v - saoActuals[i - 1]);

  // Weekly pipeline increments from cumulative WEEK_HISTORY
  const pipeActuals = getActualsCurve(filter, 'pipe');
  const pipeWeekly = pipeActuals.map((v, i) => i === 0 ? v : v - pipeActuals[i - 1]);

  return { actWeekly, saoWeekly, pipeWeekly, sdrCount: matchSDRs.length, baselineActWk };
}

function computeProjections(actuals, targets, metric, filter) {
  const nData = WEEK_HISTORY.length;
  if (nData < 2) return null;
  const lastVal = actuals[nData - 1];
  const totalWeeks = 13;
  const remaining = totalWeeks - nData;
  if (remaining <= 0) return null;

  const inc = getWeeklyIncrements(filter);
  const q1Target = targets ? targets[totalWeeks - 1] : 0;
  const requiredWeekly = remaining > 0 ? (q1Target - lastVal) / remaining : 0;

  let paceWeekly, upperWeekly, lowerWeekly, baselineWeekly;

  if (metric === 'saos') {
    // ‚îÄ‚îÄ SAO projection driven by ACTIVITY (1-week lead) ‚îÄ‚îÄ
    // Conversion rate: cumulative SAOs / cumulative activities
    const totalActs = inc.actWeekly.reduce((s, v) => s + v, 0);
    const totalSaos = inc.saoWeekly.reduce((s, v) => s + v, 0);
    const convRate = totalActs > 0 ? totalSaos / totalActs : 0;

    // Recent activity pace (last 2 weeks ‚Äî the leading indicator)
    const recentAct = (inc.actWeekly[nData - 1] + inc.actWeekly[nData - 2]) / 2;
    paceWeekly = recentAct * convRate;

    // Confidence band: variance in weekly conversion rates
    const weeklyConvRates = inc.actWeekly.map((a, i) => a > 0 ? inc.saoWeekly[i] / a : 0).filter(r => r > 0);
    const meanConv = weeklyConvRates.length > 0 ? weeklyConvRates.reduce((s, v) => s + v, 0) / weeklyConvRates.length : convRate;
    const convVar = weeklyConvRates.length > 1 ? weeklyConvRates.reduce((s, v) => s + (v - meanConv) ** 2, 0) / weeklyConvRates.length : 0;
    const convStd = Math.sqrt(convVar);

    upperWeekly = recentAct * (convRate + convStd * 1.2);
    lowerWeekly = Math.max(recentAct * (convRate - convStd * 0.8), 0);

    // Baseline scenario: uplift underperformers to 500 acts/wk, keep top performers
    baselineWeekly = inc.baselineActWk * convRate;

  } else {
    // ‚îÄ‚îÄ PIPELINE projection driven by SAOs (1-week lead) ‚îÄ‚îÄ
    // Avg deal size: cumulative pipeline / cumulative SAOs
    const totalSaos = inc.saoWeekly.reduce((s, v) => s + v, 0);
    const totalPipe = inc.pipeWeekly.reduce((s, v) => s + v, 0);
    const avgDeal = totalSaos > 0 ? totalPipe / totalSaos : 0;

    // Recent SAO pace (last 2 weeks ‚Äî the leading indicator)
    const recentSao = (inc.saoWeekly[nData - 1] + inc.saoWeekly[nData - 2]) / 2;
    paceWeekly = recentSao * avgDeal;

    // Confidence band: variance in weekly deal sizes
    const weeklyDeals = [];
    for (let i = 0; i < nData; i++) {
      if (inc.saoWeekly[i] > 0) weeklyDeals.push(inc.pipeWeekly[i] / inc.saoWeekly[i]);
    }
    const meanDeal = weeklyDeals.length > 0 ? weeklyDeals.reduce((s, v) => s + v, 0) / weeklyDeals.length : avgDeal;
    const dealVar = weeklyDeals.length > 1 ? weeklyDeals.reduce((s, v) => s + (v - meanDeal) ** 2, 0) / weeklyDeals.length : 0;
    const dealStd = Math.sqrt(dealVar);

    upperWeekly = recentSao * (avgDeal + dealStd * 1.0);
    lowerWeekly = Math.max(recentSao * (avgDeal - dealStd * 0.6), 0);

    // Baseline scenario: uplift underperformers to 500 acts/wk, keep top performers
    const totalActs = inc.actWeekly.reduce((s, v) => s + v, 0);
    const totalSaosAll = inc.saoWeekly.reduce((s, v) => s + v, 0);
    const convRate = totalActs > 0 ? totalSaosAll / totalActs : 0;
    const baselineSaoWk = inc.baselineActWk * convRate;
    baselineWeekly = baselineSaoWk * avgDeal;
  }

  // Build cumulative projection arrays
  const pace = [], upper = [], lower = [], required = [], baseline = [];
  for (let w = 0; w < remaining; w++) {
    const n = w + 1;
    pace.push(Math.round(lastVal + paceWeekly * n));
    upper.push(Math.round(lastVal + upperWeekly * n));
    lower.push(Math.max(Math.round(lastVal + lowerWeekly * n), Math.round(lastVal)));
    required.push(Math.round(lastVal + requiredWeekly * n));
    baseline.push(Math.round(lastVal + baselineWeekly * n));
  }

  return {
    startWeek: nData,
    pace, upper, lower, required, baseline,
    paceWeekly: Math.round(paceWeekly),
    upperWeekly: Math.round(upperWeekly),
    lowerWeekly: Math.round(lowerWeekly),
    requiredWeekly: Math.round(requiredWeekly),
    baselineWeekly: Math.round(baselineWeekly),
    q1Target: Math.round(q1Target),
    remaining
  };
}

// ‚îÄ‚îÄ Shared context builder for trend callouts ‚îÄ‚îÄ
function getTrendContext(filter) {
  const pipeTargets = computeTargetCurve(filter, 'pipe');
  const pipeActuals = getActualsCurve(filter, 'pipe');
  const saoTargets = computeTargetCurve(filter, 'saos');
  const saoActuals = getActualsCurve(filter, 'saos');
  const pipeProj = computeProjections(pipeActuals, pipeTargets, 'pipe', filter);
  const saoProj = computeProjections(saoActuals, saoTargets, 'saos', filter);
  if (!pipeProj || !saoProj) return null;

  const nData = WEEK_HISTORY.length;
  const weeksLeft = pipeProj.remaining;
  const lastPipe = pipeActuals[nData - 1];
  const lastSao = saoActuals[nData - 1];

  const pipePaceWk = pipeProj.paceWeekly;
  const saoPaceWk = saoProj.paceWeekly;
  const pipeReqWk = pipeProj.requiredWeekly;
  const saoReqWk = saoProj.requiredWeekly;
  const pipeRatio = pipePaceWk > 0 ? (pipeReqWk / pipePaceWk * 100) : 0;
  const saoRatio = saoPaceWk > 0 ? (saoReqWk / saoPaceWk * 100) : 0;
  const pipeLand = pipeProj.pace[pipeProj.pace.length - 1];
  const saoLand = saoProj.pace[saoProj.pace.length - 1];
  const pipeLandPct = pipeProj.q1Target > 0 ? Math.round(pipeLand / pipeProj.q1Target * 100) : 0;
  const saoLandPct = saoProj.q1Target > 0 ? Math.round(saoLand / saoProj.q1Target * 100) : 0;
  const pipeGap = Math.max(0, pipeProj.q1Target - lastPipe);
  const saoGap = Math.max(0, saoProj.q1Target - lastSao);

  const isSDR = filter.startsWith('SDR:');
  const isRegion = filter.startsWith('R_');
  const isGlobal = filter === 'GLOBAL';

  const scopedSDRs = SDRS.filter(s => {
    if (isSDR) return s.name === filter.slice(4);
    if (isGlobal) return true;
    if (isRegion) return s.region === filter.slice(2);
    return s.bu === filter;
  });
  const totalInScope = scopedSDRs.length;
  const rampingInScope = scopedSDRs.filter(s => s.type === 'Ramp').length;

  let hcTarget = 0;
  if (isGlobal) { hcTarget = 43; }
  else if (isRegion) {
    const regionBUs = { DACH:['DACH_ENT_OB','DACH_CORP_OB'], EMEA:['EMEA_OB'], AMER:['AMER_OB'], APJ:['APJ_OB'] };
    const rKey = filter.slice(2);
    (regionBUs[rKey]||[]).forEach(b => { hcTarget += (BU_META[b]||{}).hcTarget||0; });
    const regionCount = Object.keys(regionBUs).length;
    hcTarget += Math.round(((BU_META.INBOUND||{}).hcTarget||0) / regionCount);
  } else if (BU_META[filter]) {
    hcTarget = BU_META[filter].hcTarget || 0;
  }
  const hcGap = Math.max(0, hcTarget - scopedSDRs.filter(s => s.acts != null).length);

  // Pipeline acceleration
  const pipeIncs = [];
  for (let i = 0; i < nData; i++) pipeIncs.push(i === 0 ? pipeActuals[0] : pipeActuals[i] - pipeActuals[i-1]);
  const early3 = pipeIncs.slice(0, Math.min(3, nData));
  const recent3 = pipeIncs.slice(-Math.min(3, nData));
  const earlyAvg = early3.reduce((s,v) => s+v, 0) / early3.length;
  const recentAvg = recent3.reduce((s,v) => s+v, 0) / recent3.length;
  const pipeAccelPct = earlyAvg > 0 ? Math.round((recentAvg / earlyAvg) * 100) : 100;

  // SAO acceleration
  const saoIncs = [];
  for (let i = 0; i < nData; i++) saoIncs.push(i === 0 ? saoActuals[0] : saoActuals[i] - saoActuals[i-1]);
  const saoEarly3 = saoIncs.slice(0, Math.min(3, nData));
  const saoRecent3 = saoIncs.slice(-Math.min(3, nData));
  const saoEarlyAvg = saoEarly3.reduce((s,v) => s+v, 0) / saoEarly3.length;
  const saoRecentAvg = saoRecent3.reduce((s,v) => s+v, 0) / saoRecent3.length;
  const saoAccelPct = saoEarlyAvg > 0 ? Math.round((saoRecentAvg / saoEarlyAvg) * 100) : 100;

  // Average deal size and required deal size
  const avgDeal = lastSao > 0 ? Math.round(lastPipe / lastSao) : 0;
  const reqDeal = saoProj.q1Target > 0 ? Math.round(pipeProj.q1Target / saoProj.q1Target) : 0;
  const dealDeltaPct = reqDeal > 0 ? Math.round(avgDeal / reqDeal * 100) : 0;

  return { pipeProj, saoProj, weeksLeft, nData, pipePaceWk, saoPaceWk, pipeReqWk, saoReqWk,
    pipeRatio, saoRatio, pipeLand, saoLand, pipeLandPct, saoLandPct, pipeGap, saoGap,
    isSDR, isRegion, isGlobal, scopedSDRs, totalInScope, rampingInScope, hcTarget, hcGap,
    pipeAccelPct, saoAccelPct, avgDeal, reqDeal, dealDeltaPct };
}

// ‚îÄ‚îÄ Pipeline callout: 6 KPI cards + full-width outlook ‚îÄ‚îÄ
function renderPipeCallout(filter) {
  const box = document.getElementById('trendPipeCallout');
  const c = getTrendContext(filter);
  if (!c) { box.innerHTML = ''; return; }

  const onPace = c.pipeLandPct >= 95;
  const atRisk = !onPace && c.pipeLandPct >= 75;
  const landClass = c.pipeLandPct >= 95 ? 'green' : c.pipeLandPct >= 75 ? 'amber' : 'red';
  const accelClass = c.pipeAccelPct >= 115 ? 'green' : c.pipeAccelPct >= 90 ? 'amber' : 'red';
  const accelLabel = c.pipeAccelPct >= 115 ? 'Accelerating' : c.pipeAccelPct >= 90 ? 'Steady' : 'Slowing';

  // Outlook lines
  const lines = [];
  if (c.isSDR) {
    const sdr = c.scopedSDRs[0];
    if (sdr) {
      if (sdr.type === 'Ramp') {
        lines.push('This SDR is on a ramp quota. Pipeline projections reflect reduced targets, not full run-rate capacity.');
        if (onPace) lines.push('On track against ramp milestones. Pipeline output will step up as quota increases.');
        else lines.push('Ramp trajectory is building. Assess pipeline against ramp milestones, not full-quota peers.');
      } else {
        if (onPace) lines.push('On pace to hit or exceed pipeline target at current trajectory.');
        else if (atRisk) lines.push('Pipeline is within range but trending below target. A sustained uplift in deal size or activity volume would close the gap.');
        else if (c.pipeRatio <= 130) lines.push('Within striking distance of pipeline target. A modest increase in deal size or volume closes the gap.');
        else lines.push('A pipeline gap exists at current pace. Focus coaching on deal-value accuracy and prospecting into higher-value accounts.');
      }
    }
  } else {
    if (onPace) lines.push('Current pace projects to meet or exceed pipeline target without further changes.');
    else if (atRisk) lines.push('Pipeline is within range but the leading indicators suggest risk. The projection assumes no changes to the current team.');
    else lines.push('The projection range assumes no changes to the current team. It is a baseline, not a forecast.');
    // Headcount context in outlook
    if (c.hcGap > 0) lines.push(c.hcGap + ' additional hire' + (c.hcGap > 1 ? 's' : '') + ' planned against ' + c.hcTarget + ' target headcount (' + (c.totalInScope) + ' active today). Each new SDR adds incremental pipeline capacity as they ramp into production.');
    if (c.rampingInScope > 0) lines.push(c.rampingInScope + ' of ' + c.totalInScope + ' SDR' + (c.totalInScope > 1 ? 's' : '') + ' currently on ramp quotas. As they reach full quota, pipeline output will step up beyond the current pace line.');
    if (!onPace) {
      lines.push('Required pace is ' + Math.round(c.pipeRatio) + '% of current output. Closing the gap depends on deal-value accuracy, prospecting into higher-value segments, and new hires ramping in.');
    }
  }

  const bgColor = onPace ? '#f0fdf4' : '#fffbeb';
  const bdColor = onPace ? '#bbf7d0' : '#fde68a';
  const icon = onPace ? '‚úÖ ' : '‚ö†Ô∏è ';

  box.innerHTML = `
    <div class="kpi-row" style="grid-template-columns:repeat(6,1fr);margin-bottom:10px">
      <div class="kpi blue">
        <div class="kpi-label">Required / Wk</div>
        <div class="kpi-value" style="font-size:22px">‚Ç¨${c.pipeReqWk >= 1000000 ? (c.pipeReqWk/1000000).toFixed(1)+'M' : Math.round(c.pipeReqWk/1000)+'k'}</div>
        <div class="kpi-target">to hit ‚Ç¨${c.pipeProj.q1Target >= 1000000 ? (c.pipeProj.q1Target/1000000).toFixed(1)+'M' : Math.round(c.pipeProj.q1Target/1000)+'k'} in ${c.weeksLeft} wks</div>
      </div>
      <div class="kpi green">
        <div class="kpi-label">Current Pace</div>
        <div class="kpi-value" style="font-size:22px">‚Ç¨${c.pipePaceWk >= 1000000 ? (c.pipePaceWk/1000000).toFixed(1)+'M' : Math.round(c.pipePaceWk/1000)+'k'}</div>
        <div class="kpi-target">per week average</div>
        <div class="kpi-delta flat" style="font-size:10px">‚Ç¨${Math.round(c.pipeProj.lowerWeekly/1000)}k‚Äì‚Ç¨${Math.round(c.pipeProj.upperWeekly/1000)}k range</div>
      </div>
      <div class="kpi ${c.pipeGap === 0 ? 'green' : 'amber'}">
        <div class="kpi-label">Gap</div>
        <div class="kpi-value" style="font-size:22px">‚Ç¨${c.pipeGap >= 1000000 ? (c.pipeGap/1000000).toFixed(1)+'M' : Math.round(c.pipeGap/1000)+'k'}</div>
        <div class="kpi-target">remaining to Q1 target</div>
      </div>
      <div class="kpi ${landClass}">
        <div class="kpi-label">Forecast Landing</div>
        <div class="kpi-value" style="font-size:22px">‚Ç¨${c.pipeLand >= 1000000 ? (c.pipeLand/1000000).toFixed(1)+'M' : Math.round(c.pipeLand/1000)+'k'}</div>
        <div class="kpi-target">at current pace</div>
        <div class="kpi-delta ${landClass === 'green' ? 'up' : landClass === 'amber' ? 'amber' : 'down'}" style="font-size:10px">${c.pipeLandPct}% of target</div>
      </div>
      <div class="kpi ${c.dealDeltaPct >= 100 ? 'green' : c.dealDeltaPct >= 80 ? 'amber' : 'red'}">
        <div class="kpi-label">Avg Deal Size</div>
        <div class="kpi-value" style="font-size:22px">${c.avgDeal > 0 ? '‚Ç¨' + c.avgDeal.toLocaleString() : '‚Äî'}</div>
        <div class="kpi-target">${c.reqDeal > 0 ? 'vs ‚Ç¨' + c.reqDeal.toLocaleString() + ' required' : 'pipeline √∑ SAOs'}</div>
        ${c.reqDeal > 0 ? `<div class="kpi-delta ${c.dealDeltaPct >= 100 ? 'up' : c.dealDeltaPct >= 80 ? 'amber' : 'down'}" style="font-size:10px">${c.dealDeltaPct}% of target</div>` : ''}
      </div>
      <div class="kpi ${accelClass}">
        <div class="kpi-label">Acceleration</div>
        <div class="kpi-value" style="font-size:22px">${c.nData >= 4 ? c.pipeAccelPct + '%' : '‚Äî'}</div>
        <div class="kpi-target">${c.nData >= 4 ? accelLabel : 'Need 4+ weeks'}</div>
        <div class="kpi-delta ${accelClass === 'green' ? 'up' : accelClass === 'red' ? 'down' : 'flat'}" style="font-size:10px">${c.nData >= 4 ? 'recent vs early qtr' : ''}</div>
      </div>
    </div>
    <div style="background:${bgColor};border:1px solid ${bdColor};border-radius:10px;padding:14px 18px">
      <div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">${icon}Pipeline Outlook</div>
      <div style="font-size:12px;color:#334155;line-height:1.6">${lines.join('<br style="margin-bottom:4px">')}</div>
    </div>`;
}

// ‚îÄ‚îÄ SAO callout: 6 KPI cards + full-width outlook ‚îÄ‚îÄ
function renderSaoCallout(filter) {
  const box = document.getElementById('trendSaoCallout');
  const c = getTrendContext(filter);
  if (!c) { box.innerHTML = ''; return; }

  const onPace = c.saoLandPct >= 95;
  const atRisk = !onPace && c.saoLandPct >= 75;
  const landClass = c.saoLandPct >= 95 ? 'green' : c.saoLandPct >= 75 ? 'amber' : 'red';
  const accelClass = c.saoAccelPct >= 115 ? 'green' : c.saoAccelPct >= 90 ? 'amber' : 'red';
  const accelLabel = c.saoAccelPct >= 115 ? 'Accelerating' : c.saoAccelPct >= 90 ? 'Steady' : 'Slowing';

  // Efficiency: acts per SAO (lower is better)
  const nData = c.nData;
  const scopedActs = c.scopedSDRs.reduce((s, d) => s + (d.acts || 0), 0);
  const scopedSaos = c.scopedSDRs.reduce((s, d) => s + (d.saos || 0), 0);
  const efficiency = scopedSaos > 0 ? Math.round(scopedActs / scopedSaos) : 0;
  const effClass = efficiency > 0 && efficiency <= 250 ? 'green' : efficiency <= 400 ? 'amber' : 'red';

  // Outlook lines
  const lines = [];
  if (c.isSDR) {
    const sdr = c.scopedSDRs[0];
    if (sdr) {
      if (sdr.type === 'Ramp') {
        lines.push('This SDR is on a ramp quota. SAO projections reflect reduced targets, not full run-rate expectations.');
        if (onPace) lines.push('On track against ramp milestones. SAO volume will increase as quota steps up.');
        else lines.push('Ramp trajectory is building. Assess SAO output against ramp milestones, not full-quota peers.');
      } else {
        if (onPace) lines.push('On pace to hit or exceed SAO target at current trajectory.');
        else if (atRisk) lines.push('SAO volume is within range but trending below target. A sustained uplift in activity or conversion rate would close the gap.');
        else if (c.saoRatio <= 130) lines.push('Within striking distance of SAO target. A modest increase in activity or conversion rate closes the gap.');
        else lines.push('An SAO gap exists at current pace. Focus coaching on activity levels and meeting-to-opportunity conversion.');
      }
    }
  } else {
    if (onPace) lines.push('Current pace projects to meet or exceed SAO target without further changes.');
    else if (atRisk) lines.push('SAO volume is within range but the leading indicators suggest risk. The projection assumes no changes to the current team.');
    else lines.push('The projection range assumes no changes to the current team. It is a baseline, not a forecast.');
    // Headcount context in outlook
    if (c.hcGap > 0) lines.push(c.hcGap + ' additional hire' + (c.hcGap > 1 ? 's' : '') + ' planned against ' + c.hcTarget + ' target headcount (' + (c.totalInScope) + ' active today). Each new SDR adds incremental SAO capacity as they ramp into production.');
    if (c.rampingInScope > 0) lines.push(c.rampingInScope + ' of ' + c.totalInScope + ' SDR' + (c.totalInScope > 1 ? 's' : '') + ' currently on ramp quotas. As they reach full quota, weekly SAO output will step up beyond the current pace line.');
    if (!onPace) {
      lines.push('Required pace is ' + Math.round(c.saoRatio) + '% of current output. Closing the SAO gap depends on increasing activity levels, improving meeting-to-opportunity conversion, and new hires ramping into production.');
    }
  }

  const bgColor = onPace ? '#f0fdf4' : '#fffbeb';
  const bdColor = onPace ? '#bbf7d0' : '#fde68a';
  const icon = onPace ? '‚úÖ ' : '‚ö†Ô∏è ';

  box.innerHTML = `
    <div class="kpi-row" style="grid-template-columns:repeat(6,1fr);margin-bottom:10px">
      <div class="kpi blue">
        <div class="kpi-label">Required / Wk</div>
        <div class="kpi-value" style="font-size:22px">${c.saoReqWk}</div>
        <div class="kpi-target">to hit ${c.saoProj.q1Target} in ${c.weeksLeft} wks</div>
      </div>
      <div class="kpi green">
        <div class="kpi-label">Current Pace</div>
        <div class="kpi-value" style="font-size:22px">${c.saoPaceWk}</div>
        <div class="kpi-target">per week average</div>
        <div class="kpi-delta flat" style="font-size:10px">${c.saoProj.lowerWeekly}‚Äì${c.saoProj.upperWeekly} range</div>
      </div>
      <div class="kpi ${c.saoGap === 0 ? 'green' : 'amber'}">
        <div class="kpi-label">Gap</div>
        <div class="kpi-value" style="font-size:22px">${c.saoGap}</div>
        <div class="kpi-target">remaining to Q1 target</div>
      </div>
      <div class="kpi ${landClass}">
        <div class="kpi-label">Forecast Landing</div>
        <div class="kpi-value" style="font-size:22px">${c.saoLand}</div>
        <div class="kpi-target">at current pace</div>
        <div class="kpi-delta ${landClass === 'green' ? 'up' : landClass === 'amber' ? 'amber' : 'down'}" style="font-size:10px">${c.saoLandPct}% of target</div>
      </div>
      <div class="kpi ${effClass}">
        <div class="kpi-label">Efficiency</div>
        <div class="kpi-value" style="font-size:22px">${efficiency > 0 ? efficiency : '‚Äî'}</div>
        <div class="kpi-target">${efficiency > 0 ? 'activities per SAO' : 'no SAOs yet'}</div>
        <div class="kpi-delta ${effClass === 'green' ? 'up' : effClass === 'red' ? 'down' : 'amber'}" style="font-size:10px">${efficiency > 0 ? (efficiency <= 250 ? 'Strong conversion' : efficiency <= 400 ? 'Average conversion' : 'Review conversion') : ''}</div>
      </div>
      <div class="kpi ${accelClass}">
        <div class="kpi-label">Acceleration</div>
        <div class="kpi-value" style="font-size:22px">${nData >= 4 ? c.saoAccelPct + '%' : '‚Äî'}</div>
        <div class="kpi-target">${nData >= 4 ? accelLabel : 'Need 4+ weeks'}</div>
        <div class="kpi-delta ${accelClass === 'green' ? 'up' : accelClass === 'red' ? 'down' : 'flat'}" style="font-size:10px">${nData >= 4 ? 'recent vs early qtr' : ''}</div>
      </div>
    </div>
    <div style="background:${bgColor};border:1px solid ${bdColor};border-radius:10px;padding:14px 18px">
      <div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">${icon}SAO Outlook</div>
      <div style="font-size:12px;color:#334155;line-height:1.6">${lines.join('<br style="margin-bottom:4px">')}</div>
    </div>`;
}

let currentTrendSubTab = 'pipe';

function renderTrends() {
  const f = currentTrendSDR ? 'SDR:' + currentTrendSDR : currentTrendFilter;
  const label = currentTrendSDR ? currentTrendSDR : (TREND_LABELS[f] || f);
  const pipeTargets = computeTargetCurve(f, 'pipe');
  const pipeActuals = getActualsCurve(f, 'pipe');
  const saoTargets = computeTargetCurve(f, 'saos');
  const saoActuals = getActualsCurve(f, 'saos');
  const pipeProj = computeProjections(pipeActuals, pipeTargets, 'pipe', f);
  const saoProj = computeProjections(saoActuals, saoTargets, 'saos', f);

  // Always render both callouts and charts so they are ready when sub-tab switches
  renderPipeCallout(f);
  renderSaoCallout(f);
  renderTrendChart('trendPipeCanvas', pipeTargets, pipeActuals, true, 'trendPipeTitle', label, pipeProj);
  renderTrendChart('trendSaoCanvas', saoTargets, saoActuals, false, 'trendSaoTitle', label, saoProj);
}

// ‚îÄ‚îÄ WEEKLY STACKED BAR CHARTS ‚îÄ‚îÄ
const SDR_COLORS = [
  '#0F4C81','#2563eb','#F18F01','#7B2D8E','#C73E1D','#16a34a',
  '#d97706','#dc2626','#0891b2','#6366f1','#84cc16','#f43f5e',
  '#8b5cf6','#14b8a6','#ea580c','#475569','#a855f7','#06b6d4',
  '#e11d48','#65a30d','#9333ea','#0d9488','#b91c1c','#1d4ed8',
  '#ca8a04','#be185d','#059669','#7c3aed','#db2777','#4f46e5'
];

function getWeeklyData(filter, metric) {
  // metric: 'pipe', 'sao', 'act'
  const histMap = { pipe: SDR_WEEK_HISTORY, sao: SDR_SAO_HISTORY, act: SDR_ACT_HISTORY };
  const hist = histMap[metric];
  const nWeeks = WEEK_HISTORY.length;

  // Determine which SDRs match the filter
  const matchSDRs = SDRS.filter(s => {
    if (filter === 'GLOBAL') return true;
    if (filter.startsWith('R_')) return s.region === filter.slice(2);
    if (filter.startsWith('SDR:')) return s.name === filter.slice(4);
    return s.bu === filter;
  });

  // Decide grouping: by BU for Global/Region, by SDR for BU/individual
  const isBULevel = filter === 'GLOBAL' || filter.startsWith('R_');
  const groups = {};

  if (isBULevel) {
    // Group SDRs by BU
    matchSDRs.forEach(s => {
      if (!groups[s.bu]) groups[s.bu] = { label: BU_META[s.bu] ? BU_META[s.bu].label.replace(' Outbound','') : s.bu, color: BU_META[s.bu] ? BU_META[s.bu].color : '#94a3b8', weeks: new Array(nWeeks).fill(0) };
      const h = hist[s.name];
      if (h) h.forEach((v, i) => { if (i < nWeeks) groups[s.bu].weeks[i] += v; });
    });
  } else {
    // Group by SDR
    let ci = 0;
    matchSDRs.forEach(s => {
      const h = hist[s.name];
      if (h) {
        groups[s.name] = { label: s.name.split(' ')[0], color: SDR_COLORS[ci % SDR_COLORS.length], weeks: [...h].slice(0, nWeeks) };
        ci++;
      }
    });
  }

  return groups;
}

function renderWeeklyBarChart(canvasId, titleId, legendId, metric, label) {
  const f = currentTrendSDR ? 'SDR:' + currentTrendSDR : currentTrendFilter;
  const isEuro = metric === 'pipe';
  const metricLabel = { pipe: 'Pipeline Weekly', sao: 'SAO Weekly', act: 'Activity Weekly' }[metric];
  document.getElementById(titleId).textContent = metricLabel + ' ‚Äî ' + (currentTrendSDR || label);

  const groups = getWeeklyData(f, metric);
  const keys = Object.keys(groups);
  const nWeeks = WEEK_HISTORY.length;

  // Compute totals per week for max
  const weekTotals = new Array(nWeeks).fill(0);
  keys.forEach(k => groups[k].weeks.forEach((v, i) => weekTotals[i] += v));
  const maxVal = Math.max(...weekTotals) * 1.15 || 1;

  const canvas = document.getElementById(canvasId);
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
  const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);

  const W = rect.width, H = rect.height;
  const pL = isEuro ? 80 : 50, pR = 30, pT = 20, pB = 40;
  const pW = W - pL - pR, pH = H - pT - pB;

  // Clear
  ctx.clearRect(0, 0, W, H);

  // Grid
  ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 0.5;
  const gridSteps = 5;
  for (let i = 0; i <= gridSteps; i++) {
    const y = pT + pH - (i / gridSteps) * pH;
    ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(pL + pW, y); ctx.stroke();
    ctx.fillStyle = '#94a3b8'; ctx.font = "500 9px 'DM Sans'"; ctx.textAlign = 'right';
    const val = (maxVal / gridSteps) * i;
    ctx.fillText(isEuro ? '‚Ç¨' + (val >= 1000000 ? (val / 1000000).toFixed(1) + 'M' : val >= 1000 ? Math.round(val / 1000) + 'k' : Math.round(val)) : Math.round(val).toLocaleString(), pL - 8, y + 3);
  }

  // Bars
  const barGroupW = pW / nWeeks;
  const barW = barGroupW * 0.65;
  const gap = (barGroupW - barW) / 2;

  for (let w = 0; w < nWeeks; w++) {
    let yBase = pT + pH;
    const x = pL + w * barGroupW + gap;

    // Pre-compute segments to identify topmost
    const segs = [];
    keys.forEach(k => {
      const val = groups[k].weeks[w] || 0;
      if (val > 0) segs.push({ val, color: groups[k].color });
    });

    segs.forEach((seg, idx) => {
      const barH = (seg.val / maxVal) * pH;
      const y = yBase - barH;
      ctx.fillStyle = seg.color;
      ctx.globalAlpha = 0.85;
      ctx.beginPath();
      if (idx === segs.length - 1) {
        // Top segment ‚Äî rounded top corners
        const r = Math.min(3, barH / 2);
        ctx.moveTo(x, yBase);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.lineTo(x + barW - r, y);
        ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
        ctx.lineTo(x + barW, yBase);
      } else {
        ctx.rect(x, y, barW, barH);
      }
      ctx.fill();
      ctx.globalAlpha = 1;
      yBase = y;
    });

    // Week total on top
    const total = weekTotals[w];
    if (total > 0) {
      ctx.fillStyle = '#334155'; ctx.font = "bold 9px 'DM Sans'"; ctx.textAlign = 'center';
      const totalY = pT + pH - (total / maxVal) * pH;
      ctx.fillText(isEuro ? (total >= 1000000 ? '‚Ç¨' + (total / 1000000).toFixed(1) + 'M' : '‚Ç¨' + Math.round(total / 1000) + 'k') : total.toLocaleString(), x + barW / 2, totalY - 6);
    }

    // X label
    ctx.fillStyle = '#94a3b8'; ctx.font = "500 10px 'DM Sans'"; ctx.textAlign = 'center';
    ctx.fillText('W' + (w + 1), pL + w * barGroupW + barGroupW / 2, pT + pH + 18);
  }

  // Baseline (zero line)
  ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pL, pT + pH); ctx.lineTo(pL + pW, pT + pH); ctx.stroke();

  // Legend
  const leg = document.getElementById(legendId);
  leg.innerHTML = keys.map(k =>
    `<div style="display:flex;align-items:center;gap:4px;font-size:11px;color:#334155">
      <span style="width:10px;height:10px;border-radius:2px;background:${groups[k].color};display:inline-block;flex-shrink:0"></span>
      ${groups[k].label}
    </div>`
  ).join('');
}

function renderWeeklyCharts() {
  const label = currentTrendSDR ? currentTrendSDR : (TREND_LABELS[currentTrendFilter] || currentTrendFilter);
  if (currentTrendSubTab === 'pipeWeekly') renderWeeklyBarChart('weeklyPipeCanvas', 'weeklyPipeTitle', 'weeklyPipeLegend', 'pipe', label);
  if (currentTrendSubTab === 'saoWeekly') renderWeeklyBarChart('weeklySaoCanvas', 'weeklySaoTitle', 'weeklySaoLegend', 'sao', label);
  if (currentTrendSubTab === 'actWeekly') renderWeeklyBarChart('weeklyActCanvas', 'weeklyActTitle', 'weeklyActLegend', 'act', label);
}

// Sub-tab switching
document.getElementById('trendSubTabs').addEventListener('click', e => {
  const btn = e.target.closest('.trend-sub-tab');
  if (!btn || !btn.dataset.tsub) return;
  currentTrendSubTab = btn.dataset.tsub;

  document.querySelectorAll('.trend-sub-tab').forEach(b => {
    b.style.color = '#94a3b8'; b.style.fontWeight = '600'; b.style.borderBottomColor = 'transparent';
    b.classList.remove('active');
  });
  btn.style.color = '#0F4C81'; btn.style.fontWeight = '700'; btn.style.borderBottomColor = '#0F4C81';
  btn.classList.add('active');

  document.getElementById('trendSubPipe').style.display = currentTrendSubTab === 'pipe' ? '' : 'none';
  document.getElementById('trendSubSao').style.display = currentTrendSubTab === 'sao' ? '' : 'none';
  document.getElementById('trendSubPipeWeekly').style.display = currentTrendSubTab === 'pipeWeekly' ? '' : 'none';
  document.getElementById('trendSubSaoWeekly').style.display = currentTrendSubTab === 'saoWeekly' ? '' : 'none';
  document.getElementById('trendSubActWeekly').style.display = currentTrendSubTab === 'actWeekly' ? '' : 'none';

  // Re-render the active chart (canvas may need redraw after display:none toggle)
  renderTrends();
  if (['pipeWeekly','saoWeekly','actWeekly'].includes(currentTrendSubTab)) renderWeeklyCharts();
});

// Trend filter handler
document.getElementById('trendFilterBar').addEventListener('click', e => {
  const btn = e.target.closest('.filter-btn'); if (!btn || !btn.dataset.tf) return;
  document.querySelectorAll('#trendFilterBar .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentTrendFilter = btn.dataset.tf;
  currentTrendSDR = '';
  populateTrendSDRSelect();
  renderTrends();
  if (['pipeWeekly','saoWeekly','actWeekly'].includes(currentTrendSubTab)) renderWeeklyCharts();
});

document.getElementById('trendSDRSelect').addEventListener('change', e => {
  currentTrendSDR = e.target.value;
  renderTrends();
  if (['pipeWeekly','saoWeekly','actWeekly'].includes(currentTrendSubTab)) renderWeeklyCharts();
});

// ============================================================
// FILTERS
// ============================================================
document.getElementById('filterBar').addEventListener('click', e => {
  const btn = e.target.closest('.filter-btn'); if (!btn) return;
  document.querySelectorAll('#filterBar .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (btn.dataset.bu) { currentBU = btn.dataset.bu; currentRegion = null; }
  if (btn.dataset.region) { currentBU = null; currentRegion = btn.dataset.region; }
  currentSDR = null;
  populateIndivSDRSelect();
  renderTable();
  renderAnalysis();
  renderCoaching();
  renderActivityAlert();
});
document.getElementById('indivSDRSelect').addEventListener('change', e => {
  currentSDR = e.target.value || null;
  renderTable();
  renderAnalysis();
  renderCoaching();
  renderActivityAlert();
});

// Individual Performance sub-tab switching
let currentIndivSubTab = 'summary';
document.getElementById('indivSubTabs').addEventListener('click', e => {
  const btn = e.target.closest('.indiv-sub-tab');
  if (!btn || !btn.dataset.isub) return;
  currentIndivSubTab = btn.dataset.isub;

  document.querySelectorAll('.indiv-sub-tab').forEach(b => {
    b.style.color = '#94a3b8'; b.style.fontWeight = '600'; b.style.borderBottomColor = 'transparent';
    b.classList.remove('active');
  });
  btn.style.color = '#0F4C81'; btn.style.fontWeight = '700'; btn.style.borderBottomColor = '#0F4C81';
  btn.classList.add('active');

  document.getElementById('indivSubSummary').style.display = currentIndivSubTab === 'summary' ? '' : 'none';
  document.getElementById('indivSubAnalysis').style.display = currentIndivSubTab === 'analysis' ? '' : 'none';
  document.getElementById('indivSubCoaching').style.display = currentIndivSubTab === 'coaching' ? '' : 'none';
  document.getElementById('indivSubActivityAlert').style.display = currentIndivSubTab === 'activity-alert' ? '' : 'none';

  // Re-render active content
  if (currentIndivSubTab === 'summary') renderTable();
  else if (currentIndivSubTab === 'analysis') renderAnalysis();
  else if (currentIndivSubTab === 'coaching') renderCoaching();
  else if (currentIndivSubTab === 'activity-alert') renderActivityAlert();
});
document.getElementById('distFilterBar').addEventListener('click', e => {
  const btn = e.target.closest('.filter-btn'); if (!btn) return;
  document.querySelectorAll('#distFilterBar .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (btn.dataset.dbu) { distBU = btn.dataset.dbu; distRegion = null; }
  if (btn.dataset.dregion) { distBU = null; distRegion = btn.dataset.dregion; }
  renderBell(); renderSaoDist(); renderPipeDist();
});

// Distribution sub-tab switching
let currentDistSubTab = 'activity';
document.getElementById('distSubTabs').addEventListener('click', e => {
  const btn = e.target.closest('.dist-sub-tab');
  if (!btn || !btn.dataset.dsub) return;
  currentDistSubTab = btn.dataset.dsub;

  document.querySelectorAll('.dist-sub-tab').forEach(b => {
    b.style.color = '#94a3b8'; b.style.fontWeight = '600'; b.style.borderBottomColor = 'transparent';
    b.classList.remove('active');
  });
  btn.style.color = '#0F4C81'; btn.style.fontWeight = '700'; btn.style.borderBottomColor = '#0F4C81';
  btn.classList.add('active');

  document.getElementById('distSubActivity').style.display = currentDistSubTab === 'activity' ? '' : 'none';
  document.getElementById('distSubSao').style.display = currentDistSubTab === 'sao' ? '' : 'none';
  document.getElementById('distSubPipeline').style.display = currentDistSubTab === 'pipeline' ? '' : 'none';

  // Re-render active chart after display toggle
  if (currentDistSubTab === 'activity') renderBell();
  else if (currentDistSubTab === 'sao') renderSaoDist();
  else if (currentDistSubTab === 'pipeline') renderPipeDist();
});

// ============================================================
// RENDER ALL
// ============================================================
// Tab navigation
document.querySelector('.tab-bar').addEventListener('click', e => {
  const btn = e.target.closest('.tab-btn'); if (!btn) return;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
  // Re-render charts when switching tabs (hidden canvases need redraw)
  if (btn.dataset.tab === 'distributions') { renderBell(); renderSaoDist(); renderPipeDist(); }
  if (btn.dataset.tab === 'trends') { renderTrends(); }
});

function renderAll() {
  // Dynamic header and footer from WEEK object
  const endDate = new Date(WEEK.ending + 'T00:00:00');
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const shortMonths = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const longDate = `${endDate.getDate()} ${monthNames[endDate.getMonth()]} ${endDate.getFullYear()}`;
  const shortDate = `${endDate.getDate()} ${shortMonths[endDate.getMonth()]} ${endDate.getFullYear()}`;
  const pctElapsed = Math.round(WEEK.weeksElapsed / WEEK.totalWeeks * 100);
  document.getElementById('metaWeekLabel').innerHTML = `<strong>Q1 FY26</strong> ¬∑ Week ${WEEK.number} ending ${longDate}`;
  document.getElementById('metaWeeksElapsed').textContent = `${WEEK.weeksElapsed} of ${WEEK.totalWeeks} weeks elapsed (${pctElapsed}%)`;
  document.getElementById('footerDataLine').textContent = `Prepared by SDR Leadership ¬∑ Source: Salesloft + Salesforce + FY26 Comp Plan ¬∑ Data as of ${shortDate}`;

  renderGlobalKPIs();
  renderWoW();
  renderHighlights();
  renderMgrFocus();
  renderBU();
  renderRegions();
  renderZones();
  renderTable();
  renderAnalysis();
  renderCoaching();
  renderActivityAlert();
}
renderAll();
window.addEventListener('resize', () => {
  if (document.getElementById('tab-distributions').classList.contains('active')) { renderBell(); renderSaoDist(); renderPipeDist(); }
  if (document.getElementById('tab-trends').classList.contains('active')) { renderTrends(); if (['pipeWeekly','saoWeekly','actWeekly'].includes(currentTrendSubTab)) renderWeeklyCharts(); }
});
</script>
</body>
</html>
